<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Debug - Apotek Alpro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', sans-serif;
        }
        .debug-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        .log-entry {
            background: #f9fafb;
            border-left: 4px solid #4f46e5;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.375rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .log-entry.success { border-left-color: #10b981; }
        .log-entry.error { border-left-color: #ef4444; }
        .log-entry.warning { border-left-color: #f59e0b; }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
        }
    </style>
</head>
<body>
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="debug-container w-full max-w-4xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Login Debug Tool</h1>
                <p class="text-gray-600">Apotek Alpro Dashboard - Troubleshooting</p>
            </div>

            <!-- Login Form -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Test Login</h2>
                    <form id="debugLoginForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email / Username</label>
                            <input type="text" id="debugEmail" class="w-full px-4 py-2 border rounded-lg" 
                                   value="admin@apotekal" placeholder="Enter email/username">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="debugPassword" class="w-full px-4 py-2 border rounded-lg" 
                                   value="admin123" placeholder="Enter password">
                        </div>
                        <button type="submit" class="btn-primary w-full text-white py-3 px-4">
                            <span id="debugButtonText">Test Login</span>
                            <span id="debugButtonLoading" class="hidden">Testing...</span>
                        </button>
                    </form>
                    
                    <!-- Database Status -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-bold text-gray-700 mb-2">Database Status</h3>
                        <div id="dbStatus" class="text-sm text-gray-600">Checking...</div>
                    </div>
                </div>

                <!-- Debug Logs -->
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Debug Logs</h2>
                    <div id="debugLogs" class="max-h-96 overflow-y-auto">
                        <!-- Logs will be added here -->
                    </div>
                    <button onclick="clearLogs()" class="mt-4 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Clear Logs
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Logging utility
        const logs = [];
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({ timestamp, message, type });
            
            const logsContainer = document.getElementById('debugLogs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('debugLogs').innerHTML = '';
            logs.length = 0;
        }

        // Database Configuration (from index.html)
        const _0x4a2b = ['aHR0cHM6Ly90eG1ydm5mcXF6Ym91cGNtYXVwdC5zdXBhYmFzZS5jbw==', 
                      'ZXlKaGJHY2lPaUpJVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SnBjM01pT2lKemRYQmhZbUZ6WlNJc0luSmxaaUk2SW5SNGJYSjJibVp4Y1hwaWIzVndZMjFoZFhCMElpd2ljbTlzWlNJNkluTmxjblpwWTJWZmNtOXNaU0lzSW1saGRDSTZNVGMyTURBeE1UYzNNaXdpWlhod0lqb3lNRGMxTlRnM056Y3lmUS5iRFVPZ0NTc0tjUC1hSlhiYVMwQzdVTUE5Y0pGRzJ3N2J6S0R1MUVMVzY0Cg=='];
        
        let _db, _mode = false;

        // Initialize Database
        function initSecureDatabase() {
            try {
                addLog('üîÑ Starting database initialization...', 'info');
                const url = atob(_0x4a2b[0]);
                const key = atob(_0x4a2b[1]);
                
                addLog(`üìç Database URL: ${url}`, 'info');
                addLog(`üîë API Key length: ${key.length} characters`, 'info');
                
                if (!window.supabase) {
                    addLog('‚ùå Supabase library not loaded!', 'error');
                    updateDbStatus('ERROR: Supabase library not loaded', 'error');
                    return false;
                }
                
                _db = window.supabase.createClient(url, key);
                _mode = true;
                
                addLog('‚úÖ Database client created successfully', 'success');
                updateDbStatus('Connected to Supabase', 'success');
                
                // Test connection
                testDatabaseConnection();
                
                return true;
            } catch (error) {
                addLog(`‚ùå Database initialization failed: ${error.message}`, 'error');
                updateDbStatus(`ERROR: ${error.message}`, 'error');
                _mode = false;
                return false;
            }
        }

        function updateDbStatus(message, type = 'info') {
            const statusEl = document.getElementById('dbStatus');
            statusEl.textContent = message;
            statusEl.className = `text-sm ${type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-gray-600'}`;
        }

        // Test database connection
        async function testDatabaseConnection() {
            try {
                addLog('üß™ Testing database connection...', 'info');
                const { data, error } = await _db.from('users').select('count', { count: 'exact', head: true });
                
                if (error) {
                    addLog(`‚ùå Connection test failed: ${error.message}`, 'error');
                    updateDbStatus(`Connection Error: ${error.message}`, 'error');
                } else {
                    addLog('‚úÖ Database connection test successful', 'success');
                    updateDbStatus('Connected & Verified', 'success');
                }
            } catch (error) {
                addLog(`‚ùå Connection test error: ${error.message}`, 'error');
                updateDbStatus(`Test Error: ${error.message}`, 'error');
            }
        }

        // Password hashing (same as main app)
        function hashPassword(password) {
            return btoa(password + 'salt_apotek_alpro_2024');
        }

        // Authenticate User
        async function authenticateUser(email, password) {
            try {
                addLog(`üîê Starting authentication for: ${email}`, 'info');
                
                if (!_mode || !_db) {
                    addLog('‚ùå Database not available', 'error');
                    return null;
                }

                const passwordHash = hashPassword(password);
                addLog(`üîë Password hashed (length: ${passwordHash.length})`, 'info');

                addLog('üì° Querying database for user...', 'info');
                const { data, error } = await _db
                    .from('users')
                    .select('*')
                    .eq('email', email.toLowerCase())
                    .eq('password_hash', passwordHash)
                    .eq('status', 'active')
                    .single();

                if (error) {
                    addLog(`‚ùå Query error: ${error.message}`, 'error');
                    addLog(`Error details: ${JSON.stringify(error)}`, 'error');
                    return null;
                }

                if (!data) {
                    addLog('‚ùå No matching user found', 'error');
                    addLog('üîç Checking if user exists (without password check)...', 'warning');
                    
                    // Check if user exists at all
                    const { data: checkData, error: checkError } = await _db
                        .from('users')
                        .select('email, status')
                        .eq('email', email.toLowerCase());
                    
                    if (checkData && checkData.length > 0) {
                        addLog(`‚ö†Ô∏è User exists but credentials don't match. Status: ${checkData[0].status}`, 'warning');
                    } else {
                        addLog('‚ùå User does not exist in database', 'error');
                    }
                    
                    return null;
                }

                addLog('‚úÖ User authenticated successfully!', 'success');
                addLog(`üë§ User details: ${data.name} (${data.role})`, 'success');
                
                return {
                    email: data.email,
                    role: data.role,
                    name: data.name,
                    id: data.id
                };

            } catch (error) {
                addLog(`‚ùå Authentication error: ${error.message}`, 'error');
                addLog(`Stack trace: ${error.stack}`, 'error');
                return null;
            }
        }

        // Form submission handler
        document.getElementById('debugLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            addLog('='.repeat(50), 'info');
            addLog('üöÄ New login attempt started', 'info');
            
            const email = document.getElementById('debugEmail').value.trim();
            const password = document.getElementById('debugPassword').value;
            
            addLog(`üìß Email/Username: ${email}`, 'info');
            addLog(`üîí Password length: ${password.length}`, 'info');
            
            const buttonText = document.getElementById('debugButtonText');
            const buttonLoading = document.getElementById('debugButtonLoading');
            
            buttonText.classList.add('hidden');
            buttonLoading.classList.remove('hidden');
            
            const user = await authenticateUser(email, password);
            
            buttonText.classList.remove('hidden');
            buttonLoading.classList.add('hidden');
            
            if (user) {
                addLog('üéâ LOGIN SUCCESSFUL!', 'success');
                addLog(`Logged in as: ${user.name} (${user.email})`, 'success');
                addLog(`Role: ${user.role}`, 'success');
            } else {
                addLog('‚ùå LOGIN FAILED', 'error');
            }
            
            addLog('='.repeat(50), 'info');
        });

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            addLog('üåê Page loaded', 'info');
            addLog('üîç Checking for Supabase library...', 'info');
            
            if (window.supabase) {
                addLog('‚úÖ Supabase library found', 'success');
                initSecureDatabase();
            } else {
                addLog('‚ùå Supabase library not found - waiting...', 'warning');
                setTimeout(function() {
                    if (window.supabase) {
                        addLog('‚úÖ Supabase library loaded (delayed)', 'success');
                        initSecureDatabase();
                    } else {
                        addLog('‚ùå Supabase library still not available!', 'error');
                        updateDbStatus('Supabase library failed to load', 'error');
                    }
                }, 1000);
            }
        });
    </script>
</body>
</html>
