<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apotek Alpro - Executive Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        
        .dashboard-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        
        .tab-button {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            transition: all 0.3s ease;
            color: white;
            font-weight: 500;
        }
        
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
            transform: translateY(-2px);
        }
        
        .content-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .subtab-button {
            background: rgba(79, 70, 229, 0.1);
            color: #4f46e5;
            border: 1px solid rgba(79, 70, 229, 0.2);
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .subtab-button:hover {
            background: rgba(79, 70, 229, 0.2);
            transform: translateY(-1px);
        }
        
        .subtab-button.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.3);
        }
        
        .header-compact {
            padding: 0.75rem 1.5rem;
        }
        
        .alpro-logo {
            height: 40px;
            width: auto;
            border-radius: 8px;
        }
        
        .ip-display {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .tab-compact {
            padding: 0.5rem 1rem;
            margin: 0.25rem;
        }
        
        .iframe-container {
            height: calc(100vh - 180px);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(79, 70, 229, 0.1);
        }
        
        .iframe-full {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 15px;
        }
        
        .login-input {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(79, 70, 229, 0.2);
            border-radius: 10px;
            color: #333;
            font-weight: 500;
        }
        
        .login-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
            background: rgba(255, 255, 255, 1);
        }
        
        .login-input::placeholder {
            color: #9ca3af;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #dc2626;
            border-radius: 10px;
        }
        
        .user-mgmt-tab {
            border-bottom-color: transparent;
            color: #6b7280;
        }
        
        .user-mgmt-tab:hover {
            color: #374151;
            border-bottom-color: #d1d5db;
        }
        
        .user-mgmt-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="login-container w-full max-w-md p-8">
            <div class="text-center mb-8">
                <div class="mb-4">
                    <img src="assets/images/alpro-logo.png" alt="Apotek Alpro" class="mx-auto" style="height: 80px; width: auto;">
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Apotek Alpro</h1>
                <p class="text-gray-600">Executive Dashboard</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email / Username</label>
                    <input type="text" id="email" class="login-input w-full px-4 py-3" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" class="login-input w-full px-4 py-3" required>
                </div>
                
                <button type="submit" id="loginButton" class="btn-primary w-full text-white py-3 px-4">
                    <span id="loginButtonContent">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Login
                    </span>
                    <span id="loginLoadingContent" class="hidden">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        Authenticating, please wait...
                    </span>
                </button>
                
                <div id="errorMessage" class="error-message p-3 hidden">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span id="errorText">Invalid credentials. Please check your email and password.</span>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <div class="dashboard-container mx-4 mt-4 mb-2">
            <div class="header-compact flex justify-between items-center">
                <div class="flex items-center text-white">
                    <img src="assets/images/alpro-logo.png" alt="Apotek Alpro" class="alpro-logo mr-3">
                    <div>
                        <h1 class="text-xl font-bold">Apotek Alpro</h1>
                        <p class="text-sm opacity-90">Executive Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4 text-white">
                    <div class="text-right">
                        <div class="flex items-center">
                            <i class="fas fa-user-circle mr-2"></i>
                            <span id="userEmail" class="font-medium"></span>
                        </div>
                        <div class="text-xs opacity-90">
                            Role: <span id="userRole" class="font-medium"></span>
                        </div>
                        <div class="text-xs opacity-90 mt-1">
                            IP: <span id="userIP" class="ip-display">Loading...</span>
                        </div>
                    </div>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt mr-1"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="dashboard-container mx-4 mb-4">
            <div class="p-4">
                <div id="tabNavigation" class="flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="mx-4 mb-4">
            <div class="content-card p-6">
                <!-- Operations Content -->
                <div id="operationsContent" class="tab-content hidden">
                    <div class="mb-4">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-4">
                            <i class="fas fa-cogs mr-3 text-blue-600"></i>
                            Operations Department
                        </h2>
                        
                        <!-- Operations Subtabs -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            <button onclick="showOperationsSubtab('outlet-dashboard')" 
                                    class="subtab-button active px-4 py-2">
                                <i class="fas fa-store mr-2"></i>
                                Outlet Dashboard
                            </button>
                            <button onclick="showOperationsSubtab('opps-ed-project')" 
                                    class="subtab-button px-4 py-2">
                                <i class="fas fa-project-diagram mr-2"></i>
                                OPPS ED Project
                            </button>
                            <button onclick="showOperationsSubtab('am-performance-tracker')" 
                                    class="subtab-button px-4 py-2">
                                <i class="fas fa-chart-bar mr-2"></i>
                                AM Performance Tracker
                            </button>
                        </div>
                        
                        <!-- Outlet Dashboard Subtab -->
                        <div id="outletDashboardSubtab" class="operations-subtab">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">Outlet Dashboard</h3>
                                    <p class="text-gray-600">Operational management and monitoring system</p>
                                </div>
                                <button onclick="openInNewTab('https://script.google.com/macros/s/AKfycbyE1R2ogJa1mJ2GXGFB_cZeiX86H8LbBRiy03Umj6Gr_xnvdlT7KytPhwiLueviYvaXFg/exec')" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open in New Tab
                                </button>
                            </div>
                            <div class="iframe-container">
                                <iframe src="https://script.google.com/macros/s/AKfycbyE1R2ogJa1mJ2GXGFB_cZeiX86H8LbBRiy03Umj6Gr_xnvdlT7KytPhwiLueviYvaXFg/exec" 
                                        class="iframe-full"></iframe>
                            </div>
                        </div>
                        
                        <!-- OPPS ED Project Subtab -->
                        <div id="oppsEdProjectSubtab" class="operations-subtab hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">OPPS ED Project</h3>
                                    <p class="text-gray-600">Operations project management and tracking system</p>
                                </div>
                                <button onclick="openInNewTab('https://script.google.com/macros/s/AKfycbyM0BENUmoe8itSgDxfo_qReKiBtkiVSjOtkThg5y58YjhuCGv3CVEpl2J1tYZknkP4/exec')" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open in New Tab
                                </button>
                            </div>
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-100 rounded-lg p-8 text-center">
                                <i class="fas fa-project-diagram text-6xl text-indigo-500 mb-4"></i>
                                <h4 class="text-xl font-semibold text-gray-800 mb-2">OPPS ED Project Dashboard</h4>
                                <p class="text-gray-600 mb-6">This system cannot be embedded due to security restrictions.<br>Click the button below to access the full application.</p>
                                <button onclick="openInNewTab('https://script.google.com/macros/s/AKfycbyM0BENUmoe8itSgDxfo_qReKiBtkiVSjOtkThg5y58YjhuCGv3CVEpl2J1tYZknkP4/exec')" 
                                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Launch OPPS ED Project
                                </button>
                            </div>
                        </div>
                        
                        <!-- AM Performance Tracker Subtab -->
                        <div id="amPerformanceTrackerSubtab" class="operations-subtab hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">AM Performance Tracker</h3>
                                    <p class="text-gray-600">Area Manager performance monitoring and leaderboard system</p>
                                </div>
                                <button onclick="amTracker.refreshData()" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-sync-alt mr-2"></i>
                                    Refresh Data
                                </button>
                            </div>
                            
                            <!-- Loading State -->
                            <div id="amTrackerLoading" class="text-center py-8 hidden">
                                <div class="inline-flex items-center">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                                    <span class="text-gray-700">Loading AM performance data...</span>
                                </div>
                            </div>

                            <!-- Error State -->
                            <div id="amTrackerError" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4 hidden">
                                <div class="flex items-center">
                                    <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                                    <span class="text-red-700">Error loading AM performance data. Please check your connection and try again.</span>
                                </div>
                            </div>

                            <!-- Champion Leaderboard Cards -->
                            <div id="amTrackerSummaryCards" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                <!-- Growth Champions Leaderboard -->
                                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-6 border border-green-200">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-lg font-bold text-green-800 flex items-center">
                                            <i class="fas fa-chart-line mr-2"></i>
                                            Growth Champions
                                        </h4>
                                        <i class="fas fa-trophy text-2xl text-green-600"></i>
                                    </div>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-green-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 bg-gradient-to-r from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                                    <i class="fas fa-crown"></i>
                                                </div>
                                                <div>
                                                    <div class="font-semibold text-gray-800" id="amTrackerGrowthChamp1Name">Loading...</div>
                                                    <div class="text-xs text-gray-600">Champion</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-bold text-green-600" id="amTrackerGrowthChamp1Rate">-</div>
                                                <div class="text-xs text-gray-600">Growth Rate</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-green-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 bg-gradient-to-r from-gray-400 to-gray-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                                    2
                                                </div>
                                                <div>
                                                    <div class="font-semibold text-gray-800" id="amTrackerGrowthChamp2Name">Loading...</div>
                                                    <div class="text-xs text-gray-600">Runner-up</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-bold text-green-600" id="amTrackerGrowthChamp2Rate">-</div>
                                                <div class="text-xs text-gray-600">Growth Rate</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-green-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 bg-gradient-to-r from-orange-400 to-orange-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                                    3
                                                </div>
                                                <div>
                                                    <div class="font-semibold text-gray-800" id="amTrackerGrowthChamp3Name">Loading...</div>
                                                    <div class="text-xs text-gray-600">Third Place</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-bold text-green-600" id="amTrackerGrowthChamp3Rate">-</div>
                                                <div class="text-xs text-gray-600">Growth Rate</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Achievement Champions Leaderboard -->
                                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-6 border border-purple-200">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-lg font-bold text-purple-800 flex items-center">
                                            <i class="fas fa-bullseye mr-2"></i>
                                            Achievement Champions
                                        </h4>
                                        <i class="fas fa-star text-2xl text-purple-600"></i>
                                    </div>
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-purple-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 bg-gradient-to-r from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                                    <i class="fas fa-crown"></i>
                                                </div>
                                                <div>
                                                    <div class="font-semibold text-gray-800" id="amTrackerAchievementChamp1Name">Loading...</div>
                                                    <div class="text-xs text-gray-600">Champion</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-bold text-purple-600" id="amTrackerAchievementChamp1Rate">-</div>
                                                <div class="text-xs text-gray-600">Achievement %</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-purple-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 bg-gradient-to-r from-gray-400 to-gray-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                                    2
                                                </div>
                                                <div>
                                                    <div class="font-semibold text-gray-800" id="amTrackerAchievementChamp2Name">Loading...</div>
                                                    <div class="text-xs text-gray-600">Runner-up</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-bold text-purple-600" id="amTrackerAchievementChamp2Rate">-</div>
                                                <div class="text-xs text-gray-600">Achievement %</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center justify-between p-3 bg-white rounded-lg border border-purple-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 bg-gradient-to-r from-orange-400 to-orange-600 rounded-full flex items-center justify-center text-white font-bold text-sm mr-3">
                                                    3
                                                </div>
                                                <div>
                                                    <div class="font-semibold text-gray-800" id="amTrackerAchievementChamp3Name">Loading...</div>
                                                    <div class="text-xs text-gray-600">Third Place</div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="font-bold text-purple-600" id="amTrackerAchievementChamp3Rate">-</div>
                                                <div class="text-xs text-gray-600">Achievement %</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- AM Performance Overview Table -->
                            <div id="amTrackerOverviewTable" class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
                                <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
                                    <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                                        <i class="fas fa-users-cog mr-2 text-blue-600"></i>
                                        All Area Managers Performance Overview
                                    </h4>
                                    <p class="text-sm text-gray-600 mt-1">Complete performance metrics for all Area Managers</p>
                                </div>
                                
                                <!-- Quick Stats Bar -->
                                <div id="amTrackerQuickStats" class="bg-blue-50 px-6 py-3 border-b border-gray-200">
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                        <div>
                                            <span class="text-lg font-bold text-blue-600" id="amTrackerTotalUniqueAMs">0</span>
                                            <div class="text-xs text-gray-600">Unique AMs</div>
                                        </div>
                                        <div>
                                            <span class="text-lg font-bold text-green-600" id="amTrackerTopGrowthAM">-</span>
                                            <div class="text-xs text-gray-600">Total Growth %</div>
                                        </div>
                                        <div>
                                            <span class="text-lg font-bold text-purple-600" id="amTrackerTopForecastAM">-</span>
                                            <div class="text-xs text-gray-600">Total Forecast %</div>
                                        </div>
                                        <div>
                                            <span class="text-lg font-bold text-orange-600" id="amTrackerTotalOutlets">0</span>
                                            <div class="text-xs text-gray-600">Total Outlets</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="min-w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="amTracker.sortOverview('rank')">
                                                    <div class="flex items-center">
                                                        Rank
                                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                                    </div>
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="amTracker.sortOverview('amName')">
                                                    <div class="flex items-center">
                                                        AM Name
                                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                                    </div>
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="amTracker.sortOverview('outlets')">
                                                    <div class="flex items-center">
                                                        Outlets Managed
                                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                                    </div>
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="amTracker.sortOverview('avgGrowth')">
                                                    <div class="flex items-center">
                                                        Avg Growth %
                                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                                    </div>
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="amTracker.sortOverview('avgForecast')">
                                                    <div class="flex items-center">
                                                        Avg Forecast %
                                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                                    </div>
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="amTracker.sortOverview('performance')">
                                                    <div class="flex items-center">
                                                        Overall Performance
                                                        <i class="fas fa-sort ml-1 text-gray-400"></i>
                                                    </div>
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    Actions
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="amTrackerOverviewTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- AM overview rows will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- AM Overview Pagination -->
                                <div id="amTrackerOverviewPagination" class="bg-gray-50 px-6 py-3 flex justify-between items-center border-t border-gray-200">
                                    <div class="text-sm text-gray-700">
                                        Showing <span id="amTrackerOverviewShowingStart">0</span> to <span id="amTrackerOverviewShowingEnd">0</span> of <span id="amTrackerOverviewTotalRecords">0</span> Area Managers
                                    </div>
                                    <div class="flex space-x-2">
                                        <button id="amTrackerOverviewPrevBtn" onclick="amTracker.changeOverviewPage(-1)" 
                                                class="px-3 py-1 border border-gray-300 rounded text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                            Previous
                                        </button>
                                        <span id="amTrackerOverviewPageInfo" class="px-3 py-1 text-gray-600">Page 1 of 1</span>
                                        <button id="amTrackerOverviewNextBtn" onclick="amTracker.changeOverviewPage(1)" 
                                                class="px-3 py-1 border border-gray-300 rounded text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                            Next
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Filters and Controls -->
                            <div class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Search AM</label>
                                        <input type="text" id="amTrackerSearchInput" placeholder="Search by AM name..." 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 placeholder-gray-500 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                               oninput="amTracker.filterData()">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                                        <select id="amTrackerSortBySelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                onchange="amTracker.sortData()">
                                            <option value="growth-desc">Growth % (High to Low)</option>
                                            <option value="growth-asc">Growth % (Low to High)</option>
                                            <option value="forecast-desc">Forecast % (High to Low)</option>
                                            <option value="forecast-asc">Forecast % (Low to High)</option>
                                            <option value="name-asc">AM Name (A to Z)</option>
                                            <option value="name-desc">AM Name (Z to A)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">View Mode</label>
                                        <div class="flex rounded-lg border border-gray-300">
                                            <button id="amTrackerTableViewBtn" onclick="amTracker.setViewMode('table')" 
                                                    class="flex-1 px-3 py-2 bg-blue-600 text-white rounded-l-lg transition-colors">
                                                <i class="fas fa-table mr-1"></i> Table
                                            </button>
                                            <button id="amTrackerCardViewBtn" onclick="amTracker.setViewMode('cards')" 
                                                    class="flex-1 px-3 py-2 bg-gray-200 text-gray-700 rounded-r-lg transition-colors">
                                                <i class="fas fa-th-large mr-1"></i> Cards
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Table View -->
                            <div id="amTrackerTableView" class="bg-white rounded-lg shadow overflow-hidden">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Outlet</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Outlet Name</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AM Name</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monthly Target</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Growth %</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Forecast %</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Performance</th>
                                            </tr>
                                        </thead>
                                        <tbody id="amTrackerTableBody" class="bg-white divide-y divide-gray-200">
                                            <!-- Table rows will be populated dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Performance Cards View -->
                            <div id="amTrackerCardsView" class="hidden">
                                <div id="amTrackerCardsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <!-- Cards will be populated dynamically -->
                                </div>
                            </div>

                            <!-- Pagination -->
                            <div id="amTrackerPagination" class="flex justify-between items-center mt-6">
                                <div class="text-sm text-gray-700">
                                    Showing <span id="amTrackerShowingStart">1</span> to <span id="amTrackerShowingEnd">10</span> of <span id="amTrackerTotalRecords">0</span> AMs
                                </div>
                                <div class="flex space-x-2">
                                    <button id="amTrackerPrevPageBtn" onclick="amTracker.changePage(-1)" 
                                            class="px-3 py-1 border border-gray-300 rounded text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                        Previous
                                    </button>
                                    <span id="amTrackerPageInfo" class="px-3 py-1 text-gray-600">Page 1 of 1</span>
                                    <button id="amTrackerNextPageBtn" onclick="amTracker.changePage(1)" 
                                            class="px-3 py-1 border border-gray-300 rounded text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                        Next
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PPM Content -->
                <div id="ppmContent" class="tab-content hidden">
                    <div class="mb-4">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-4">
                            <i class="fas fa-chart-line mr-3 text-green-600"></i>
                            PPM Department
                        </h2>
                        
                        <!-- PPM Subtabs -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            <button onclick="showPpmSubtab('dashboard')" 
                                    class="subtab-button active px-4 py-2">
                                <i class="fas fa-tachometer-alt mr-2"></i>
                                PPM Dashboard
                            </button>
                            <button onclick="showPpmSubtab('payroll-ledger')" 
                                    class="subtab-button px-4 py-2">
                                <i class="fas fa-file-invoice-dollar mr-2"></i>
                                Payroll Ledger
                            </button>
                            <button onclick="showPpmSubtab('lateness-report')" 
                                    class="subtab-button px-4 py-2">
                                <i class="fas fa-clock mr-2"></i>
                                Lateness Report
                            </button>
                            <button onclick="showPpmSubtab('kpj-bpjs')" 
                                    class="subtab-button px-4 py-2">
                                <i class="fas fa-shield-alt mr-2"></i>
                                KPJ BPJS
                            </button>
                            <button onclick="showPpmSubtab('tes-kesehatan')" 
                                    class="subtab-button px-4 py-2">
                                <i class="fas fa-stethoscope mr-2"></i>
                                Tes Kesehatan
                            </button>
                            <button onclick="showPpmSubtab('salary-calculator')" 
                                    class="subtab-button px-4 py-2">
                                <i class="fas fa-calculator mr-2"></i>
                                Salary Calculator
                            </button>
                        </div>
                        
                        <!-- PPM Dashboard Subtab -->
                        <div id="ppmDashboardSubtab" class="ppm-subtab">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">PPM Dashboard</h3>
                                    <p class="text-gray-600">Project and performance management system</p>
                                </div>
                                <button onclick="openInNewTab('https://script.google.com/macros/s/AKfycbzaRaZPlsmOGgKRGssxuMPvYx9FQabDshXkwkfkJyIpoZQ4OHz7TYr7wtccK2DAnlho/exec')" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open in New Tab
                                </button>
                            </div>
                            <div class="iframe-container">
                                <iframe src="https://script.google.com/macros/s/AKfycbzaRaZPlsmOGgKRGssxuMPvYx9FQabDshXkwkfkJyIpoZQ4OHz7TYr7wtccK2DAnlho/exec" 
                                        class="iframe-full"></iframe>
                            </div>
                        </div>
                        
                        <!-- Payroll Ledger Subtab -->
                        <div id="payrollLedgerSubtab" class="ppm-subtab hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">Payroll Ledger</h3>
                                    <p class="text-gray-600">Employee payroll management and ledger system</p>
                                </div>
                                <button onclick="openInNewTab('https://script.google.com/macros/s/AKfycbxubW8WOVAKGgHS_jA70XHzKTbeSmAHve9y6G_h_XiSPl8z7P4mtTRU0kaIN14_ilDmYQ/exec')" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open in New Tab
                                </button>
                            </div>
                            <div class="iframe-container">
                                <iframe src="https://script.google.com/macros/s/AKfycbxubW8WOVAKGgHS_jA70XHzKTbeSmAHve9y6G_h_XiSPl8z7P4mtTRU0kaIN14_ilDmYQ/exec" 
                                        class="iframe-full"></iframe>
                            </div>
                        </div>
                        
                        <!-- Lateness Report Subtab -->
                        <div id="latenessReportSubtab" class="ppm-subtab hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">Lateness Report</h3>
                                    <p class="text-gray-600">Employee lateness tracking and reporting system</p>
                                </div>
                                <button onclick="openInNewTab('https://vlksesmp.gensparkspace.com/')" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open in New Tab
                                </button>
                            </div>
                            <div class="iframe-container">
                                <iframe src="https://vlksesmp.gensparkspace.com/" 
                                        class="iframe-full"></iframe>
                            </div>
                        </div>
                        
                        <!-- KPJ BPJS Subtab -->
                        <div id="kpjBpjsSubtab" class="ppm-subtab hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">KPJ BPJS</h3>
                                    <p class="text-gray-600">KPJ BPJS management and reporting system</p>
                                </div>
                                <button onclick="openInNewTab('https://woyztffi.gensparkspace.com/')" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open in New Tab
                                </button>
                            </div>
                            <div class="iframe-container">
                                <iframe src="https://woyztffi.gensparkspace.com/" 
                                        class="iframe-full"></iframe>
                            </div>
                        </div>
                        
                        <!-- Tes Kesehatan Subtab -->
                        <div id="tesKesehatanSubtab" class="ppm-subtab hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">Tes Kesehatan</h3>
                                    <p class="text-gray-600">Health testing and medical examination system</p>
                                </div>
                                <button onclick="openInNewTab('https://znxbkqqx.gensparkspace.com/')" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open in New Tab
                                </button>
                            </div>
                            <div class="iframe-container">
                                <iframe src="https://znxbkqqx.gensparkspace.com/" 
                                        class="iframe-full"></iframe>
                            </div>
                        </div>
                        
                        <!-- Salary Calculator Subtab -->
                        <div id="salaryCalculatorSubtab" class="ppm-subtab hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">Salary Calculator</h3>
                                    <p class="text-gray-600">Employee salary calculation and payroll management tool</p>
                                </div>
                                <button onclick="openInNewTab('https://xcqtggfp.gensparkspace.com/')" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open in New Tab
                                </button>
                            </div>
                            <div class="iframe-container">
                                <iframe src="https://xcqtggfp.gensparkspace.com/" 
                                        class="iframe-full"></iframe>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Strategy Content -->
                <div id="strategyContent" class="tab-content hidden">
                    <div class="mb-4">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-4">
                            <i class="fas fa-chess mr-3 text-purple-600"></i>
                            Strategy Department
                        </h2>
                        
                        <!-- Strategy Subtabs -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            <button onclick="showStrategySubtab('dashboard')" 
                                    class="subtab-button active px-4 py-2">
                                <i class="fas fa-tachometer-alt mr-2"></i>
                                Dashboard
                            </button>
                            <button onclick="showStrategySubtab('phoenix-okr')" 
                                    class="subtab-button px-4 py-2">
                                <i class="fas fa-bullseye mr-2"></i>
                                Phoenix OKR
                            </button>
                        </div>
                        
                        <!-- Strategy Dashboard Subtab -->
                        <div id="strategyDashboardSubtab" class="strategy-subtab">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">Strategy Dashboard</h3>
                                    <p class="text-gray-600">Strategic planning and analysis system</p>
                                </div>
                                <button onclick="openInNewTab('https://script.google.com/macros/s/AKfycbyXBzPOvB7_u5QYUdA9FKNFPLjoB4li1OekWjUEWstmOJC-adXBHxKtBRi6oR7p9-Ds/exec')" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open in New Tab
                                </button>
                            </div>
                            <div class="iframe-container">
                                <iframe src="https://script.google.com/macros/s/AKfycbyXBzPOvB7_u5QYUdA9FKNFPLjoB4li1OekWjUEWstmOJC-adXBHxKtBRi6oR7p9-Ds/exec" 
                                        class="iframe-full"></iframe>
                            </div>
                        </div>
                        
                        <!-- Phoenix OKR Subtab -->
                        <div id="phoenixOkrSubtab" class="strategy-subtab hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">Phoenix OKR</h3>
                                    <p class="text-gray-600">Objectives and Key Results management system</p>
                                </div>
                                <button onclick="openInNewTab('https://apotekalpro.github.io/Strategy-Phoenix/okr-login.html')" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open in New Tab
                                </button>
                            </div>
                            <div class="iframe-container">
                                <iframe src="https://apotekalpro.github.io/Strategy-Phoenix/okr-login.html" 
                                        class="iframe-full"></iframe>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finance Content -->
                <div id="financeContent" class="tab-content hidden">
                    <div class="mb-4">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-4">
                            <i class="fas fa-dollar-sign mr-3 text-green-600"></i>
                            Finance Department
                        </h2>
                        
                        <!-- Finance Subtabs -->
                        <div class="flex flex-wrap gap-2 mb-6">
                            <button onclick="showFinanceSubtab('gd-analysis')" 
                                    class="subtab-button active px-4 py-2">
                                <i class="fas fa-factory mr-2"></i>
                                Supplier Invoice GD Analysis
                            </button>
                            <button onclick="showFinanceSubtab('coretax')" 
                                    class="subtab-button px-4 py-2">
                                <i class="fas fa-receipt mr-2"></i>
                                Coretax - Invoice Matching
                            </button>
                            <button onclick="showFinanceSubtab('payment')" 
                                    class="subtab-button px-4 py-2">
                                <i class="fas fa-credit-card mr-2"></i>
                                Invoice & Payment Analysis
                            </button>
                            <button onclick="showFinanceSubtab('d365-sync')" 
                                    class="subtab-button px-4 py-2">
                                <i class="fas fa-sync-alt mr-2"></i>
                                D365 Sync Check
                            </button>
                        </div>
                        
                        <!-- GD Analysis Subtab -->
                        <div id="gdAnalysisSubtab" class="finance-subtab">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">Supplier Invoice GD Analysis</h3>
                                    <p class="text-gray-600">Goods received document analysis and supplier management</p>
                                </div>
                                <button onclick="openInNewTab('https://script.google.com/macros/s/AKfycbxnxfu8mOtNNyetUbhIXc3VGlAIO_YIKc8jlstv4IIKHJrE5wncT0hO4TCcOgZTsg0cHQ/exec')" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open in New Tab
                                </button>
                            </div>
                            <div class="iframe-container">
                                <iframe src="https://script.google.com/macros/s/AKfycbxnxfu8mOtNNyetUbhIXc3VGlAIO_YIKc8jlstv4IIKHJrE5wncT0hO4TCcOgZTsg0cHQ/exec" 
                                        class="iframe-full"></iframe>
                            </div>
                        </div>
                        
                        <!-- Coretax Subtab -->
                        <div id="coretaxSubtab" class="finance-subtab hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">Coretax - Invoice Matching System</h3>
                                    <p class="text-gray-600">Tax invoice processing and matching system</p>
                                </div>
                                <button onclick="openInNewTab('./finance/invoice-matching.html')" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open in New Tab
                                </button>
                            </div>
                            <div class="iframe-container">
                                <iframe src="./finance/invoice-matching.html" class="iframe-full"></iframe>
                            </div>
                        </div>
                        
                        <!-- Payment Analysis Subtab -->
                        <div id="paymentSubtab" class="finance-subtab hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">Invoice & Payment Analysis</h3>
                                    <p class="text-gray-600">Payment matching and analysis dashboard</p>
                                </div>
                                <button onclick="openInNewTab('./finance/payment-analysis.html')" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open in New Tab
                                </button>
                            </div>
                            <div class="iframe-container">
                                <iframe src="./finance/payment-analysis.html" class="iframe-full"></iframe>
                            </div>
                        </div>
                        
                        <!-- D365 Sync Check Subtab -->
                        <div id="d365SyncSubtab" class="finance-subtab hidden">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">D365 Sync Check</h3>
                                    <p class="text-gray-600">Dynamics 365 synchronization monitoring and validation</p>
                                </div>
                                <button onclick="openInNewTab('https://script.google.com/macros/s/AKfycbw-Fd3oknK99wrN7p0YaeLt-PawQtKRXyKQXzJr5ff9TPN0xEBfJ4Yiw8IN_R8l7XJP/exec')" 
                                        class="btn-primary text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                    Open in New Tab
                                </button>
                            </div>
                            <div class="iframe-container">
                                <iframe src="https://script.google.com/macros/s/AKfycbw-Fd3oknK99wrN7p0YaeLt-PawQtKRXyKQXzJr5ff9TPN0xEBfJ4Yiw8IN_R8l7XJP/exec" 
                                        class="iframe-full"></iframe>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BPT Content -->
                <div id="bptContent" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                                <i class="fas fa-bullseye mr-3 text-orange-600"></i>
                                BPT Dashboard
                            </h2>
                            <p class="text-gray-600">Business process transformation system</p>
                        </div>
                        <button onclick="openInNewTab('https://apotekalpro.github.io/BPT/login.html')" 
                                class="btn-primary text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-external-link-alt mr-2"></i>
                            Open in New Tab
                        </button>
                    </div>
                    <div class="iframe-container">
                        <iframe src="https://apotekalpro.github.io/BPT/login.html" 
                                class="iframe-full"></iframe>
                    </div>
                </div>

                <!-- Procurement Content -->
                <div id="procurementContent" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                                <i class="fas fa-shopping-cart mr-3 text-blue-600"></i>
                                Procurement Dashboard
                            </h2>
                            <p class="text-gray-600">Procurement analysis and management system</p>
                        </div>
                        <button onclick="openInNewTab('https://procurementanalys.github.io/dashboardproc/')" 
                                class="btn-primary text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-external-link-alt mr-2"></i>
                            Open in New Tab
                        </button>
                    </div>
                    <div class="iframe-container">
                        <iframe src="https://procurementanalys.github.io/dashboardproc/" 
                                class="iframe-full"></iframe>
                    </div>
                </div>

                <!-- Warehouse APD Content -->
                <div id="warehouseApdContent" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                                <i class="fas fa-warehouse mr-3 text-green-600"></i>
                                Warehouse APD Dashboard
                            </h2>
                            <p class="text-gray-600">Warehouse management and inventory system</p>
                        </div>
                        <button onclick="openInNewTab('https://alprobook.vercel.app/')" 
                                class="btn-primary text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-external-link-alt mr-2"></i>
                            Open in New Tab
                        </button>
                    </div>
                    <div class="iframe-container">
                        <iframe src="https://alprobook.vercel.app/" 
                                class="iframe-full"></iframe>
                    </div>
                </div>

                <!-- PPR Content -->
                <div id="pprContent" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                                <i class="fas fa-sitemap mr-3 text-purple-600"></i>
                                PPR Dashboard
                            </h2>
                            <p class="text-gray-600">Master outlet management and organizational system</p>
                        </div>
                        <button onclick="openInNewTab('https://sites.google.com/view/alpromaster/master-outlet')" 
                                class="btn-primary text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-external-link-alt mr-2"></i>
                            Open in New Tab
                        </button>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-pink-100 rounded-lg p-8 text-center">
                        <i class="fas fa-sitemap text-6xl text-purple-500 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Master Outlet Management</h3>
                        <p class="text-gray-600 mb-6">This Google Sites page cannot be embedded due to security restrictions.<br>Click the button below to access the full application.</p>
                        <button onclick="openInNewTab('https://sites.google.com/view/alpromaster/master-outlet')" 
                                class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200">
                            <i class="fas fa-external-link-alt mr-2"></i>
                            Launch PPR Dashboard
                        </button>
                    </div>
                </div>

                <!-- Academy Content -->
                <div id="academyContent" class="tab-content hidden">
                    <div class="text-center py-12">
                        <i class="fas fa-graduation-cap text-6xl text-indigo-400 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Academy Dashboard</h2>
                        <p class="text-gray-600">Training and development management</p>
                        <p class="text-sm text-gray-500 mt-4">Integration coming soon...</p>
                    </div>
                </div>

                <!-- User Edit Modal -->
                <div id="userEditModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <div class="p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-semibold text-gray-800">Edit User</h3>
                                    <button onclick="closeUserEditModal()" class="text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-times text-xl"></i>
                                    </button>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="hidden" id="editUserId">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                        <input type="text" id="editUserName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                        <input type="email" id="editUserEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                        <div class="relative">
                                            <input type="password" id="editUserPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-10">
                                            <button type="button" onclick="togglePasswordVisibility('editUserPassword')" 
                                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                        <select id="editUserRole" onchange="onEditUserRoleChange()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="admin">Admin</option>
                                            <option value="chief">Chief</option>
                                            <option value="strategy">Strategy</option>
                                            <option value="operations">Operations</option>
                                            <option value="ppm">PPM</option>
                                            <option value="finance">Finance</option>
                                            <option value="bpt">BPT</option>
                                            <option value="procurement">Procurement</option>
                                            <option value="warehouse">Warehouse</option>
                                            <option value="ppr">PPR</option>
                                            <option value="academy">Academy</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                        <select id="editUserStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Employee ID</label>
                                        <input type="text" id="editUserEmployeeId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                                    <textarea id="editUserNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                
                                <div class="mt-6">
                                    <h4 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                                        <i class="fas fa-key mr-2 text-blue-600"></i>
                                        Department Access Permissions
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 p-4 bg-gray-50 rounded-lg border" id="editUserDepartmentAccess">
                                        <!-- Department access checkboxes will be populated here -->
                                    </div>
                                    <div class="mt-3 flex gap-2">
                                        <button type="button" onclick="selectAllEditUserDepartments()" 
                                                class="px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                                            <i class="fas fa-check-double mr-1"></i>All
                                        </button>
                                        <button type="button" onclick="deselectAllEditUserDepartments()" 
                                                class="px-3 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                                            <i class="fas fa-times mr-1"></i>None
                                        </button>
                                        <button type="button" onclick="resetEditUserToRoleDefaults()" 
                                                class="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                                            <i class="fas fa-undo mr-1"></i>Role Defaults
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end gap-4 mt-6">
                                    <button onclick="closeUserEditModal()" 
                                            class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                        Cancel
                                    </button>
                                    <button onclick="deleteUser()" 
                                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                        <i class="fas fa-trash mr-2"></i>Delete User
                                    </button>
                                    <button onclick="saveUserChanges()" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-save mr-2"></i>Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Configuration Content -->
                <div id="adminConfigContent" class="tab-content hidden">
                    <div class="mb-4">
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-4">
                            <i class="fas fa-cogs mr-3 text-red-600"></i>
                            Admin Configuration Panel
                        </h2>
                        <p class="text-gray-600 mb-6">Manage department access permissions for different user roles</p>
                        
                        <!-- Configuration Status -->
                        <div id="configStatus" class="mb-6 p-4 rounded-lg border hidden">
                            <div class="flex items-center">
                                <i id="configStatusIcon" class="fas fa-info-circle mr-2"></i>
                                <span id="configStatusText">Ready</span>
                            </div>
                        </div>
                        
                        <!-- User-Level Department Access Management -->
                        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-user-cog mr-2 text-blue-600"></i>
                                User Department Access Management
                            </h3>
                            
                            <!-- User Selection for Department Access -->
                            <div class="mb-6">
                                <div class="flex flex-col md:flex-row gap-4 mb-4">
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Search User to Configure Access:</label>
                                        <input type="text" id="userAccessSearch" placeholder="Search by name or email..." 
                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                               oninput="searchUsersForAccess()">
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Or Select from List:</label>
                                        <select id="userAccessSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                onchange="selectUserForAccess()">
                                            <option value="">Choose a user...</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- User Search Results -->
                                <div id="userAccessSearchResults" class="hidden mb-4">
                                    <h5 class="text-sm font-medium text-gray-700 mb-2">Search Results:</h5>
                                    <div id="userAccessSearchList" class="max-h-32 overflow-y-auto border border-gray-200 rounded-lg">
                                        <!-- Search results will be populated here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Selected User Department Access Configuration -->
                            <div id="userDepartmentConfig" class="hidden">
                                <div class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-200">
                                    <h4 class="text-lg font-medium text-gray-800 mb-2 flex items-center">
                                        <i class="fas fa-user mr-2 text-blue-600"></i>
                                        Configuring access for: <span id="selectedUserName" class="text-blue-600 font-semibold ml-2"></span>
                                    </h4>
                                    <div class="text-sm text-gray-600">
                                        <p><strong>Email:</strong> <span id="selectedUserEmail"></span></p>
                                        <p><strong>Role:</strong> <span id="selectedUserRole" class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs"></span></p>
                                        <p><strong>Status:</strong> <span id="selectedUserStatus"></span></p>
                                    </div>
                                </div>
                                
                                <h5 class="text-md font-medium text-gray-800 mb-4">Department Access Permissions:</h5>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6" id="userDepartmentCheckboxes">
                                    <!-- User-specific department checkboxes will be dynamically generated -->
                                </div>
                                
                                <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                                    <div class="flex gap-2">
                                        <button onclick="selectAllUserDepartments()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                            <i class="fas fa-check-double mr-2"></i>Select All
                                        </button>
                                        <button onclick="deselectAllUserDepartments()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                            <i class="fas fa-times mr-2"></i>Deselect All
                                        </button>
                                        <button onclick="resetToRoleDefaults()" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                                            <i class="fas fa-undo mr-2"></i>Reset to Role Defaults
                                        </button>
                                    </div>
                                    <button onclick="saveUserDepartmentAccess()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-save mr-2"></i>Save User Access
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Department Management Section -->
                        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-plus-circle mr-2 text-green-600"></i>
                                Department Management
                            </h3>
                            
                            <!-- Add New Department -->
                            <div class="mb-6">
                                <h4 class="text-lg font-medium text-gray-800 mb-4">Add New Department:</h4>
                                <div class="flex gap-4 items-end">
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Department ID:</label>
                                        <input type="text" id="newDepartmentId" placeholder="e.g., marketing" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Department Name:</label>
                                        <input type="text" id="newDepartmentName" placeholder="e.g., Marketing" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Icon Class:</label>
                                        <input type="text" id="newDepartmentIcon" placeholder="e.g., fas fa-bullhorn" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <button onclick="addNewDepartment()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                        <i class="fas fa-plus mr-2"></i>Add Department
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Current Departments List -->
                            <div>
                                <h4 class="text-lg font-medium text-gray-800 mb-4">Current Departments:</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="currentDepartmentsList">
                                    <!-- Current departments will be listed here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- User Management Section -->
                        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-users-cog mr-2 text-indigo-600"></i>
                                User Management System
                            </h3>
                            
                            <!-- User Management Tabs -->
                            <div class="mb-6">
                                <div class="flex border-b border-gray-200">
                                    <button onclick="switchUserManagementTab('userList')" 
                                            class="user-mgmt-tab px-4 py-2 font-medium text-sm border-b-2 transition-colors active" 
                                            data-tab="userList">
                                        <i class="fas fa-list mr-2"></i>User List
                                    </button>
                                    <button onclick="switchUserManagementTab('addUser')" 
                                            class="user-mgmt-tab px-4 py-2 font-medium text-sm border-b-2 transition-colors" 
                                            data-tab="addUser">
                                        <i class="fas fa-user-plus mr-2"></i>Add User
                                    </button>
                                    <button onclick="switchUserManagementTab('loginLogs')" 
                                            class="user-mgmt-tab px-4 py-2 font-medium text-sm border-b-2 transition-colors" 
                                            data-tab="loginLogs">
                                        <i class="fas fa-history mr-2"></i>Login Logs
                                    </button>
                                    <button onclick="switchUserManagementTab('userImport')" 
                                            class="user-mgmt-tab px-4 py-2 font-medium text-sm border-b-2 transition-colors" 
                                            data-tab="userImport">
                                        <i class="fas fa-file-import mr-2"></i>Import/Export
                                    </button>
                                </div>
                            </div>
                            
                            <!-- User List Tab -->
                            <div id="userListTab" class="user-mgmt-content">
                                <div class="mb-4">
                                    <div class="flex justify-between items-center mb-4">
                                        <div class="flex gap-4">
                                            <input type="text" id="userSearchInput" placeholder="Search users..." 
                                                   class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                   oninput="filterUsers()">
                                            <select id="userRoleFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                    onchange="filterUsers()">
                                                <option value="">All Roles</option>
                                                <option value="admin">Admin</option>
                                                <option value="chief">Chief</option>
                                                <option value="strategy">Strategy</option>
                                                <option value="operations">Operations</option>
                                                <option value="ppm">PPM</option>
                                                <option value="finance">Finance</option>
                                                <option value="bpt">BPT</option>
                                                <option value="procurement">Procurement</option>
                                                <option value="warehouse">Warehouse</option>
                                                <option value="ppr">PPR</option>
                                                <option value="academy">Academy</option>
                                            </select>
                                            <select id="userStatusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                    onchange="filterUsers()">
                                                <option value="">All Status</option>
                                                <option value="active">Active</option>
                                                <option value="inactive">Inactive</option>
                                            </select>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="syncUsersFromGoogleSheets()" 
                                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                                <i class="fas fa-sync mr-2"></i>Sync from Google Sheets
                                            </button>
                                            <button onclick="refreshUserList()" 
                                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                                <i class="fas fa-refresh mr-2"></i>Refresh
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- User Statistics -->
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                            <div class="text-2xl font-bold text-blue-600" id="totalUsersCount">0</div>
                                            <div class="text-sm text-blue-600">Total Users</div>
                                        </div>
                                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                            <div class="text-2xl font-bold text-green-600" id="activeUsersCount">0</div>
                                            <div class="text-sm text-green-600">Active Users</div>
                                        </div>
                                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                            <div class="text-2xl font-bold text-red-600" id="inactiveUsersCount">0</div>
                                            <div class="text-sm text-red-600">Inactive Users</div>
                                        </div>
                                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                            <div class="text-2xl font-bold text-purple-600" id="adminUsersCount">0</div>
                                            <div class="text-sm text-purple-600">Admin Users</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Users Table -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-white border border-gray-300 rounded-lg">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Login</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody" class="divide-y divide-gray-200">
                                            <!-- Users will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pagination -->
                                <div class="flex justify-between items-center mt-4">
                                    <div class="text-sm text-gray-700">
                                        Showing <span id="userShowingStart">0</span> to <span id="userShowingEnd">0</span> of <span id="userTotalCount">0</span> users
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="userPrevBtn" onclick="changeUserPage(-1)" 
                                                class="px-3 py-1 border border-gray-300 rounded text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                            Previous
                                        </button>
                                        <span id="userPageInfo" class="px-3 py-1 text-gray-600">Page 1 of 1</span>
                                        <button id="userNextBtn" onclick="changeUserPage(1)" 
                                                class="px-3 py-1 border border-gray-300 rounded text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                            Next
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Add User Tab -->
                            <div id="addUserTab" class="user-mgmt-content hidden">
                                <div class="max-w-2xl">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                                            <input type="text" id="newUserName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                   placeholder="Enter full name">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                            <input type="email" id="newUserEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                   placeholder="Enter email address">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                                            <div class="relative">
                                                <input type="password" id="newUserPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-10" 
                                                       placeholder="Enter password">
                                                <button type="button" onclick="togglePasswordVisibility('newUserPassword')" 
                                                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                                            <select id="newUserRole" onchange="onNewUserRoleChange()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                <option value="">Select Role</option>
                                                <option value="admin">Admin</option>
                                                <option value="chief">Chief</option>
                                                <option value="strategy">Strategy</option>
                                                <option value="operations">Operations</option>
                                                <option value="ppm">PPM</option>
                                                <option value="finance">Finance</option>
                                                <option value="bpt">BPT</option>
                                                <option value="procurement">Procurement</option>
                                                <option value="warehouse">Warehouse</option>
                                                <option value="ppr">PPR</option>
                                                <option value="academy">Academy</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                                            <select id="newUserStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                <option value="active">Active</option>
                                                <option value="inactive">Inactive</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Employee ID</label>
                                            <input type="text" id="newUserEmployeeId" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                   placeholder="Enter employee ID (optional)">
                                        </div>
                                    </div>
                                    
                                    <div class="mt-6">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                                        <textarea id="newUserNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                  placeholder="Additional notes about the user (optional)"></textarea>
                                    </div>
                                    
                                    <!-- Department Access Permissions -->
                                    <div class="mt-6">
                                        <h4 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                                            <i class="fas fa-key mr-2 text-blue-600"></i>
                                            Department Access Permissions
                                        </h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 p-4 bg-gray-50 rounded-lg border" id="newUserDepartmentAccess">
                                            <div class="text-gray-500 text-center col-span-full py-8">
                                                Please select a role first to see department access options
                                            </div>
                                        </div>
                                        <div class="mt-3 flex gap-2">
                                            <button type="button" onclick="selectAllNewUserDepartments()" 
                                                    class="px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                                                <i class="fas fa-check-double mr-1"></i>All
                                            </button>
                                            <button type="button" onclick="deselectAllNewUserDepartments()" 
                                                    class="px-3 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                                                <i class="fas fa-times mr-1"></i>None
                                            </button>
                                            <button type="button" onclick="resetNewUserToRoleDefaults()" 
                                                    class="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                                                <i class="fas fa-undo mr-1"></i>Role Defaults
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="flex gap-4 mt-6">
                                        <button onclick="addNewUser()" 
                                                class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                            <i class="fas fa-user-plus mr-2"></i>Add User
                                        </button>
                                        <button onclick="clearAddUserForm()" 
                                                class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                            <i class="fas fa-times mr-2"></i>Clear Form
                                        </button>
                                        <button onclick="generateRandomPassword()" 
                                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                            <i class="fas fa-random mr-2"></i>Generate Password
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Login Logs Tab -->
                            <div id="loginLogsTab" class="user-mgmt-content hidden">
                                <div class="mb-4">
                                    <div class="flex justify-between items-center mb-4">
                                        <div class="flex gap-4">
                                            <input type="text" id="logSearchInput" placeholder="Search by user or IP..." 
                                                   class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                   oninput="filterLoginLogs()">
                                            <select id="logTypeFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                    onchange="filterLoginLogs()">
                                                <option value="">All Events</option>
                                                <option value="login">Login</option>
                                                <option value="logout">Logout</option>
                                                <option value="failed_login">Failed Login</option>
                                            </select>
                                            <input type="date" id="logDateFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                   onchange="filterLoginLogs()">
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="exportLoginLogs()" 
                                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                                <i class="fas fa-download mr-2"></i>Export Logs
                                            </button>
                                            <button onclick="clearLoginLogs()" 
                                                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                                <i class="fas fa-trash mr-2"></i>Clear Logs
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Login Logs Table -->
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-white border border-gray-300 rounded-lg">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User Agent</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                                            </tr>
                                        </thead>
                                        <tbody id="loginLogsTableBody" class="divide-y divide-gray-200">
                                            <!-- Login logs will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Logs Pagination -->
                                <div class="flex justify-between items-center mt-4">
                                    <div class="text-sm text-gray-700">
                                        Showing <span id="logShowingStart">0</span> to <span id="logShowingEnd">0</span> of <span id="logTotalCount">0</span> logs
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="logPrevBtn" onclick="changeLogPage(-1)" 
                                                class="px-3 py-1 border border-gray-300 rounded text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                            Previous
                                        </button>
                                        <span id="logPageInfo" class="px-3 py-1 text-gray-600">Page 1 of 1</span>
                                        <button id="logNextBtn" onclick="changeLogPage(1)" 
                                                class="px-3 py-1 border border-gray-300 rounded text-gray-600 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                            Next
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Import/Export Tab -->
                            <div id="userImportTab" class="user-mgmt-content hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Import Users -->
                                    <div class="p-6 border border-gray-300 rounded-lg">
                                        <h4 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                                            <i class="fas fa-upload mr-2 text-green-600"></i>Import Users
                                        </h4>
                                        <div class="space-y-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Import from Google Sheets</label>
                                                <div class="flex gap-2">
                                                    <input type="url" id="googleSheetsUrl" placeholder="Google Sheets CSV URL" 
                                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                    <button onclick="importFromGoogleSheets()" 
                                                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                                        <i class="fas fa-sync mr-2"></i>Import
                                                    </button>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Import from CSV File</label>
                                                <input type="file" id="userCsvFile" accept=".csv" 
                                                       class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                                                <button onclick="importUsersFromCsv()" 
                                                        class="mt-2 w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                                    <i class="fas fa-upload mr-2"></i>Import CSV
                                                </button>
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                <p><strong>CSV Format:</strong> Name, Email, Status, Role, Date, Manager, EmployeeID, Password</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Export Users -->
                                    <div class="p-6 border border-gray-300 rounded-lg">
                                        <h4 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                                            <i class="fas fa-download mr-2 text-blue-600"></i>Export Users
                                        </h4>
                                        <div class="space-y-4">
                                            <button onclick="exportUsersToJson()" 
                                                    class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                                <i class="fas fa-download mr-2"></i>Export as JSON
                                            </button>
                                            <button onclick="exportUsersToCsv()" 
                                                    class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                                <i class="fas fa-file-csv mr-2"></i>Export as CSV
                                            </button>
                                            <button onclick="exportUsersToGoogleSheets()" 
                                                    class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                                <i class="fas fa-external-link-alt mr-2"></i>Generate Google Sheets Format
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Sync Status -->
                                <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <h5 class="font-medium text-yellow-800 mb-2">Sync Information</h5>
                                    <div class="text-sm text-yellow-700">
                                        <p><strong>Last Sync:</strong> <span id="lastSyncTime">Never</span></p>
                                        <p><strong>Google Sheets URL:</strong> <span id="currentGoogleSheetsUrl">Not configured</span></p>
                                        <p><strong>Local Users:</strong> <span id="localUsersCount">0</span></p>
                                        <p><strong>Note:</strong> Changes made here are stored locally. To sync with Google Sheets, use the import/export functions.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Configuration Export/Import -->
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-exchange-alt mr-2 text-purple-600"></i>
                                Configuration Backup & Restore
                            </h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Export Configuration -->
                                <div>
                                    <h4 class="text-lg font-medium text-gray-800 mb-4">Export Configuration:</h4>
                                    <button onclick="exportConfiguration()" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                        <i class="fas fa-download mr-2"></i>Download Configuration File
                                    </button>
                                    <p class="text-sm text-gray-600 mt-2">Download current access configuration as JSON file for backup</p>
                                </div>
                                
                                <!-- Import Configuration -->
                                <div>
                                    <h4 class="text-lg font-medium text-gray-800 mb-4">Import Configuration:</h4>
                                    <input type="file" id="configImportFile" accept=".json" class="mb-2 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                                    <button onclick="importConfiguration()" class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                                        <i class="fas fa-upload mr-2"></i>Import Configuration File
                                    </button>
                                    <p class="text-sm text-gray-600 mt-2">Import previously exported configuration file</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentUserRole = null;
        let currentUserName = null;
        let currentSelectedRole = null;
        
        // Global tabs definition
        let allTabs = [
            { id: 'operations', name: 'Operations', icon: 'fas fa-cogs' },
            { id: 'ppm', name: 'PPM', icon: 'fas fa-chart-line' },
            { id: 'strategy', name: 'Strategy', icon: 'fas fa-chess' },
            { id: 'finance', name: 'Finance', icon: 'fas fa-dollar-sign' },
            { id: 'bpt', name: 'BPT', icon: 'fas fa-bullseye' },
            { id: 'procurement', name: 'Procurement', icon: 'fas fa-shopping-cart' },
            { id: 'warehouseApd', name: 'Warehouse APD', icon: 'fas fa-warehouse' },
            { id: 'ppr', name: 'PPR', icon: 'fas fa-sitemap' },
            { id: 'academy', name: 'Academy', icon: 'fas fa-graduation-cap' },
            { id: 'adminConfig', name: 'Admin Config', icon: 'fas fa-cogs' }
        ];
        
        // Default department access configuration
        let departmentAccessConfig = {
            admin: ['operations', 'ppm', 'strategy', 'finance', 'bpt', 'procurement', 'warehouseApd', 'ppr', 'academy', 'adminConfig'],
            chief: ['operations', 'ppm', 'strategy', 'finance', 'bpt', 'procurement', 'warehouseApd', 'ppr', 'academy'],
            strategy: ['ppm', 'strategy', 'operations'],
            operations: ['operations', 'warehouseApd'],
            ppm: ['ppm'],
            finance: ['finance'],
            bpt: ['bpt'],
            procurement: ['procurement'],
            warehouse: ['warehouseApd'],
            ppr: ['ppr'],
            academy: ['academy']
        };
        
        // User Management System Variables
        let userManagementData = {
            users: [],
            filteredUsers: [],
            loginLogs: [],
            filteredLogs: [],
            currentUserPage: 1,
            currentLogPage: 1,
            usersPerPage: 10,
            logsPerPage: 20,
            googleSheetsUrl: 'https://docs.google.com/spreadsheets/d/1_ve_N74hK1KBMk_Rz_jVDRuLn_kDk13FUROkeNKR5P4/export?format=csv'
        };
        
        // Load configuration from localStorage if available
        function loadConfiguration() {
            const savedConfig = localStorage.getItem('departmentAccessConfig');
            if (savedConfig) {
                try {
                    departmentAccessConfig = JSON.parse(savedConfig);
                    console.log('✅ Configuration loaded from localStorage');
                } catch (error) {
                    console.error('❌ Error loading configuration from localStorage:', error);
                }
            }
            
            // Load user management data
            const savedUsers = localStorage.getItem('userManagementData');
            if (savedUsers) {
                try {
                    userManagementData = JSON.parse(savedUsers);
                    console.log('✅ User management data loaded from localStorage');
                } catch (error) {
                    console.error('❌ Error loading user management data:', error);
                }
            }
            
            // Load login logs
            const savedLogs = localStorage.getItem('loginLogs');
            if (savedLogs) {
                try {
                    userManagementData.loginLogs = JSON.parse(savedLogs);
                    console.log('✅ Login logs loaded from localStorage');
                } catch (error) {
                    console.error('❌ Error loading login logs:', error);
                }
            }
        }
        
        // Save configuration to localStorage
        function saveConfiguration() {
            try {
                localStorage.setItem('departmentAccessConfig', JSON.stringify(departmentAccessConfig));
                console.log('✅ Configuration saved to localStorage');
                return true;
            } catch (error) {
                console.error('❌ Error saving configuration to localStorage:', error);
                return false;
            }
        }
        
        // Save user management data
        function saveUserManagementData() {
            try {
                localStorage.setItem('userManagementData', JSON.stringify(userManagementData));
                localStorage.setItem('loginLogs', JSON.stringify(userManagementData.loginLogs));
                console.log('✅ User management data saved to localStorage');
                return true;
            } catch (error) {
                console.error('❌ Error saving user management data:', error);
                return false;
            }
        }
        
        // Log user activity
        function logUserActivity(email, eventType, details = {}) {
            const logEntry = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                timestamp: new Date().toISOString(),
                email: email,
                eventType: eventType, // 'login', 'logout', 'failed_login', 'password_change', etc.
                ipAddress: details.ipAddress || 'Unknown',
                userAgent: details.userAgent || navigator.userAgent,
                details: details
            };
            
            userManagementData.loginLogs.unshift(logEntry); // Add to beginning of array
            
            // Keep only last 1000 logs to prevent excessive storage
            if (userManagementData.loginLogs.length > 1000) {
                userManagementData.loginLogs = userManagementData.loginLogs.slice(0, 1000);
            }
            
            saveUserManagementData();
            console.log('📝 User activity logged:', logEntry);
        }

        // Enhanced Authentication System
        async function authenticateUser(email, password) {
            try {
                // Get user IP for logging
                const userIP = await getUserIP();
                
                // First check local user management system
                const localUser = userManagementData.users.find(u => 
                    u.email === email.toLowerCase() && 
                    u.password === password && 
                    u.status === 'active'
                );
                
                if (localUser) {
                    // Update user login statistics
                    localUser.lastLogin = new Date().toISOString();
                    localUser.loginCount = (localUser.loginCount || 0) + 1;
                    saveUserManagementData();
                    
                    // Log successful login
                    logUserActivity(localUser.email, 'login', {
                        ipAddress: userIP,
                        loginCount: localUser.loginCount,
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString()
                    });
                    
                    console.log('✅ Local user authenticated:', localUser.email);
                    return { email: localUser.email, role: localUser.role, name: localUser.name };
                }
                
                // Fallback to Google Sheets authentication
                console.log('🔄 Checking Google Sheets authentication...');
                const response = await fetch('https://docs.google.com/spreadsheets/d/1_ve_N74hK1KBMk_Rz_jVDRuLn_kDk13FUROkeNKR5P4/export?format=csv');
                const csvData = await response.text();
                
                const lines = csvData.trim().split('\n');
                
                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i].split(',');
                    const userEmail = row[0]?.trim().toLowerCase();
                    const status = row[1]?.trim();
                    const role = row[2]?.trim();
                    const userPassword = row[6]?.trim();
                    const userName = row[0]?.trim(); // Assuming first column has name
                    
                    if (userEmail === email.toLowerCase() && 
                        userPassword === password && 
                        status.toLowerCase() === 'active') {
                        
                        // Log successful login from Google Sheets user
                        logUserActivity(userEmail, 'login', {
                            ipAddress: userIP,
                            source: 'google_sheets',
                            userAgent: navigator.userAgent,
                            timestamp: new Date().toISOString()
                        });
                        
                        console.log('✅ Google Sheets user authenticated:', userEmail);
                        return { email: userEmail, role: role, name: userName };
                    }
                }
                
                // Log failed login attempt
                logUserActivity(email, 'failed_login', {
                    ipAddress: userIP,
                    reason: 'invalid_credentials',
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                });
                
                return null;
            } catch (error) {
                console.error('Authentication error:', error);
                
                // Log authentication error
                const userIP = await getUserIP();
                logUserActivity(email, 'failed_login', {
                    ipAddress: userIP,
                    reason: 'authentication_error',
                    error: error.message,
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                });
                
                return null;
            }
        }

        // Login Form Handler
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const loginButton = document.getElementById('loginButton');
            const loginButtonContent = document.getElementById('loginButtonContent');
            const loginLoadingContent = document.getElementById('loginLoadingContent');
            
            errorMessage.classList.add('hidden');
            
            if (!email || !password) {
                errorText.textContent = 'Please enter both email and password.';
                errorMessage.classList.remove('hidden');
                return;
            }
            
            // Show loading state
            loginButton.disabled = true;
            loginButtonContent.classList.add('hidden');
            loginLoadingContent.classList.remove('hidden');
            
            try {
                const user = await authenticateUser(email, password);
                
                if (user) {
                    currentUser = user.email;
                    currentUserRole = user.role;
                    currentUserName = user.name;
                    showDashboard();
                } else {
                    // Hide loading state on error
                    loginButton.disabled = false;
                    loginButtonContent.classList.remove('hidden');
                    loginLoadingContent.classList.add('hidden');
                    
                    errorText.textContent = 'Invalid credentials. Please check your email and password.';
                    errorMessage.classList.remove('hidden');
                }
            } catch (error) {
                // Hide loading state on error
                loginButton.disabled = false;
                loginButtonContent.classList.remove('hidden');
                loginLoadingContent.classList.add('hidden');
                
                errorText.textContent = 'Authentication failed. Please try again.';
                errorMessage.classList.remove('hidden');
            }
        });

        // Get User IP Address
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error('Error getting IP:', error);
                return 'N/A';
            }
        }

        // Show Dashboard
        async function showDashboard() {
            // Load configuration first
            loadConfiguration();
            
            // Store login time for session tracking
            localStorage.setItem('loginTime', Date.now());
            
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            document.getElementById('userEmail').textContent = currentUser;
            document.getElementById('userRole').textContent = currentUserRole;
            
            // Get and display user IP
            const userIP = await getUserIP();
            document.getElementById('userIP').textContent = userIP;
            
            generateTabs();
            setDefaultTab();
        }

        // Generate Tabs Based on Role
        function generateTabs() {
            const tabNavigation = document.getElementById('tabNavigation');
            tabNavigation.innerHTML = '';
            
            // Load custom tabs from localStorage
            const savedTabs = localStorage.getItem('customTabs');
            if (savedTabs) {
                try {
                    const customTabs = JSON.parse(savedTabs);
                    // Add custom tabs to the default tabs (avoid duplicates)
                    customTabs.forEach(customTab => {
                        if (!allTabs.find(tab => tab.id === customTab.id)) {
                            allTabs.push(customTab);
                        }
                    });
                } catch (error) {
                    console.error('❌ Error loading custom tabs:', error);
                }
            }
            
            const accessibleTabs = getAccessibleTabs();
            
            allTabs.forEach(tab => {
                if (accessibleTabs.includes(tab.id)) {
                    const button = document.createElement('button');
                    button.className = 'tab-button tab-compact px-4 py-2';
                    button.onclick = () => showTab(tab.id);
                    button.innerHTML = `<i class="${tab.icon} mr-2"></i>${tab.name}`;
                    tabNavigation.appendChild(button);
                }
            });
        }

        // Get Accessible Tabs Based on User-Level Permissions
        function getAccessibleTabs() {
            const role = currentUserRole?.toLowerCase();
            
            // First, try to find user-specific permissions
            const user = userManagementData.users.find(u => u.email === currentUser?.toLowerCase());
            if (user && user.departmentAccess && user.departmentAccess.length > 0) {
                console.log(`✅ Using user-level permissions for ${user.email}:`, user.departmentAccess);
                return user.departmentAccess;
            }
            
            // Fall back to role-based configuration
            if (departmentAccessConfig[role]) {
                console.log(`✅ Using role-based permissions for ${role}:`, departmentAccessConfig[role]);
                return departmentAccessConfig[role];
            }
            
            // Fallback to default configuration for backward compatibility
            console.log(`⚠️ Using fallback permissions for ${role}`);
            switch (role) {
                case 'admin':
                    return ['operations', 'ppm', 'strategy', 'finance', 'bpt', 'procurement', 'warehouseApd', 'ppr', 'academy', 'adminConfig'];
                case 'chief':
                    return ['operations', 'ppm', 'strategy', 'finance', 'bpt', 'procurement', 'warehouseApd', 'ppr', 'academy'];
                case 'strategy':
                    return ['ppm', 'strategy', 'operations'];
                case 'operation':
                case 'operations':
                    return ['operations', 'warehouseApd'];
                case 'ppm':
                    return ['ppm'];
                case 'finance':
                    return ['finance'];
                case 'bpt':
                    return ['bpt'];
                case 'procurement':
                    return ['procurement'];
                case 'warehouse':
                case 'warehouseapd':
                    return ['warehouseApd'];
                case 'ppr':
                    return ['ppr'];
                case 'academy':
                    return ['academy'];
                default:
                    return ['operations'];
            }
        }

        // Set Default Tab
        function setDefaultTab() {
            const role = currentUserRole?.toLowerCase();
            let defaultTab = 'operations';
            
            if (role === 'strategy') {
                defaultTab = 'strategy';
            } else if (role === 'ppm') {
                defaultTab = 'ppm';
            } else if (role === 'finance') {
                defaultTab = 'finance';
            } else if (role === 'bpt') {
                defaultTab = 'bpt';
            } else if (role === 'procurement') {
                defaultTab = 'procurement';
            } else if (role === 'warehouse' || role === 'warehouseapd') {
                defaultTab = 'warehouseApd';
            } else if (role === 'ppr') {
                defaultTab = 'ppr';
            } else if (role === 'academy') {
                defaultTab = 'academy';
            }
            
            showTab(defaultTab);
        }

        // Show Tab Content
        function showTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            const content = document.getElementById(tabId + 'Content');
            if (content) {
                content.classList.remove('hidden');
            }
            
            // Initialize admin config tab if needed
            if (tabId === 'adminConfig' && currentUserRole?.toLowerCase() === 'admin') {
                updateCurrentDepartmentsList();
                // Initialize user management tab if not already done
                if (userManagementData.users.length === 0) {
                    syncUsersFromGoogleSheets();
                }
                switchUserManagementTab('userList');
            }
            
            // Add active class to selected tab
            event?.target?.classList.add('active');
            
            // If no event target, find and activate the tab button
            if (!event?.target) {
                const buttons = document.querySelectorAll('.tab-button');
                buttons.forEach(button => {
                    if (button.textContent.toLowerCase().includes(tabId.toLowerCase()) || 
                        (tabId === 'adminConfig' && button.textContent.toLowerCase().includes('admin config'))) {
                        button.classList.add('active');
                    }
                });
            }
        }

        // Finance Subtab Functions
        function showFinanceSubtab(subtabId) {
            // Hide all finance subtabs
            document.querySelectorAll('.finance-subtab').forEach(subtab => {
                subtab.classList.add('hidden');
            });
            
            // Remove active class from all finance subtab buttons
            document.querySelectorAll('#financeContent .subtab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected subtab
            const subtabMap = {
                'gd-analysis': 'gdAnalysisSubtab',
                'coretax': 'coretaxSubtab',
                'payment': 'paymentSubtab',
                'd365-sync': 'd365SyncSubtab'
            };
            
            const targetSubtab = document.getElementById(subtabMap[subtabId]);
            if (targetSubtab) {
                targetSubtab.classList.remove('hidden');
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // PPM Subtab Functions
        function showPpmSubtab(subtabId) {
            // Hide all PPM subtabs
            document.querySelectorAll('.ppm-subtab').forEach(subtab => {
                subtab.classList.add('hidden');
            });
            
            // Remove active class from all PPM subtab buttons
            document.querySelectorAll('#ppmContent .subtab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected subtab
            const subtabMap = {
                'dashboard': 'ppmDashboardSubtab',
                'payroll-ledger': 'payrollLedgerSubtab',
                'lateness-report': 'latenessReportSubtab',
                'kpj-bpjs': 'kpjBpjsSubtab',
                'tes-kesehatan': 'tesKesehatanSubtab',
                'salary-calculator': 'salaryCalculatorSubtab'
            };
            
            const targetSubtab = document.getElementById(subtabMap[subtabId]);
            if (targetSubtab) {
                targetSubtab.classList.remove('hidden');
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Strategy Subtab Functions
        function showStrategySubtab(subtabId) {
            // Hide all Strategy subtabs
            document.querySelectorAll('.strategy-subtab').forEach(subtab => {
                subtab.classList.add('hidden');
            });
            
            // Remove active class from all Strategy subtab buttons
            document.querySelectorAll('#strategyContent .subtab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected subtab
            const subtabMap = {
                'dashboard': 'strategyDashboardSubtab',
                'phoenix-okr': 'phoenixOkrSubtab'
            };
            
            const targetSubtab = document.getElementById(subtabMap[subtabId]);
            if (targetSubtab) {
                targetSubtab.classList.remove('hidden');
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Operations Subtab Functions
        function showOperationsSubtab(subtabId) {
            // Hide all Operations subtabs
            document.querySelectorAll('.operations-subtab').forEach(subtab => {
                subtab.classList.add('hidden');
            });
            
            // Remove active class from all Operations subtab buttons
            document.querySelectorAll('#operationsContent .subtab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected subtab
            const subtabMap = {
                'outlet-dashboard': 'outletDashboardSubtab',
                'opps-ed-project': 'oppsEdProjectSubtab',
                'am-performance-tracker': 'amPerformanceTrackerSubtab'
            };
            
            const targetSubtab = document.getElementById(subtabMap[subtabId]);
            if (targetSubtab) {
                targetSubtab.classList.remove('hidden');
            }
            
            // Load AM tracker data if AM Performance Tracker is selected
            if (subtabId === 'am-performance-tracker') {
                // Only load data if not already loaded or if data is empty
                if (!amTracker.performanceData || amTracker.performanceData.length === 0) {
                    amTracker.fetchData();
                }
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Utility Functions
        function openInNewTab(url) {
            window.open(url, '_blank');
        }

        async function logout() {
            // Log logout event
            if (currentUser) {
                const userIP = await getUserIP();
                logUserActivity(currentUser, 'logout', {
                    ipAddress: userIP,
                    userAgent: navigator.userAgent,
                    sessionDuration: Date.now() - (localStorage.getItem('loginTime') || Date.now()),
                    timestamp: new Date().toISOString()
                });
            }
            
            // Clear session data
            currentUser = null;
            currentUserRole = null;
            currentUserName = null;
            localStorage.removeItem('loginTime');
            
            // Reset UI
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // User Management Functions
        function switchUserManagementTab(tabName) {
            // Remove active class from all tabs
            document.querySelectorAll('.user-mgmt-tab').forEach(tab => {
                tab.classList.remove('active', 'border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });
            
            // Hide all tab contents
            document.querySelectorAll('.user-mgmt-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show selected tab
            const selectedTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedTab) {
                selectedTab.classList.add('active', 'border-blue-500', 'text-blue-600');
                selectedTab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            }
            
            const contentElement = document.getElementById(tabName + 'Tab');
            if (contentElement) {
                contentElement.classList.remove('hidden');
            }
            
            // Initialize tab-specific data
            if (tabName === 'userList') {
                refreshUserList();
                populateUserAccessSelect(); // Ensure user access dropdown is populated
            } else if (tabName === 'loginLogs') {
                refreshLoginLogs();
            } else if (tabName === 'userImport') {
                updateSyncInformation();
            }
        }
        
        async function syncUsersFromGoogleSheets() {
            try {
                showConfigStatus('Syncing users from Google Sheets...', 'info');
                
                const response = await fetch(userManagementData.googleSheetsUrl);
                const csvData = await response.text();
                
                const users = parseUsersFromCsv(csvData);
                userManagementData.users = users;
                userManagementData.filteredUsers = [...users];
                
                saveUserManagementData();
                refreshUserList();
                updateUserStatistics();
                
                showConfigStatus(`Successfully synced ${users.length} users from Google Sheets`, 'success');
                
            } catch (error) {
                console.error('Error syncing users from Google Sheets:', error);
                showConfigStatus('Error syncing users from Google Sheets', 'error');
            }
        }
        
        function parseUsersFromCsv(csvData) {
            const lines = csvData.trim().split('\n');
            const users = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = parseCSVLine(line);
                if (values.length >= 8) {
                    const role = values[3]?.trim().toLowerCase() || 'user';
                    
                    // Get default department access for this role
                    const defaultDepartments = departmentAccessConfig[role] || ['operations'];
                    
                    const user = {
                        id: Date.now() + Math.random().toString(36).substr(2, 9),
                        name: values[0]?.trim() || '',
                        email: values[1]?.trim().toLowerCase() || '',
                        status: values[2]?.trim().toLowerCase() || 'active',
                        role: role,
                        dateAdded: values[4]?.trim() || new Date().toISOString().split('T')[0],
                        manager: values[5]?.trim() || '',
                        employeeId: values[6]?.trim() || '',
                        password: values[7]?.trim() || '',
                        // Add user-level department access
                        departmentAccess: [...defaultDepartments],
                        lastLogin: null,
                        loginCount: 0,
                        notes: '',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    if (user.email && user.name) {
                        users.push(user);
                    }
                }
            }
            
            return users;
        }
        
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current);
            return values;
        }
        
        function refreshUserList() {
            filterUsers();
            updateUserStatistics();
        }
        
        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput')?.value.toLowerCase() || '';
            const roleFilter = document.getElementById('userRoleFilter')?.value || '';
            const statusFilter = document.getElementById('userStatusFilter')?.value || '';
            
            userManagementData.filteredUsers = userManagementData.users.filter(user => {
                const matchesSearch = user.name.toLowerCase().includes(searchTerm) || 
                                    user.email.toLowerCase().includes(searchTerm);
                const matchesRole = !roleFilter || user.role === roleFilter;
                const matchesStatus = !statusFilter || user.status === statusFilter;
                
                return matchesSearch && matchesRole && matchesStatus;
            });
            
            userManagementData.currentUserPage = 1;
            displayUsers();
            updateUserPagination();
        }
        
        function displayUsers() {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const startIndex = (userManagementData.currentUserPage - 1) * userManagementData.usersPerPage;
            const endIndex = Math.min(startIndex + userManagementData.usersPerPage, userManagementData.filteredUsers.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const user = userManagementData.filteredUsers[i];
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => openUserEditModal(user);
                
                const statusColor = user.status === 'active' ? 'green' : 'red';
                const roleColor = user.role === 'admin' ? 'purple' : 'blue';
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-10 w-10 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white font-medium text-sm mr-3">
                                ${user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">${user.name}</div>
                                <div class="text-sm text-gray-500">${user.employeeId || 'No ID'}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${user.email}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${roleColor}-100 text-${roleColor}-800">
                            ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                            <i class="fas fa-${user.status === 'active' ? 'check' : 'times'} mr-1"></i>
                            ${user.status.charAt(0).toUpperCase() + user.status.slice(1)}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                        ${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                        <button onclick="event.stopPropagation(); openUserEditModal(userManagementData.filteredUsers[${startIndex + (i - startIndex)}])" 
                                class="text-blue-600 hover:text-blue-800 mr-3">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                        <button onclick="event.stopPropagation(); toggleUserStatus('${user.id}')" 
                                class="text-${user.status === 'active' ? 'red' : 'green'}-600 hover:text-${user.status === 'active' ? 'red' : 'green'}-800">
                            <i class="fas fa-${user.status === 'active' ? 'ban' : 'check'} mr-1"></i>
                            ${user.status === 'active' ? 'Disable' : 'Enable'}
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            }
        }
        
        function updateUserStatistics() {
            const totalUsers = userManagementData.users.length;
            const activeUsers = userManagementData.users.filter(u => u.status === 'active').length;
            const inactiveUsers = userManagementData.users.filter(u => u.status === 'inactive').length;
            const adminUsers = userManagementData.users.filter(u => u.role === 'admin').length;
            
            const totalElement = document.getElementById('totalUsersCount');
            const activeElement = document.getElementById('activeUsersCount');
            const inactiveElement = document.getElementById('inactiveUsersCount');
            const adminElement = document.getElementById('adminUsersCount');
            
            if (totalElement) totalElement.textContent = totalUsers;
            if (activeElement) activeElement.textContent = activeUsers;
            if (inactiveElement) inactiveElement.textContent = inactiveUsers;
            if (adminElement) adminElement.textContent = adminUsers;
        }
        
        function updateUserPagination() {
            const totalRecords = userManagementData.filteredUsers.length;
            const totalPages = Math.ceil(totalRecords / userManagementData.usersPerPage);
            const startIndex = (userManagementData.currentUserPage - 1) * userManagementData.usersPerPage + 1;
            const endIndex = Math.min(userManagementData.currentUserPage * userManagementData.usersPerPage, totalRecords);
            
            const startElement = document.getElementById('userShowingStart');
            const endElement = document.getElementById('userShowingEnd');
            const totalElement = document.getElementById('userTotalCount');
            const pageInfoElement = document.getElementById('userPageInfo');
            const prevBtn = document.getElementById('userPrevBtn');
            const nextBtn = document.getElementById('userNextBtn');
            
            if (startElement) startElement.textContent = totalRecords > 0 ? startIndex : 0;
            if (endElement) endElement.textContent = endIndex;
            if (totalElement) totalElement.textContent = totalRecords;
            if (pageInfoElement) pageInfoElement.textContent = `Page ${userManagementData.currentUserPage} of ${totalPages}`;
            
            if (prevBtn) prevBtn.disabled = userManagementData.currentUserPage === 1;
            if (nextBtn) nextBtn.disabled = userManagementData.currentUserPage === totalPages || totalPages === 0;
        }
        
        function changeUserPage(direction) {
            const totalPages = Math.ceil(userManagementData.filteredUsers.length / userManagementData.usersPerPage);
            
            if (direction === -1 && userManagementData.currentUserPage > 1) {
                userManagementData.currentUserPage--;
            } else if (direction === 1 && userManagementData.currentUserPage < totalPages) {
                userManagementData.currentUserPage++;
            }
            
            displayUsers();
            updateUserPagination();
        }
        
        function addNewUser() {
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            const status = document.getElementById('newUserStatus').value;
            const employeeId = document.getElementById('newUserEmployeeId').value.trim();
            const notes = document.getElementById('newUserNotes').value.trim();
            
            if (!name || !email || !password || !role) {
                showConfigStatus('Please fill in all required fields', 'error');
                return;
            }
            
            // Check if email already exists
            if (userManagementData.users.find(u => u.email === email.toLowerCase())) {
                showConfigStatus('A user with this email already exists', 'error');
                return;
            }
            
            // Get custom department access from user selections (or role defaults if none selected)
            const customDepartmentAccess = getCurrentNewUserDepartmentAccess();
            const departmentAccess = customDepartmentAccess.length > 0 ? customDepartmentAccess : (departmentAccessConfig[role] || ['operations']);
            
            const newUser = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                name: name,
                email: email.toLowerCase(),
                password: password,
                role: role,
                status: status,
                employeeId: employeeId,
                notes: notes,
                // Add department access with custom selections
                departmentAccess: [...departmentAccess],
                lastLogin: null,
                loginCount: 0,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            userManagementData.users.push(newUser);
            saveUserManagementData();
            
            // Log the user creation
            logUserActivity(currentUser, 'user_created', {
                targetUser: email,
                role: role,
                status: status,
                departmentAccess: departmentAccess
            });
            
            clearAddUserForm();
            refreshUserList();
            populateUserAccessSelect(); // Update the user access select dropdown
            showConfigStatus(`User ${name} added successfully with ${role} role defaults`, 'success');
        }
        
        function clearAddUserForm() {
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserEmail').value = '';
            document.getElementById('newUserPassword').value = '';
            document.getElementById('newUserRole').value = '';
            document.getElementById('newUserStatus').value = 'active';
            document.getElementById('newUserEmployeeId').value = '';
            document.getElementById('newUserNotes').value = '';
            
            // Clear department access
            const container = document.getElementById('newUserDepartmentAccess');
            container.innerHTML = '<div class="text-gray-500 text-center col-span-full py-8">Please select a role first to see department access options</div>';
        }
        
        // New User Department Access Functions
        function onNewUserRoleChange() {
            const role = document.getElementById('newUserRole').value;
            
            if (!role) {
                const container = document.getElementById('newUserDepartmentAccess');
                container.innerHTML = '<div class="text-gray-500 text-center col-span-full py-8">Please select a role first to see department access options</div>';
                return;
            }
            
            // Generate department checkboxes with role defaults
            generateNewUserDepartmentCheckboxes(role);
            
            showConfigStatus(`Role selected: ${role}. Department access loaded with role defaults.`, 'info');
        }
        
        function generateNewUserDepartmentCheckboxes(role) {
            const container = document.getElementById('newUserDepartmentAccess');
            container.innerHTML = '';
            
            const roleDefaults = departmentAccessConfig[role] || ['operations'];
            
            allTabs.forEach(tab => {
                if (tab.id === 'adminConfig' && role !== 'admin') return; // Admin config only for admin role
                
                const isRoleDefault = roleDefaults.includes(tab.id);
                
                const checkboxHtml = `
                    <div class="flex items-center p-3 border rounded-lg hover:bg-white transition-colors ${isRoleDefault ? 'bg-blue-50 border-blue-200' : 'bg-white'}">
                        <input type="checkbox" 
                               id="new_user_dept_${tab.id}" 
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" 
                               ${isRoleDefault ? 'checked' : ''}
                               onchange="updateNewUserDepartmentAccess('${tab.id}', this.checked)">
                        <label for="new_user_dept_${tab.id}" class="ml-3 flex items-center cursor-pointer flex-1">
                            <i class="${tab.icon} mr-2 text-gray-600"></i>
                            <div>
                                <span class="text-sm font-medium text-gray-700">${tab.name}</span>
                                ${isRoleDefault ? '<div class="text-xs text-blue-600">Role Default</div>' : ''}
                            </div>
                        </label>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', checkboxHtml);
            });
        }
        
        function updateNewUserDepartmentAccess(departmentId, hasAccess) {
            // This function doesn't need to do anything special since we'll read the checkboxes when saving
            console.log(`New user department access updated: ${departmentId} = ${hasAccess}`);
        }
        
        function getCurrentNewUserDepartmentAccess() {
            const checkboxes = document.querySelectorAll('#newUserDepartmentAccess input[type="checkbox"]:checked');
            const departmentIds = [];
            
            checkboxes.forEach(checkbox => {
                const departmentId = checkbox.id.replace('new_user_dept_', '');
                departmentIds.push(departmentId);
            });
            
            return departmentIds;
        }
        
        function selectAllNewUserDepartments() {
            const checkboxes = document.querySelectorAll('#newUserDepartmentAccess input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            
            showConfigStatus('All departments selected for new user', 'success');
        }
        
        function deselectAllNewUserDepartments() {
            const checkboxes = document.querySelectorAll('#newUserDepartmentAccess input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            showConfigStatus('All departments deselected for new user', 'info');
        }
        
        function resetNewUserToRoleDefaults() {
            const role = document.getElementById('newUserRole').value;
            if (!role) {
                showConfigStatus('Please select a role first', 'error');
                return;
            }
            
            // Regenerate checkboxes with role defaults
            generateNewUserDepartmentCheckboxes(role);
            
            showConfigStatus(`Reset to ${role} role defaults`, 'info');
        }
        
        function generateRandomPassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#$%';
            let password = '';
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('newUserPassword').value = password;
            showConfigStatus('Random password generated', 'success');
        }
        
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                button.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                button.className = 'fas fa-eye';
            }
        }
        
        function openUserEditModal(user) {
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserPassword').value = user.password;
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editUserStatus').value = user.status;
            document.getElementById('editUserEmployeeId').value = user.employeeId || '';
            document.getElementById('editUserNotes').value = user.notes || '';
            
            // Ensure user has department access (initialize if not exists)
            if (!user.departmentAccess) {
                user.departmentAccess = departmentAccessConfig[user.role] || ['operations'];
            }
            
            // Generate department access checkboxes for this user
            generateEditUserDepartmentCheckboxes(user);
            
            document.getElementById('userEditModal').classList.remove('hidden');
        }
        
        function closeUserEditModal() {
            document.getElementById('userEditModal').classList.add('hidden');
        }
        
        function saveUserChanges() {
            const userId = document.getElementById('editUserId').value;
            const name = document.getElementById('editUserName').value.trim();
            const email = document.getElementById('editUserEmail').value.trim();
            const password = document.getElementById('editUserPassword').value;
            const role = document.getElementById('editUserRole').value;
            const status = document.getElementById('editUserStatus').value;
            const employeeId = document.getElementById('editUserEmployeeId').value.trim();
            const notes = document.getElementById('editUserNotes').value.trim();
            
            if (!name || !email || !password || !role) {
                showConfigStatus('Please fill in all required fields', 'error');
                return;
            }
            
            const userIndex = userManagementData.users.findIndex(u => u.id === userId);
            if (userIndex === -1) {
                showConfigStatus('User not found', 'error');
                return;
            }
            
            // Check if email already exists (excluding current user)
            const existingUser = userManagementData.users.find(u => u.email === email.toLowerCase() && u.id !== userId);
            if (existingUser) {
                showConfigStatus('Another user with this email already exists', 'error');
                return;
            }
            
            const oldUser = {...userManagementData.users[userIndex]};
            
            // Get the current user being edited (with any department access changes)
            const currentEditUser = userManagementData.users.find(u => u.id === userId);
            const departmentAccess = currentEditUser?.departmentAccess || departmentAccessConfig[role] || ['operations'];
            
            userManagementData.users[userIndex] = {
                ...userManagementData.users[userIndex],
                name: name,
                email: email.toLowerCase(),
                password: password,
                role: role,
                status: status,
                employeeId: employeeId,
                notes: notes,
                departmentAccess: departmentAccess, // Save department access
                updatedAt: new Date().toISOString()
            };
            
            saveUserManagementData();
            
            // Log the user update
            logUserActivity(currentUser, 'user_updated', {
                targetUser: email,
                changes: {
                    name: oldUser.name !== name ? {from: oldUser.name, to: name} : null,
                    role: oldUser.role !== role ? {from: oldUser.role, to: role} : null,
                    status: oldUser.status !== status ? {from: oldUser.status, to: status} : null,
                    departmentAccess: JSON.stringify(oldUser.departmentAccess) !== JSON.stringify(departmentAccess) ? 
                        {from: oldUser.departmentAccess, to: departmentAccess} : null
                }
            });
            
            closeUserEditModal();
            refreshUserList();
            showConfigStatus(`User ${name} updated successfully`, 'success');
        }
        
        function deleteUser() {
            const userId = document.getElementById('editUserId').value;
            const userIndex = userManagementData.users.findIndex(u => u.id === userId);
            
            if (userIndex === -1) {
                showConfigStatus('User not found', 'error');
                return;
            }
            
            const user = userManagementData.users[userIndex];
            
            if (confirm(`Are you sure you want to delete user ${user.name} (${user.email})? This action cannot be undone.`)) {
                // Log the user deletion
                logUserActivity(currentUser, 'user_deleted', {
                    targetUser: user.email,
                    deletedUserData: {
                        name: user.name,
                        role: user.role,
                        status: user.status
                    }
                });
                
                userManagementData.users.splice(userIndex, 1);
                saveUserManagementData();
                
                closeUserEditModal();
                refreshUserList();
                showConfigStatus(`User ${user.name} deleted successfully`, 'success');
            }
        }
        
        function toggleUserStatus(userId) {
            const userIndex = userManagementData.users.findIndex(u => u.id === userId);
            if (userIndex === -1) return;
            
            const user = userManagementData.users[userIndex];
            const newStatus = user.status === 'active' ? 'inactive' : 'active';
            const oldStatus = user.status;
            
            userManagementData.users[userIndex].status = newStatus;
            userManagementData.users[userIndex].updatedAt = new Date().toISOString();
            
            saveUserManagementData();
            
            // Log the status change
            logUserActivity(currentUser, 'user_status_changed', {
                targetUser: user.email,
                statusChange: {from: oldStatus, to: newStatus}
            });
            
            refreshUserList();
            showConfigStatus(`User ${user.name} ${newStatus === 'active' ? 'enabled' : 'disabled'} successfully`, 'success');
        }
        
        // User Edit Modal Department Access Functions
        function generateEditUserDepartmentCheckboxes(user) {
            const container = document.getElementById('editUserDepartmentAccess');
            container.innerHTML = '';
            
            // Ensure user has department access array
            if (!user.departmentAccess) {
                user.departmentAccess = departmentAccessConfig[user.role] || ['operations'];
            }
            
            allTabs.forEach(tab => {
                if (tab.id === 'adminConfig' && user.role !== 'admin') return; // Admin config only for admin role
                
                const isChecked = user.departmentAccess.includes(tab.id);
                const isRoleDefault = (departmentAccessConfig[user.role] || []).includes(tab.id);
                
                const checkboxHtml = `
                    <div class="flex items-center p-3 border rounded-lg hover:bg-white transition-colors ${isRoleDefault ? 'bg-blue-50 border-blue-200' : 'bg-white'}">
                        <input type="checkbox" 
                               id="edit_user_dept_${tab.id}" 
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" 
                               ${isChecked ? 'checked' : ''}
                               onchange="updateEditUserDepartmentAccess('${tab.id}', this.checked)">
                        <label for="edit_user_dept_${tab.id}" class="ml-3 flex items-center cursor-pointer flex-1">
                            <i class="${tab.icon} mr-2 text-gray-600"></i>
                            <div>
                                <span class="text-sm font-medium text-gray-700">${tab.name}</span>
                                ${isRoleDefault ? '<div class="text-xs text-blue-600">Role Default</div>' : ''}
                            </div>
                        </label>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', checkboxHtml);
            });
        }
        
        function onEditUserRoleChange() {
            const userId = document.getElementById('editUserId').value;
            const newRole = document.getElementById('editUserRole').value;
            
            // Find the current user being edited
            const user = userManagementData.users.find(u => u.id === userId);
            if (!user) return;
            
            // Update the user's role temporarily for UI purposes
            user.role = newRole;
            
            // Update role defaults but keep any custom access
            if (!user.departmentAccess || user.departmentAccess.length === 0) {
                user.departmentAccess = departmentAccessConfig[newRole] || ['operations'];
            }
            
            // Regenerate checkboxes with new role context
            generateEditUserDepartmentCheckboxes(user);
            
            showConfigStatus(`Role changed to ${newRole}. Department access updated to show role defaults.`, 'info');
        }
        
        function updateEditUserDepartmentAccess(departmentId, hasAccess) {
            const userId = document.getElementById('editUserId').value;
            const user = userManagementData.users.find(u => u.id === userId);
            if (!user) return;
            
            if (!user.departmentAccess) {
                user.departmentAccess = [];
            }
            
            if (hasAccess) {
                if (!user.departmentAccess.includes(departmentId)) {
                    user.departmentAccess.push(departmentId);
                }
            } else {
                user.departmentAccess = user.departmentAccess.filter(id => id !== departmentId);
            }
            
            console.log(`Updated ${user.name} access:`, user.departmentAccess);
        }
        
        function selectAllEditUserDepartments() {
            const userId = document.getElementById('editUserId').value;
            const user = userManagementData.users.find(u => u.id === userId);
            if (!user) return;
            
            const checkboxes = document.querySelectorAll('#editUserDepartmentAccess input[type="checkbox"]');
            const allDepartmentIds = [];
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const departmentId = checkbox.id.replace('edit_user_dept_', '');
                allDepartmentIds.push(departmentId);
            });
            
            user.departmentAccess = [...new Set(allDepartmentIds)]; // Remove duplicates
            showConfigStatus('All departments selected for this user', 'success');
        }
        
        function deselectAllEditUserDepartments() {
            const userId = document.getElementById('editUserId').value;
            const user = userManagementData.users.find(u => u.id === userId);
            if (!user) return;
            
            const checkboxes = document.querySelectorAll('#editUserDepartmentAccess input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            user.departmentAccess = [];
            showConfigStatus('All departments deselected for this user', 'info');
        }
        
        function resetEditUserToRoleDefaults() {
            const userId = document.getElementById('editUserId').value;
            const user = userManagementData.users.find(u => u.id === userId);
            if (!user) return;
            
            const role = document.getElementById('editUserRole').value;
            const roleDefaults = departmentAccessConfig[role] || ['operations'];
            user.departmentAccess = [...roleDefaults];
            
            // Update checkboxes to reflect role defaults
            generateEditUserDepartmentCheckboxes(user);
            
            showConfigStatus(`Reset to ${role} role defaults`, 'info');
        }
        
        // Login Log Functions
        function refreshLoginLogs() {
            filterLoginLogs();
        }
        
        function filterLoginLogs() {
            const searchTerm = document.getElementById('logSearchInput')?.value.toLowerCase() || '';
            const typeFilter = document.getElementById('logTypeFilter')?.value || '';
            const dateFilter = document.getElementById('logDateFilter')?.value || '';
            
            userManagementData.filteredLogs = userManagementData.loginLogs.filter(log => {
                const matchesSearch = log.email.toLowerCase().includes(searchTerm) || 
                                    log.ipAddress.toLowerCase().includes(searchTerm);
                const matchesType = !typeFilter || log.eventType === typeFilter;
                const matchesDate = !dateFilter || log.timestamp.startsWith(dateFilter);
                
                return matchesSearch && matchesType && matchesDate;
            });
            
            userManagementData.currentLogPage = 1;
            displayLoginLogs();
            updateLogPagination();
        }
        
        function displayLoginLogs() {
            const tbody = document.getElementById('loginLogsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const startIndex = (userManagementData.currentLogPage - 1) * userManagementData.logsPerPage;
            const endIndex = Math.min(startIndex + userManagementData.logsPerPage, userManagementData.filteredLogs.length);
            
            for (let i = startIndex; i < endIndex; i++) {
                const log = userManagementData.filteredLogs[i];
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const eventColor = getEventColor(log.eventType);
                const eventIcon = getEventIcon(log.eventType);
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(log.timestamp).toLocaleString()}
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${log.email}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${eventColor}-100 text-${eventColor}-800">
                            <i class="fas fa-${eventIcon} mr-1"></i>
                            ${log.eventType.replace('_', ' ').toUpperCase()}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${log.ipAddress}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 max-w-xs truncate" title="${log.userAgent}">
                        ${log.userAgent}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500">
                        ${log.details ? Object.keys(log.details).map(key => `${key}: ${log.details[key]}`).join(', ') : '-'}
                    </td>
                `;
                
                tbody.appendChild(row);
            }
        }
        
        function getEventColor(eventType) {
            switch (eventType) {
                case 'login': return 'green';
                case 'logout': return 'blue';
                case 'failed_login': return 'red';
                case 'user_created': return 'purple';
                case 'user_updated': return 'yellow';
                case 'user_deleted': return 'red';
                case 'user_status_changed': return 'orange';
                default: return 'gray';
            }
        }
        
        function getEventIcon(eventType) {
            switch (eventType) {
                case 'login': return 'sign-in-alt';
                case 'logout': return 'sign-out-alt';
                case 'failed_login': return 'exclamation-triangle';
                case 'user_created': return 'user-plus';
                case 'user_updated': return 'user-edit';
                case 'user_deleted': return 'user-times';
                case 'user_status_changed': return 'user-check';
                default: return 'info-circle';
            }
        }
        
        function updateLogPagination() {
            const totalRecords = userManagementData.filteredLogs.length;
            const totalPages = Math.ceil(totalRecords / userManagementData.logsPerPage);
            const startIndex = (userManagementData.currentLogPage - 1) * userManagementData.logsPerPage + 1;
            const endIndex = Math.min(userManagementData.currentLogPage * userManagementData.logsPerPage, totalRecords);
            
            const startElement = document.getElementById('logShowingStart');
            const endElement = document.getElementById('logShowingEnd');
            const totalElement = document.getElementById('logTotalCount');
            const pageInfoElement = document.getElementById('logPageInfo');
            const prevBtn = document.getElementById('logPrevBtn');
            const nextBtn = document.getElementById('logNextBtn');
            
            if (startElement) startElement.textContent = totalRecords > 0 ? startIndex : 0;
            if (endElement) endElement.textContent = endIndex;
            if (totalElement) totalElement.textContent = totalRecords;
            if (pageInfoElement) pageInfoElement.textContent = `Page ${userManagementData.currentLogPage} of ${totalPages}`;
            
            if (prevBtn) prevBtn.disabled = userManagementData.currentLogPage === 1;
            if (nextBtn) nextBtn.disabled = userManagementData.currentLogPage === totalPages || totalPages === 0;
        }
        
        function changeLogPage(direction) {
            const totalPages = Math.ceil(userManagementData.filteredLogs.length / userManagementData.logsPerPage);
            
            if (direction === -1 && userManagementData.currentLogPage > 1) {
                userManagementData.currentLogPage--;
            } else if (direction === 1 && userManagementData.currentLogPage < totalPages) {
                userManagementData.currentLogPage++;
            }
            
            displayLoginLogs();
            updateLogPagination();
        }
        
        function exportLoginLogs() {
            const logs = userManagementData.filteredLogs.map(log => ({
                timestamp: log.timestamp,
                email: log.email,
                eventType: log.eventType,
                ipAddress: log.ipAddress,
                userAgent: log.userAgent,
                details: JSON.stringify(log.details)
            }));
            
            const csvContent = [
                'Timestamp,Email,Event Type,IP Address,User Agent,Details',
                ...logs.map(log => 
                    `"${log.timestamp}","${log.email}","${log.eventType}","${log.ipAddress}","${log.userAgent}","${log.details}"`
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `login-logs-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showConfigStatus('Login logs exported successfully', 'success');
        }
        
        function clearLoginLogs() {
            if (confirm('Are you sure you want to clear all login logs? This action cannot be undone.')) {
                userManagementData.loginLogs = [];
                userManagementData.filteredLogs = [];
                saveUserManagementData();
                refreshLoginLogs();
                showConfigStatus('Login logs cleared successfully', 'success');
            }
        }
        
        // Import/Export Functions
        function updateSyncInformation() {
            const lastSyncElement = document.getElementById('lastSyncTime');
            const googleSheetsUrlElement = document.getElementById('currentGoogleSheetsUrl');
            const localUsersCountElement = document.getElementById('localUsersCount');
            
            if (lastSyncElement) {
                const lastSync = localStorage.getItem('lastSyncTime');
                lastSyncElement.textContent = lastSync ? new Date(lastSync).toLocaleString() : 'Never';
            }
            
            if (googleSheetsUrlElement) {
                googleSheetsUrlElement.textContent = userManagementData.googleSheetsUrl;
            }
            
            if (localUsersCountElement) {
                localUsersCountElement.textContent = userManagementData.users.length;
            }
        }
        
        function importFromGoogleSheets() {
            const url = document.getElementById('googleSheetsUrl').value.trim();
            if (!url) {
                showConfigStatus('Please enter a Google Sheets CSV URL', 'error');
                return;
            }
            
            userManagementData.googleSheetsUrl = url;
            syncUsersFromGoogleSheets();
            localStorage.setItem('lastSyncTime', new Date().toISOString());
            updateSyncInformation();
        }
        
        function importUsersFromCsv() {
            const fileInput = document.getElementById('userCsvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showConfigStatus('Please select a CSV file to import', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = e.target.result;
                    const users = parseUsersFromCsv(csvData);
                    
                    userManagementData.users = users;
                    userManagementData.filteredUsers = [...users];
                    
                    saveUserManagementData();
                    refreshUserList();
                    updateUserStatistics();
                    
                    showConfigStatus(`Successfully imported ${users.length} users from CSV`, 'success');
                    fileInput.value = '';
                    
                } catch (error) {
                    console.error('CSV import error:', error);
                    showConfigStatus(`Error importing CSV: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        function exportUsersToJson() {
            const data = {
                users: userManagementData.users,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `users-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showConfigStatus('Users exported as JSON successfully', 'success');
        }
        
        function exportUsersToCsv() {
            const csvContent = [
                'Name,Email,Status,Role,Date,Manager,Employee ID,Password',
                ...userManagementData.users.map(user => 
                    `"${user.name}","${user.email}","${user.status}","${user.role}","${user.dateAdded || ''}","${user.manager || ''}","${user.employeeId || ''}","${user.password}"`
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `users-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showConfigStatus('Users exported as CSV successfully', 'success');
        }
        
        function exportUsersToGoogleSheets() {
            const csvContent = [
                'Name,Email,Status,Role,Date,Manager,Employee ID,Password',
                ...userManagementData.users.map(user => 
                    `"${user.name}","${user.email}","${user.status}","${user.role}","${user.dateAdded || ''}","${user.manager || ''}","${user.employeeId || ''}","${user.password}"`
                )
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `google-sheets-format-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showConfigStatus('Google Sheets format CSV generated. Upload this to your Google Sheets and get the CSV export URL.', 'success');
        }

        // User-Level Department Access Management Functions
        let currentSelectedUser = null;
        
        function searchUsersForAccess() {
            const searchTerm = document.getElementById('userAccessSearch').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('userAccessSearchResults');
            const resultsList = document.getElementById('userAccessSearchList');
            
            if (searchTerm.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            const matchingUsers = userManagementData.users.filter(user => 
                user.name.toLowerCase().includes(searchTerm) || 
                user.email.toLowerCase().includes(searchTerm)
            );
            
            if (matchingUsers.length > 0) {
                resultsList.innerHTML = matchingUsers.map(user => `
                    <div class="p-2 hover:bg-gray-50 cursor-pointer border-b border-gray-200 last:border-b-0"
                         onclick="selectUserForAccessById('${user.id}')">
                        <div class="flex items-center">
                            <div class="h-8 w-8 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white font-medium text-xs mr-3">
                                ${user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()}
                            </div>
                            <div>
                                <div class="font-medium text-sm">${user.name}</div>
                                <div class="text-xs text-gray-500">${user.email} - ${user.role}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
                resultsContainer.classList.remove('hidden');
            } else {
                resultsList.innerHTML = '<div class="p-2 text-gray-500 text-sm">No users found</div>';
                resultsContainer.classList.remove('hidden');
            }
        }
        
        function populateUserAccessSelect() {
            const selectElement = document.getElementById('userAccessSelect');
            selectElement.innerHTML = '<option value="">Choose a user...</option>';
            
            userManagementData.users
                .sort((a, b) => a.name.localeCompare(b.name))
                .forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (${user.email}) - ${user.role}`;
                    selectElement.appendChild(option);
                });
        }
        
        function selectUserForAccess() {
            const selectElement = document.getElementById('userAccessSelect');
            const userId = selectElement.value;
            
            if (userId) {
                selectUserForAccessById(userId);
            }
        }
        
        function selectUserForAccessById(userId) {
            const user = userManagementData.users.find(u => u.id === userId);
            if (!user) return;
            
            currentSelectedUser = user;
            
            // Hide search results
            document.getElementById('userAccessSearchResults').classList.add('hidden');
            
            // Update user info display
            document.getElementById('selectedUserName').textContent = user.name;
            document.getElementById('selectedUserEmail').textContent = user.email;
            document.getElementById('selectedUserRole').textContent = user.role.toUpperCase();
            document.getElementById('selectedUserStatus').textContent = user.status.toUpperCase();
            
            // Show user department configuration
            document.getElementById('userDepartmentConfig').classList.remove('hidden');
            
            // Generate user-specific department checkboxes
            generateUserDepartmentCheckboxes(user);
            
            showConfigStatus(`Selected user: ${user.name} for department access configuration`, 'info');
        }
        
        function generateUserDepartmentCheckboxes(user) {
            const container = document.getElementById('userDepartmentCheckboxes');
            container.innerHTML = '';
            
            // Ensure user has department access array
            if (!user.departmentAccess) {
                user.departmentAccess = departmentAccessConfig[user.role] || ['operations'];
            }
            
            allTabs.forEach(tab => {
                if (tab.id === 'adminConfig' && user.role !== 'admin') return; // Admin config only for admin role
                
                const isChecked = user.departmentAccess.includes(tab.id);
                const isRoleDefault = (departmentAccessConfig[user.role] || []).includes(tab.id);
                
                const checkboxHtml = `
                    <div class="flex items-center p-3 border rounded-lg hover:bg-gray-50 transition-colors ${isRoleDefault ? 'bg-blue-50 border-blue-200' : ''}">
                        <input type="checkbox" 
                               id="user_dept_${tab.id}" 
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" 
                               ${isChecked ? 'checked' : ''}
                               onchange="updateUserDepartmentAccess('${tab.id}', this.checked)">
                        <label for="user_dept_${tab.id}" class="ml-3 flex items-center cursor-pointer flex-1">
                            <i class="${tab.icon} mr-2 text-gray-600"></i>
                            <div>
                                <span class="text-sm font-medium text-gray-700">${tab.name}</span>
                                ${isRoleDefault ? '<div class="text-xs text-blue-600">Role Default</div>' : ''}
                            </div>
                        </label>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', checkboxHtml);
            });
        }
        
        function updateUserDepartmentAccess(departmentId, hasAccess) {
            if (!currentSelectedUser) return;
            
            if (!currentSelectedUser.departmentAccess) {
                currentSelectedUser.departmentAccess = [];
            }
            
            if (hasAccess) {
                if (!currentSelectedUser.departmentAccess.includes(departmentId)) {
                    currentSelectedUser.departmentAccess.push(departmentId);
                }
            } else {
                currentSelectedUser.departmentAccess = currentSelectedUser.departmentAccess.filter(id => id !== departmentId);
            }
            
            console.log(`Updated ${currentSelectedUser.name} access:`, currentSelectedUser.departmentAccess);
        }
        
        function selectAllUserDepartments() {
            if (!currentSelectedUser) return;
            
            const checkboxes = document.querySelectorAll('#userDepartmentCheckboxes input[type="checkbox"]');
            const allDepartmentIds = [];
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const departmentId = checkbox.id.replace('user_dept_', '');
                allDepartmentIds.push(departmentId);
            });
            
            currentSelectedUser.departmentAccess = [...new Set(allDepartmentIds)]; // Remove duplicates
            showConfigStatus('All departments selected for this user', 'success');
        }
        
        function deselectAllUserDepartments() {
            if (!currentSelectedUser) return;
            
            const checkboxes = document.querySelectorAll('#userDepartmentCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            currentSelectedUser.departmentAccess = [];
            showConfigStatus('All departments deselected for this user', 'info');
        }
        
        function resetToRoleDefaults() {
            if (!currentSelectedUser) return;
            
            const roleDefaults = departmentAccessConfig[currentSelectedUser.role] || ['operations'];
            currentSelectedUser.departmentAccess = [...roleDefaults];
            
            // Update checkboxes to reflect role defaults
            generateUserDepartmentCheckboxes(currentSelectedUser);
            
            showConfigStatus(`Reset to ${currentSelectedUser.role} role defaults`, 'info');
        }
        
        function saveUserDepartmentAccess() {
            if (!currentSelectedUser) {
                showConfigStatus('Please select a user first', 'error');
                return;
            }
            
            // Find and update the user in the main array
            const userIndex = userManagementData.users.findIndex(u => u.id === currentSelectedUser.id);
            if (userIndex === -1) {
                showConfigStatus('User not found', 'error');
                return;
            }
            
            userManagementData.users[userIndex].departmentAccess = [...currentSelectedUser.departmentAccess];
            userManagementData.users[userIndex].updatedAt = new Date().toISOString();
            
            const success = saveUserManagementData();
            
            if (success) {
                showConfigStatus(`Department access saved successfully for ${currentSelectedUser.name}`, 'success');
                
                // Log the access change
                logUserActivity(currentUser, 'user_access_updated', {
                    targetUser: currentSelectedUser.email,
                    newAccess: currentSelectedUser.departmentAccess,
                    updatedBy: currentUser
                });
                
                // If current logged-in user's access was updated, refresh their tabs
                if (currentSelectedUser.email === currentUser) {
                    setTimeout(() => {
                        generateTabs();
                        showConfigStatus('Your dashboard tabs have been refreshed', 'info');
                    }, 1000);
                }
            } else {
                showConfigStatus('Error saving user access configuration', 'error');
            }
        }

        // Admin Configuration Functions
        function selectRole(role) {
            currentSelectedRole = role;
            
            // Update role selector UI
            document.querySelectorAll('.role-selector').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-50');
            });
            
            const selectedBtn = document.querySelector(`[data-role="${role}"]`);
            if (selectedBtn) {
                selectedBtn.classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-50');
                selectedBtn.classList.add('bg-blue-600', 'text-white');
            }
            
            // Show department configuration
            document.getElementById('departmentConfig').classList.remove('hidden');
            document.getElementById('selectedRoleName').textContent = role.charAt(0).toUpperCase() + role.slice(1);
            
            // Generate department checkboxes
            generateDepartmentCheckboxes(role);
            
            showConfigStatus(`Selected role: ${role}`, 'info');
        }
        
        function generateDepartmentCheckboxes(role) {
            const container = document.getElementById('departmentCheckboxes');
            container.innerHTML = '';
            
            const currentAccess = departmentAccessConfig[role] || [];
            
            allTabs.forEach(tab => {
                if (tab.id === 'adminConfig' && role !== 'admin') return; // Admin config only for admin role
                
                const isChecked = currentAccess.includes(tab.id);
                
                const checkboxHtml = `
                    <div class="flex items-center p-3 border rounded-lg hover:bg-gray-50 transition-colors">
                        <input type="checkbox" 
                               id="dept_${tab.id}" 
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" 
                               ${isChecked ? 'checked' : ''}
                               onchange="updateDepartmentAccess('${role}', '${tab.id}', this.checked)">
                        <label for="dept_${tab.id}" class="ml-3 flex items-center cursor-pointer flex-1">
                            <i class="${tab.icon} mr-2 text-gray-600"></i>
                            <span class="text-sm font-medium text-gray-700">${tab.name}</span>
                        </label>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', checkboxHtml);
            });
        }
        
        function updateDepartmentAccess(role, departmentId, hasAccess) {
            if (!departmentAccessConfig[role]) {
                departmentAccessConfig[role] = [];
            }
            
            if (hasAccess) {
                if (!departmentAccessConfig[role].includes(departmentId)) {
                    departmentAccessConfig[role].push(departmentId);
                }
            } else {
                departmentAccessConfig[role] = departmentAccessConfig[role].filter(id => id !== departmentId);
            }
            
            console.log(`Updated ${role} access:`, departmentAccessConfig[role]);
        }
        
        function selectAllDepartments() {
            if (!currentSelectedRole) return;
            
            const checkboxes = document.querySelectorAll('#departmentCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const departmentId = checkbox.id.replace('dept_', '');
                updateDepartmentAccess(currentSelectedRole, departmentId, true);
            });
            
            showConfigStatus('All departments selected', 'success');
        }
        
        function deselectAllDepartments() {
            if (!currentSelectedRole) return;
            
            const checkboxes = document.querySelectorAll('#departmentCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
                const departmentId = checkbox.id.replace('dept_', '');
                updateDepartmentAccess(currentSelectedRole, departmentId, false);
            });
            
            showConfigStatus('All departments deselected', 'info');
        }
        
        function saveRoleConfiguration() {
            if (!currentSelectedRole) {
                showConfigStatus('Please select a role first', 'error');
                return;
            }
            
            const success = saveConfiguration();
            
            if (success) {
                showConfigStatus(`Configuration saved successfully for ${currentSelectedRole} role`, 'success');
                
                // If current user's role was updated, refresh the tabs
                if (currentSelectedRole.toLowerCase() === currentUserRole?.toLowerCase()) {
                    setTimeout(() => {
                        generateTabs();
                        showConfigStatus('Dashboard tabs refreshed', 'info');
                    }, 1000);
                }
            } else {
                showConfigStatus('Error saving configuration', 'error');
            }
        }
        
        function addNewDepartment() {
            const id = document.getElementById('newDepartmentId').value.trim();
            const name = document.getElementById('newDepartmentName').value.trim();
            const icon = document.getElementById('newDepartmentIcon').value.trim();
            
            if (!id || !name || !icon) {
                showConfigStatus('Please fill in all fields for the new department', 'error');
                return;
            }
            
            // Check if department already exists
            if (allTabs.find(tab => tab.id === id)) {
                showConfigStatus('Department with this ID already exists', 'error');
                return;
            }
            
            // Add new tab
            const newTab = { id, name, icon };
            allTabs.push(newTab);
            
            // Save custom tabs to localStorage
            const customTabs = JSON.parse(localStorage.getItem('customTabs') || '[]');
            customTabs.push(newTab);
            localStorage.setItem('customTabs', JSON.stringify(customTabs));
            
            // Clear form
            document.getElementById('newDepartmentId').value = '';
            document.getElementById('newDepartmentName').value = '';
            document.getElementById('newDepartmentIcon').value = '';
            
            // Refresh UI
            updateCurrentDepartmentsList();
            if (currentSelectedRole) {
                generateDepartmentCheckboxes(currentSelectedRole);
            }
            
            showConfigStatus(`New department '${name}' added successfully`, 'success');
        }
        
        function removeDepartment(departmentId) {
            if (confirm(`Are you sure you want to remove the '${departmentId}' department? This action cannot be undone.`)) {
                // Remove from allTabs
                allTabs = allTabs.filter(tab => tab.id !== departmentId);
                
                // Remove from custom tabs in localStorage
                const customTabs = JSON.parse(localStorage.getItem('customTabs') || '[]');
                const updatedCustomTabs = customTabs.filter(tab => tab.id !== departmentId);
                localStorage.setItem('customTabs', JSON.stringify(updatedCustomTabs));
                
                // Remove from all role configurations
                Object.keys(departmentAccessConfig).forEach(role => {
                    departmentAccessConfig[role] = departmentAccessConfig[role].filter(id => id !== departmentId);
                });
                
                saveConfiguration();
                
                // Refresh UI
                updateCurrentDepartmentsList();
                if (currentSelectedRole) {
                    generateDepartmentCheckboxes(currentSelectedRole);
                }
                
                showConfigStatus(`Department '${departmentId}' removed successfully`, 'success');
            }
        }
        
        function updateCurrentDepartmentsList() {
            const container = document.getElementById('currentDepartmentsList');
            container.innerHTML = '';
            
            allTabs.forEach(tab => {
                const isCustom = !['operations', 'ppm', 'strategy', 'finance', 'bpt', 'procurement', 'warehouseApd', 'ppr', 'academy', 'adminConfig'].includes(tab.id);
                
                const departmentHtml = `
                    <div class="p-4 border rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="${tab.icon} mr-3 text-gray-600"></i>
                                <div>
                                    <div class="font-medium text-gray-800">${tab.name}</div>
                                    <div class="text-sm text-gray-500">ID: ${tab.id}</div>
                                    ${isCustom ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">Custom</span>' : '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">System</span>'}
                                </div>
                            </div>
                            ${isCustom ? `<button onclick="removeDepartment('${tab.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', departmentHtml);
            });
        }
        
        function exportConfiguration() {
            const config = {
                departmentAccessConfig,
                customTabs: JSON.parse(localStorage.getItem('customTabs') || '[]'),
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(config, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `dashboard-config-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showConfigStatus('Configuration exported successfully', 'success');
        }
        
        function importConfiguration() {
            const fileInput = document.getElementById('configImportFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showConfigStatus('Please select a configuration file to import', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    
                    // Validate configuration structure
                    if (!config.departmentAccessConfig) {
                        throw new Error('Invalid configuration file: missing departmentAccessConfig');
                    }
                    
                    // Import department access configuration
                    departmentAccessConfig = config.departmentAccessConfig;
                    saveConfiguration();
                    
                    // Import custom tabs if they exist
                    if (config.customTabs && Array.isArray(config.customTabs)) {
                        localStorage.setItem('customTabs', JSON.stringify(config.customTabs));
                        
                        // Add custom tabs to allTabs
                        config.customTabs.forEach(customTab => {
                            if (!allTabs.find(tab => tab.id === customTab.id)) {
                                allTabs.push(customTab);
                            }
                        });
                    }
                    
                    // Refresh UI
                    updateCurrentDepartmentsList();
                    if (currentSelectedRole) {
                        generateDepartmentCheckboxes(currentSelectedRole);
                    }
                    
                    showConfigStatus(`Configuration imported successfully (exported: ${config.exportDate || 'Unknown date'})`, 'success');
                    
                    // Clear file input
                    fileInput.value = '';
                    
                } catch (error) {
                    console.error('Import error:', error);
                    showConfigStatus(`Error importing configuration: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        function showConfigStatus(message, type = 'info') {
            const statusDiv = document.getElementById('configStatus');
            const iconElement = document.getElementById('configStatusIcon');
            const textElement = document.getElementById('configStatusText');
            
            // Remove existing classes
            statusDiv.className = 'mb-6 p-4 rounded-lg border';
            
            // Add type-specific classes
            switch (type) {
                case 'success':
                    statusDiv.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
                    iconElement.className = 'fas fa-check-circle mr-2 text-green-600';
                    break;
                case 'error':
                    statusDiv.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
                    iconElement.className = 'fas fa-exclamation-triangle mr-2 text-red-600';
                    break;
                case 'warning':
                    statusDiv.classList.add('bg-yellow-50', 'border-yellow-200', 'text-yellow-800');
                    iconElement.className = 'fas fa-exclamation-triangle mr-2 text-yellow-600';
                    break;
                default:
                    statusDiv.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-800');
                    iconElement.className = 'fas fa-info-circle mr-2 text-blue-600';
            }
            
            textElement.textContent = message;
            statusDiv.classList.remove('hidden');
            
            // Auto-hide after 5 seconds for non-error messages
            if (type !== 'error') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 5000);
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-focus on email field
            document.getElementById('email').focus();
            
            // Initialize admin config if user is already logged in as admin
            if (currentUserRole?.toLowerCase() === 'admin') {
                updateCurrentDepartmentsList();
            }
        });

        // AM Performance Tracker Namespace - All functions isolated to prevent conflicts
        const amTracker = {
            // Data variables
            performanceData: [],
            filteredData: [],
            overviewData: [],
            currentPage: 1,
            itemsPerPage: 10,
            currentViewMode: 'table',
            currentOverviewPage: 1,
            overviewItemsPerPage: 15,
            currentOverviewSort: 'performance',
            
            // Main data fetching function
            async fetchData() {
                console.log('🚀 AM Tracker: Starting data fetch...');
                
                try {
                    document.getElementById('amTrackerLoading').classList.remove('hidden');
                    document.getElementById('amTrackerError').classList.add('hidden');
                    
                    const sheetId = '1yHmOzLTp7uzjgoKASHbiLdwXcGske0bDc81Ur5vrdIs';
                    const gid = '353860854';
                    const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                    
                    const response = await fetch(csvUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
                    }
                    
                    const csvData = await response.text();
                    const parsedData = this.parseCSVData(csvData);
                    
                    this.performanceData = parsedData;
                    this.filteredData = [...this.performanceData];
                    
                    this.generateOverview();
                    this.displayOverview();
                    this.updateOverviewPagination();
                    this.updateSummaryCards();
                    
                    document.getElementById('amTrackerSortBySelect').value = 'growth-desc';
                    this.sortData(false);
                    
                    this.displayData();
                    this.updatePagination();
                    
                    document.getElementById('amTrackerLoading').classList.add('hidden');
                    console.log('✅ AM Tracker: Data loaded successfully!');
                    
                } catch (error) {
                    console.error('❌ AM Tracker: Error fetching data:', error);
                    document.getElementById('amTrackerLoading').classList.add('hidden');
                    document.getElementById('amTrackerError').classList.remove('hidden');
                }
            },
            
            // Parse CSV data with proper handling
            parseCSVData(csvData) {
                const lines = csvData.split('\n');
                const data = [];
                
                for (let i = 2; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = this.parseCSVLine(line);
                    
                    if (values.length >= 11) {
                        const outlet = values[0]?.trim();
                        const outletName = values[1]?.trim();
                        const amName = values[2]?.trim();
                        const monthlyTarget = parseFloat(values[3]?.replace(/,/g, '')) || 0;
                        
                        const dailySalesLastMonth = parseFloat(values[5]?.replace(/,/g, '')) || 0;
                        const dailySalesUpToDate = parseFloat(values[7]?.replace(/,/g, '')) || 0;
                        const forecastSalesEndOfMonth = parseFloat(values[8]?.replace(/,/g, '')) || 0;
                        
                        const growthPercent = parseFloat(values[9]?.replace('%', '')) || 0;
                        const forecastPercent = parseFloat(values[10]?.replace('%', '')) || 0;
                        
                        if (!outlet || !amName) continue;
                        
                        const record = {
                            outlet,
                            outletName: outletName || outlet,
                            amName,
                            monthlyTarget: monthlyTarget,
                            monthlyTargetDisplay: monthlyTarget > 0 ? monthlyTarget.toLocaleString() : 'N/A',
                            growthPercent,
                            forecastPercent,
                            performanceScore: (growthPercent + forecastPercent) / 2,
                            dailySalesLastMonth,
                            dailySalesUpToDate,
                            forecastSalesEndOfMonth
                        };
                        
                        data.push(record);
                    }
                }
                
                return data;
            },
            
            // Parse CSV line with quote handling
            parseCSVLine(line) {
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                values.push(current);
                return values;
            },
            
            // Generate overview data by AM
            generateOverview() {
                const amGroups = {};
                
                this.performanceData.forEach(record => {
                    const amName = record.amName;
                    if (!amGroups[amName]) {
                        amGroups[amName] = {
                            amName: amName,
                            outlets: [],
                            totalSalesLastMonth: 0,
                            totalSalesUpToDate: 0,
                            totalForecastSales: 0,
                            totalTargets: 0
                        };
                    }
                    
                    amGroups[amName].outlets.push(record);
                    amGroups[amName].totalSalesLastMonth += record.dailySalesLastMonth;
                    amGroups[amName].totalSalesUpToDate += record.dailySalesUpToDate;
                    amGroups[amName].totalForecastSales += record.forecastSalesEndOfMonth;
                    amGroups[amName].totalTargets += record.monthlyTarget;
                });
                
                this.overviewData = Object.values(amGroups).map(group => {
                    const outletCount = group.outlets.length;
                    
                    const actualGrowthRate = group.totalSalesLastMonth > 0 
                        ? ((group.totalSalesUpToDate - group.totalSalesLastMonth) / group.totalSalesLastMonth) * 100
                        : 0;
                    
                    const forecastAchievement = group.totalTargets > 0 
                        ? (group.totalForecastSales / group.totalTargets) * 100
                        : 0;
                    
                    const overallPerformance = (actualGrowthRate + forecastAchievement) / 2;
                    
                    return {
                        amName: group.amName,
                        outletCount: outletCount,
                        outlets: group.outlets,
                        avgGrowth: actualGrowthRate,
                        avgForecast: forecastAchievement,
                        overallPerformance: overallPerformance,
                        totalSalesLastMonth: group.totalSalesLastMonth,
                        totalSalesUpToDate: group.totalSalesUpToDate,
                        totalForecastSales: group.totalForecastSales,
                        totalTargets: group.totalTargets
                    };
                });
                
                this.overviewData.sort((a, b) => b.avgGrowth - a.avgGrowth);
                this.currentOverviewSort = 'avgGrowth';
                
                this.updateOverviewStats();
            },
            
            // Update summary cards with champions
            updateSummaryCards() {
                if (!this.overviewData || this.overviewData.length === 0) return;
                
                const growthChampions = [...this.overviewData].sort((a, b) => b.avgGrowth - a.avgGrowth);
                const achievementChampions = [...this.overviewData].sort((a, b) => b.avgForecast - a.avgForecast);
                
                // Update Growth Champions
                for (let i = 0; i < 3; i++) {
                    const nameElement = document.getElementById(`amTrackerGrowthChamp${i + 1}Name`);
                    const rateElement = document.getElementById(`amTrackerGrowthChamp${i + 1}Rate`);
                    
                    if (growthChampions[i]) {
                        nameElement.textContent = growthChampions[i].amName;
                        rateElement.textContent = `${growthChampions[i].avgGrowth >= 0 ? '+' : ''}${growthChampions[i].avgGrowth.toFixed(1)}%`;
                        rateElement.className = growthChampions[i].avgGrowth >= 0 ? 'font-bold text-green-600' : 'font-bold text-red-600';
                    } else {
                        nameElement.textContent = 'N/A';
                        rateElement.textContent = '-';
                        rateElement.className = 'font-bold text-gray-400';
                    }
                }
                
                // Update Achievement Champions
                for (let i = 0; i < 3; i++) {
                    const nameElement = document.getElementById(`amTrackerAchievementChamp${i + 1}Name`);
                    const rateElement = document.getElementById(`amTrackerAchievementChamp${i + 1}Rate`);
                    
                    if (achievementChampions[i]) {
                        nameElement.textContent = achievementChampions[i].amName;
                        rateElement.textContent = `${achievementChampions[i].avgForecast.toFixed(1)}%`;
                        rateElement.className = 'font-bold text-purple-600';
                    } else {
                        nameElement.textContent = 'N/A';
                        rateElement.textContent = '-';
                        rateElement.className = 'font-bold text-gray-400';
                    }
                }
            },
            
            // Update overview stats
            updateOverviewStats() {
                if (this.overviewData.length === 0) return;
                
                const totalUniqueAMs = this.overviewData.length;
                const totalOutlets = this.performanceData.length;
                
                // Calculate Grand Total absolute values across all outlets
                let grandTotalCurrentMonth = 0;
                let grandTotalPastMonth = 0;
                let grandTotalForecast = 0;
                let grandTotalTargets = 0;
                
                // Sum up all outlets' data
                this.performanceData.forEach(outlet => {
                    grandTotalCurrentMonth += outlet.dailySalesUpToDate || 0;
                    grandTotalPastMonth += outlet.dailySalesLastMonth || 0;
                    grandTotalForecast += outlet.forecastSalesEndOfMonth || 0;
                    grandTotalTargets += outlet.monthlyTarget || 0;
                });
                
                // Calculate Grand Total Growth % (current month vs past month for all outlets combined)
                const grandTotalGrowthPercent = grandTotalPastMonth > 0 
                    ? ((grandTotalCurrentMonth - grandTotalPastMonth) / grandTotalPastMonth) * 100
                    : 0;
                
                // Calculate Grand Total Forecast % (total forecast vs total targets for all outlets combined)
                const grandTotalForecastPercent = grandTotalTargets > 0 
                    ? (grandTotalForecast / grandTotalTargets) * 100
                    : 0;
                
                document.getElementById('amTrackerTotalUniqueAMs').textContent = totalUniqueAMs;
                document.getElementById('amTrackerTotalOutlets').textContent = totalOutlets;
                document.getElementById('amTrackerTopGrowthAM').textContent = `${grandTotalGrowthPercent >= 0 ? '+' : ''}${grandTotalGrowthPercent.toFixed(1)}%`;
                document.getElementById('amTrackerTopForecastAM').textContent = `${grandTotalForecastPercent.toFixed(1)}%`;
            },
            
            // Display overview table
            displayOverview() {
                const tbody = document.getElementById('amTrackerOverviewTableBody');
                tbody.innerHTML = '';
                
                const startIndex = (this.currentOverviewPage - 1) * this.overviewItemsPerPage;
                const endIndex = Math.min(startIndex + this.overviewItemsPerPage, this.overviewData.length);
                
                for (let i = startIndex; i < endIndex; i++) {
                    const am = this.overviewData[i];
                    const rank = i + 1;
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors';
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <div class="flex items-center">
                                ${this.getRankIcon(rank)}
                                <span class="font-medium">#${rank}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <div class="flex items-center">
                                <div class="h-8 w-8 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 flex items-center justify-center text-white font-medium text-xs mr-3">
                                    ${am.amName.split(' ').map(n => n[0]).join('').substring(0, 2)}
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900">${am.amName}</div>
                                    <div class="text-xs text-gray-500">Area Manager</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${am.outletCount} outlet${am.outletCount > 1 ? 's' : ''}
                            </span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <div class="flex items-center">
                                <div class="w-12 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-${am.avgGrowth >= 0 ? 'green' : 'red'}-600 h-2 rounded-full" style="width: ${Math.min(100, Math.abs(am.avgGrowth))}%"></div>
                                </div>
                                <span class="font-medium ${am.avgGrowth >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${am.avgGrowth >= 0 ? '+' : ''}${am.avgGrowth.toFixed(1)}%
                                </span>
                            </div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <div class="flex items-center">
                                <div class="w-12 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-purple-600 h-2 rounded-full" style="width: ${Math.min(100, Math.max(0, am.avgForecast))}%"></div>
                                </div>
                                <span class="font-medium text-purple-600">${am.avgForecast.toFixed(1)}%</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">
                            <div class="flex items-center">
                                <div class="w-12 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full" style="width: ${Math.min(100, Math.max(0, am.overallPerformance))}%"></div>
                                </div>
                                <div class="flex flex-col">
                                    <span class="font-medium text-gray-900">${am.overallPerformance.toFixed(1)}%</span>
                                    ${this.getPerformanceBadge(am.overallPerformance)}
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                            <div class="flex space-x-2">
                                <button onclick="amTracker.viewDetails('${am.amName}')" 
                                        class="text-blue-600 hover:text-blue-800 font-medium">
                                    <i class="fas fa-eye mr-1"></i>View Details
                                </button>
                                <button onclick="amTracker.filterByAM('${am.amName}')" 
                                        class="text-green-600 hover:text-green-800 font-medium">
                                    <i class="fas fa-filter mr-1"></i>Filter
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                }
            },
            
            // Display main data based on view mode
            displayData() {
                const tableView = document.getElementById('amTrackerTableView');
                const cardsView = document.getElementById('amTrackerCardsView');
                
                if (this.currentViewMode === 'table') {
                    tableView.classList.remove('hidden');
                    cardsView.classList.add('hidden');
                    this.displayTable();
                } else {
                    tableView.classList.add('hidden');
                    cardsView.classList.remove('hidden');
                    this.displayCards();
                }
            },
            
            // Display table view
            displayTable() {
                const tbody = document.getElementById('amTrackerTableBody');
                tbody.innerHTML = '';
                
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = Math.min(startIndex + this.itemsPerPage, this.filteredData.length);
                
                for (let i = startIndex; i < endIndex; i++) {
                    const am = this.filteredData[i];
                    const rank = i + 1;
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            ${this.getRankIcon(rank)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            ${am.outlet}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${am.outletName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">${am.amName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${am.monthlyTargetDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <div class="flex items-center">
                                <span class="${am.growthPercent >= 0 ? 'text-green-600' : 'text-red-600'} font-medium">
                                    ${am.growthPercent >= 0 ? '+' : ''}${am.growthPercent.toFixed(1)}%
                                </span>
                                <i class="fas fa-${am.growthPercent >= 0 ? 'arrow-up' : 'arrow-down'} ml-1 text-xs"></i>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <div class="flex items-center">
                                <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${Math.min(100, Math.max(0, am.forecastPercent))}%"></div>
                                </div>
                                <span class="text-sm font-medium">${am.forecastPercent.toFixed(1)}%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            ${this.getPerformanceBadge(am.performanceScore)}
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                }
            },
            
            // Display cards view
            displayCards() {
                const container = document.getElementById('amTrackerCardsContainer');
                container.innerHTML = '';
                
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = Math.min(startIndex + this.itemsPerPage, this.filteredData.length);
                
                for (let i = startIndex; i < endIndex; i++) {
                    const am = this.filteredData[i];
                    const rank = i + 1;
                    
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow border';
                    
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                ${this.getRankIcon(rank)}
                                <span class="text-lg font-semibold text-gray-800">${am.amName}</span>
                            </div>
                            ${this.getPerformanceBadge(am.performanceScore)}
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Outlet:</span>
                                <span class="text-sm font-medium">${am.outlet}</span>
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Outlet Name:</span>
                                <span class="text-sm font-medium">${am.outletName}</span>
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Monthly Target:</span>
                                <span class="text-sm font-medium">${am.monthlyTargetDisplay}</span>
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Growth:</span>
                                <span class="${am.growthPercent >= 0 ? 'text-green-600' : 'text-red-600'} font-medium">
                                    ${am.growthPercent >= 0 ? '+' : ''}${am.growthPercent.toFixed(1)}%
                                    <i class="fas fa-${am.growthPercent >= 0 ? 'arrow-up' : 'arrow-down'} ml-1 text-xs"></i>
                                </span>
                            </div>
                            
                            <div>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-sm text-gray-600">Forecast:</span>
                                    <span class="text-sm font-medium">${am.forecastPercent.toFixed(1)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${Math.min(100, Math.max(0, am.forecastPercent))}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                }
            },
            
            // Filter data based on search
            filterData() {
                const searchTerm = document.getElementById('amTrackerSearchInput').value.toLowerCase();
                
                this.filteredData = this.performanceData.filter(am => 
                    am.amName.toLowerCase().includes(searchTerm) ||
                    am.outlet.toLowerCase().includes(searchTerm) ||
                    am.outletName.toLowerCase().includes(searchTerm)
                );
                
                this.currentPage = 1;
                this.sortData(false);
            },
            
            // Sort data based on selection
            sortData(resetPage = true) {
                const sortBy = document.getElementById('amTrackerSortBySelect').value;
                
                this.filteredData.sort((a, b) => {
                    switch (sortBy) {
                        case 'growth-desc':
                            return b.growthPercent - a.growthPercent;
                        case 'growth-asc':
                            return a.growthPercent - b.growthPercent;
                        case 'forecast-desc':
                            return b.forecastPercent - a.forecastPercent;
                        case 'forecast-asc':
                            return a.forecastPercent - b.forecastPercent;
                        case 'name-asc':
                            return a.amName.localeCompare(b.amName);
                        case 'name-desc':
                            return b.amName.localeCompare(a.amName);
                        default:
                            return b.performanceScore - a.performanceScore;
                    }
                });
                
                if (resetPage) this.currentPage = 1;
                this.displayData();
                this.updatePagination();
            },
            
            // Set view mode (table or cards)
            setViewMode(mode) {
                this.currentViewMode = mode;
                
                const tableBtn = document.getElementById('amTrackerTableViewBtn');
                const cardBtn = document.getElementById('amTrackerCardViewBtn');
                
                if (mode === 'table') {
                    tableBtn.className = 'flex-1 px-3 py-2 bg-blue-600 text-white rounded-l-lg transition-colors';
                    cardBtn.className = 'flex-1 px-3 py-2 bg-gray-200 text-gray-700 rounded-r-lg transition-colors';
                } else {
                    tableBtn.className = 'flex-1 px-3 py-2 bg-gray-200 text-gray-700 rounded-l-lg transition-colors';
                    cardBtn.className = 'flex-1 px-3 py-2 bg-blue-600 text-white rounded-r-lg transition-colors';
                }
                
                this.displayData();
            },
            
            // Change page for main data
            changePage(direction) {
                const totalPages = Math.ceil(this.filteredData.length / this.itemsPerPage);
                
                if (direction === -1 && this.currentPage > 1) {
                    this.currentPage--;
                } else if (direction === 1 && this.currentPage < totalPages) {
                    this.currentPage++;
                }
                
                this.displayData();
                this.updatePagination();
            },
            
            // Update pagination for main data
            updatePagination() {
                const totalRecords = this.filteredData.length;
                const totalPages = Math.ceil(totalRecords / this.itemsPerPage);
                const startIndex = (this.currentPage - 1) * this.itemsPerPage + 1;
                const endIndex = Math.min(this.currentPage * this.itemsPerPage, totalRecords);
                
                document.getElementById('amTrackerShowingStart').textContent = totalRecords > 0 ? startIndex : 0;
                document.getElementById('amTrackerShowingEnd').textContent = endIndex;
                document.getElementById('amTrackerTotalRecords').textContent = totalRecords;
                document.getElementById('amTrackerPageInfo').textContent = `Page ${this.currentPage} of ${totalPages}`;
                
                const prevBtn = document.getElementById('amTrackerPrevPageBtn');
                const nextBtn = document.getElementById('amTrackerNextPageBtn');
                
                prevBtn.disabled = this.currentPage === 1;
                nextBtn.disabled = this.currentPage === totalPages || totalPages === 0;
            },
            
            // Sort overview table
            sortOverview(sortBy) {
                this.currentOverviewSort = sortBy;
                
                this.overviewData.sort((a, b) => {
                    switch (sortBy) {
                        case 'rank':
                        case 'performance':
                            return b.overallPerformance - a.overallPerformance;
                        case 'amName':
                            return a.amName.localeCompare(b.amName);
                        case 'outlets':
                            return b.outletCount - a.outletCount;
                        case 'avgGrowth':
                            return b.avgGrowth - a.avgGrowth;
                        case 'avgForecast':
                            return b.avgForecast - a.avgForecast;
                        default:
                            return b.overallPerformance - a.overallPerformance;
                    }
                });
                
                this.currentOverviewPage = 1;
                this.displayOverview();
                this.updateOverviewPagination();
            },
            
            // Change page for overview
            changeOverviewPage(direction) {
                const totalPages = Math.ceil(this.overviewData.length / this.overviewItemsPerPage);
                
                if (direction === -1 && this.currentOverviewPage > 1) {
                    this.currentOverviewPage--;
                } else if (direction === 1 && this.currentOverviewPage < totalPages) {
                    this.currentOverviewPage++;
                }
                
                this.displayOverview();
                this.updateOverviewPagination();
            },
            
            // Update pagination for overview
            updateOverviewPagination() {
                const totalRecords = this.overviewData.length;
                const totalPages = Math.ceil(totalRecords / this.overviewItemsPerPage);
                const startIndex = (this.currentOverviewPage - 1) * this.overviewItemsPerPage + 1;
                const endIndex = Math.min(this.currentOverviewPage * this.overviewItemsPerPage, totalRecords);
                
                document.getElementById('amTrackerOverviewShowingStart').textContent = totalRecords > 0 ? startIndex : 0;
                document.getElementById('amTrackerOverviewShowingEnd').textContent = endIndex;
                document.getElementById('amTrackerOverviewTotalRecords').textContent = totalRecords;
                document.getElementById('amTrackerOverviewPageInfo').textContent = `Page ${this.currentOverviewPage} of ${totalPages}`;
                
                const prevBtn = document.getElementById('amTrackerOverviewPrevBtn');
                const nextBtn = document.getElementById('amTrackerOverviewNextBtn');
                
                prevBtn.disabled = this.currentOverviewPage === 1;
                nextBtn.disabled = this.currentOverviewPage === totalPages || totalPages === 0;
            },
            
            // View AM details
            viewDetails(amName) {
                const am = this.overviewData.find(a => a.amName === amName);
                if (!am) return;
                
                alert(`AM Details: ${amName}\n\nOutlets Managed: ${am.outletCount}\nAverage Growth: ${am.avgGrowth.toFixed(1)}%\nAverage Forecast: ${am.avgForecast.toFixed(1)}%\nOverall Performance: ${am.overallPerformance.toFixed(1)}%\n\nOutlets:\n${am.outlets.map(o => `• ${o.outlet} (${o.outletName}): Growth ${o.growthPercent.toFixed(1)}%, Forecast ${o.forecastPercent.toFixed(1)}%`).join('\n')}`);
            },
            
            // Filter by specific AM
            filterByAM(amName) {
                document.getElementById('amTrackerSearchInput').value = amName;
                this.filterData();
            },
            
            // Refresh data manually
            refreshData() {
                console.log('🔄 AM Tracker: Manual refresh triggered');
                this.fetchData();
            },
            
            // Helper functions
            getPerformanceBadge(score) {
                if (score >= 80) return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-star mr-1"></i>Excellent</span>';
                if (score >= 60) return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><i class="fas fa-thumbs-up mr-1"></i>Good</span>';
                if (score >= 40) return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><i class="fas fa-exclamation mr-1"></i>Average</span>';
                return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"><i class="fas fa-arrow-down mr-1"></i>Needs Improvement</span>';
            },
            
            getRankIcon(rank) {
                if (rank === 1) return '<i class="fas fa-trophy text-yellow-500 mr-2"></i>';
                if (rank === 2) return '<i class="fas fa-medal text-gray-400 mr-2"></i>';
                if (rank === 3) return '<i class="fas fa-award text-yellow-600 mr-2"></i>';
                return `<span class="text-gray-500 mr-2 font-medium">${rank}</span>`;
            }
        };
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"95a376871c4135f2","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.6.2","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDt4zpqQpbPROnAEbz3xx%2BV9krDKBimcgFTBoaYDolRJavPDWTufiRUDptoPS5KzzNx8isgcmh0bMmgZZAUg3EFVgAUcOk60KzVX%2FwXd2S9SnYINrGD0Gg3ZTMPP2pWYxG27rgCxIe2VXDEVw%2F1iAVVU0RCORlsFFJnF9YesOYXvcx5q6GXHwwbmQIKpS9Bqml8Agxnepsd8xDZ0brmR1NkoB9XbcvlUMIfR2lKs7u76s32mEFp8Vx2NABlmzrJiYm2WdmVhnsQVDcOlwiDcp52orPLIStYID3s6lJ8%2BcHgpod%2FQsz8lvUYHMpIDhCxSvs5NvgAVPU0FYNpweapdYM3VpeTdKXi5mCjYTw5DGn6nz4DlyXZ9nOJSCNTCXILmxLz%2BwQCeTJY63PY2hH0ea0%2Fd9bhgchAl19z9w7L38Hyb7SJTAKJOzh0lfycVxnAt7uddfloLmEt8Rkp6AKhSlf2NYSbkSeKt4xX8isV1xqvm2vSEIftVnlcEUgxabfcOg34WaL3lagjSm6gUjwJgWHlc%3D";
        window.__genspark_locale = "en-US";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDt4zpqQpbPROnAEbz3xx+V9krDKBimcgFTBoaYDolRJavPDWTufiRUDptoPS5KzzNx8isgcmh0bMmgZZAUg3EFVgAUcOk60KzVX/wXd2S9SnYINrGD0Gg3ZTMPP2pWYxG27rgCxIe2VXDEVw/1iAVVU0RCORlsFFJnF9YesOYXvcx5q6GXHwwbmQIKpS9Bqml8Agxnepsd8xDZ0brmR1NkoB9XbcvlUMIfR2lKs7u76s32mEFp8Vx2NABlmzrJiYm2WdmVhnsQVDcOlwiDcp52orPLIStYID3s6lJ8+cHgpod/Qsz8lvUYHMpIDhCxSvs5NvgAVPU0FYNpweapdYM3VpeTdKXi5mCjYTw5DGn6nz4DlyXZ9nOJSCNTCXILmxLz+wQCeTJY63PY2hH0ea0/d9bhgchAl19z9w7L38Hyb7SJTAKJOzh0lfycVxnAt7uddfloLmEt8Rkp6AKhSlf2NYSbkSeKt4xX8isV1xqvm2vSEIftVnlcEUgxabfcOg34WaL3lagjSm6gUjwJgWHlc=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    