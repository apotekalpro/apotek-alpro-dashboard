<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice & Payment Matching Dashboard - Memory Optimized</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .memory-indicator {
            background: linear-gradient(45deg, #4CAF50 0%, #45a049 100%);
        }
        .memory-warning {
            background: linear-gradient(45deg, #ff9800 0%, #f57c00 100%);
        }
        .memory-critical {
            background: linear-gradient(45deg, #f44336 0%, #d32f2f 100%);
        }
        .processing-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chart-container {
            height: 300px;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-blue-600 text-2xl mr-3"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Invoice & Payment Matching Dashboard</h1>
                        <p class="text-sm text-gray-600">Memory Optimized for Large Datasets</p>
                    </div>
                </div>
                <div id="memoryIndicator" class="flex items-center memory-indicator text-white px-3 py-1 rounded-lg">
                    <i class="fas fa-memory mr-2"></i>
                    <span id="memoryUsage">Memory: Good</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- File Upload Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
                <i class="fas fa-upload mr-2 text-blue-600"></i>
                File Upload & Processing
            </h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Invoice File Upload -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-blue-400 transition-colors">
                    <div class="text-center">
                        <i class="fas fa-file-invoice text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Invoice Matching File</h3>
                        <p class="text-sm text-gray-600 mb-4">Upload your invoice matching Excel file</p>
                        <input type="file" id="invoiceFile" accept=".xlsx,.xls" class="hidden">
                        <button onclick="document.getElementById('invoiceFile').click()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Choose Invoice File
                        </button>
                        <div id="invoiceFileInfo" class="mt-2 text-sm text-gray-600"></div>
                    </div>
                </div>

                <!-- Payment File Upload -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-green-400 transition-colors">
                    <div class="text-center">
                        <i class="fas fa-money-check text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Payment File</h3>
                        <p class="text-sm text-gray-600 mb-4">Upload payment file with multiple sheets</p>
                        <input type="file" id="paymentFile" accept=".xlsx,.xls" class="hidden">
                        <button onclick="document.getElementById('paymentFile').click()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Choose Payment File
                        </button>
                        <div id="paymentFileInfo" class="mt-2 text-sm text-gray-600"></div>
                    </div>
                </div>
            </div>

            <!-- Processing Controls -->
            <div class="mt-6 flex justify-center">
                <button id="processBtn" onclick="startProcessing()" disabled
                        class="bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white px-8 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-play mr-2"></i>Start Analysis
                </button>
                <button id="cancelBtn" onclick="cancelProcessing()" style="display: none"
                        class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg ml-4 font-medium transition-colors">
                    <i class="fas fa-stop mr-2"></i>Cancel
                </button>
            </div>

            <!-- Progress Section -->
            <div id="progressSection" class="mt-6" style="display: none">
                <div class="bg-gray-100 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <span id="progressText" class="text-sm font-medium text-gray-700">Processing...</span>
                        <span id="progressPercent" class="text-sm text-gray-600">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div id="detailedProgress" class="mt-2 text-xs text-gray-600"></div>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" style="display: none" class="fade-in">
            
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-file-invoice text-blue-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Invoices</p>
                            <p id="totalInvoices" class="text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-yellow-500">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Incomplete Invoices</p>
                            <p id="incompleteInvoices" class="text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Paid Invoices</p>
                            <p id="paidInvoices" class="text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-500">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock text-red-600 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">SLA Red (>7 days)</p>
                            <p id="slaRed" class="text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Status Distribution</h3>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">SLA Efficiency</h3>
                    <div class="chart-container">
                        <canvas id="slaChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Analysis -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Incomplete Invoice Analysis</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                            <span class="text-sm font-medium text-gray-700">Belum Dilanjut (K blank)</span>
                            <span id="belumDilanjut" class="text-lg font-semibold text-yellow-600">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                            <span class="text-sm font-medium text-gray-700">Tolerance Issues</span>
                            <span id="toleranceIssues" class="text-lg font-semibold text-red-600">0</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment Coverage</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <span class="text-sm font-medium text-gray-700">Payment Coverage</span>
                            <span id="paymentCoverage" class="text-lg font-semibold text-green-600">0%</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                            <span class="text-sm font-medium text-gray-700">Payment Sheets Processed</span>
                            <span id="sheetsProcessed" class="text-lg font-semibold text-blue-600">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Detailed Invoice Data</h3>
                    <div class="flex space-x-2">
                        <select id="statusFilter" class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                            <option value="">All Status</option>
                        </select>
                        <button onclick="exportToExcel()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            <i class="fas fa-download mr-2"></i>Export Excel
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SLA</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Receiving No.</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for memory-efficient processing
        let invoiceData = new Map();
        let paymentLookup = new Map();
        let processedResults = [];
        let processingCancelled = false;
        let currentChart1, currentChart2;

        class MemoryManager {
            constructor() {
                this.memoryThreshold = {
                    good: 50,
                    warning: 70,
                    critical: 85
                };
            }

            getMemoryUsage() {
                if (performance.memory) {
                    const used = performance.memory.usedJSHeapSize / 1048576; // MB
                    const total = performance.memory.totalJSHeapSize / 1048576; // MB
                    return Math.round((used / total) * 100);
                }
                return 0;
            }

            updateMemoryIndicator() {
                const usage = this.getMemoryUsage();
                const indicator = document.getElementById('memoryIndicator');
                const text = document.getElementById('memoryUsage');
                
                if (usage > this.memoryThreshold.critical) {
                    indicator.className = indicator.className.replace(/memory-\w+/, 'memory-critical');
                    text.textContent = `Memory: Critical (${usage}%)`;
                } else if (usage > this.memoryThreshold.warning) {
                    indicator.className = indicator.className.replace(/memory-\w+/, 'memory-warning');
                    text.textContent = `Memory: Warning (${usage}%)`;
                } else {
                    indicator.className = indicator.className.replace(/memory-\w+/, 'memory-indicator');
                    text.textContent = `Memory: Good (${usage}%)`;
                }
            }

            forceGarbageCollection() {
                if (window.gc) {
                    window.gc();
                }
            }

            clearVariables(...vars) {
                vars.forEach(variable => {
                    if (Array.isArray(variable)) {
                        variable.length = 0;
                    } else if (variable instanceof Map) {
                        variable.clear();
                    } else if (typeof variable === 'object' && variable !== null) {
                        Object.keys(variable).forEach(key => delete variable[key]);
                    }
                });
            }
        }

        const memoryManager = new MemoryManager();

        // File upload handlers
        document.getElementById('invoiceFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('invoiceFileInfo').textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                checkProcessButton();
            }
        });

        document.getElementById('paymentFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('paymentFileInfo').textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                checkProcessButton();
            }
        });

        function checkProcessButton() {
            const invoiceFile = document.getElementById('invoiceFile').files[0];
            const paymentFile = document.getElementById('paymentFile').files[0];
            document.getElementById('processBtn').disabled = !invoiceFile || !paymentFile;
        }

        // Progress management
        function updateProgress(percent, text, details = '') {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressText').textContent = text;
            document.getElementById('detailedProgress').textContent = details;
            memoryManager.updateMemoryIndicator();
        }

        // Memory-efficient Excel reading
        async function readExcelFile(file, sheetName = null) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        if (sheetName) {
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            resolve(jsonData);
                        } else {
                            resolve(workbook);
                        }
                        
                        // Clear file data from memory
                        memoryManager.clearVariables(data);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsArrayBuffer(file);
            });
        }

        // Process invoice data in chunks
        async function processInvoiceData(file) {
            updateProgress(10, 'Loading invoice file...', 'Reading Excel data');
            
            const workbook = await readExcelFile(file);
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // Clear workbook from memory
            memoryManager.clearVariables(workbook);
            
            updateProgress(20, 'Processing invoice data...', 'Starting chunked processing');
            
            const chunkSize = 500;
            const headerRow = rawData[4]; // Row 5 (0-indexed as 4)
            const dataRows = rawData.slice(5); // Start from row 6
            
            invoiceData.clear();
            let processedCount = 0;
            
            for (let i = 0; i < dataRows.length; i += chunkSize) {
                if (processingCancelled) return false;
                
                const chunk = dataRows.slice(i, i + chunkSize);
                
                for (const row of chunk) {
                    // Skip PT HERMED completely
                    const supplier = row[3] || '';
                    if (supplier.includes('0000000016 - PT HERMED')) {
                        continue;
                    }
                    
                    const invoiceRecord = {
                        company: row[0] || '',
                        store: row[1] || '',
                        matchNo: row[2] || '',
                        supplier: supplier,
                        status: row[6] || '',
                        createDate: row[7] || '',
                        confirmDate: row[8] || '',
                        invoiceNumber: row[9] || '',
                        fakturPajak: row[10] || '',
                        receivingNumber: row[14] || '',
                        toleranceAmount: parseFloat(row[19]) || 0,
                        paymentStatus: 'Unpaid',
                        paymentReference: ''
                    };
                    
                    // Calculate completion days and SLA (only for non-incomplete)
                    if (invoiceRecord.status !== 'Incomplete') {
                        const createDate = new Date(invoiceRecord.createDate);
                        const confirmDate = new Date(invoiceRecord.confirmDate);
                        
                        if (!isNaN(createDate.getTime()) && !isNaN(confirmDate.getTime())) {
                            const diffTime = Math.abs(confirmDate - createDate);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            
                            // Skip SLA calculation for PT CENTURY
                            if (!supplier.includes('0000000004 - PT. CENTURY FRANCHISINDO UTAMA')) {
                                invoiceRecord.completionDays = diffDays;
                                if (diffDays < 4) {
                                    invoiceRecord.slaCategory = 'Green';
                                } else if (diffDays <= 7) {
                                    invoiceRecord.slaCategory = 'Yellow';
                                } else {
                                    invoiceRecord.slaCategory = 'Red';
                                }
                            } else {
                                invoiceRecord.slaCategory = 'N/A';
                            }
                        }
                    } else {
                        invoiceRecord.slaCategory = 'N/A';
                    }
                    
                    invoiceData.set(invoiceRecord.receivingNumber, invoiceRecord);
                    processedCount++;
                }
                
                const progress = 20 + (i / dataRows.length) * 30;
                updateProgress(Math.round(progress), 'Processing invoice data...', 
                    `Processed ${processedCount} of ${dataRows.length} rows`);
                
                // Clear chunk from memory and yield control
                memoryManager.clearVariables(chunk);
                await new Promise(resolve => setTimeout(resolve, 10));
                memoryManager.forceGarbageCollection();
            }
            
            // Clear raw data from memory
            memoryManager.clearVariables(rawData);
            return true;
        }

        // Process payment data sheet by sheet
        async function processPaymentData(file) {
            updateProgress(50, 'Loading payment file...', 'Reading workbook structure');
            
            const workbook = await readExcelFile(file);
            const sheetNames = workbook.SheetNames;
            
            updateProgress(55, 'Processing payment sheets...', `Found ${sheetNames.length} sheets`);
            
            paymentLookup.clear();
            let totalProcessed = 0;
            
            for (let sheetIndex = 0; sheetIndex < sheetNames.length; sheetIndex++) {
                if (processingCancelled) return false;
                
                const sheetName = sheetNames[sheetIndex];
                updateProgress(55 + (sheetIndex / sheetNames.length) * 25, 
                    `Processing sheet: ${sheetName}...`, `Sheet ${sheetIndex + 1} of ${sheetNames.length}`);
                
                const worksheet = workbook.Sheets[sheetName];
                const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                // Process in small chunks
                const chunkSize = 500;
                for (let i = 1; i < sheetData.length; i += chunkSize) {
                    if (processingCancelled) return false;
                    
                    const chunk = sheetData.slice(i, i + chunkSize);
                    
                    for (const row of chunk) {
                        const columnG = row[6] || '';
                        const columnT = row[19] || '';
                        
                        // Extract receiving number from "Receiving Number XXXXXXXXXX"
                        const match = columnG.match(/Number\s+(\d+)/i);
                        if (match) {
                            const receivingNumber = match[1];
                            paymentLookup.set(receivingNumber, columnT);
                            totalProcessed++;
                        }
                    }
                    
                    // Clear chunk and yield control
                    memoryManager.clearVariables(chunk);
                    await new Promise(resolve => setTimeout(resolve, 5));
                }
                
                // Clear sheet data
                memoryManager.clearVariables(sheetData);
                memoryManager.forceGarbageCollection();
            }
            
            updateProgress(80, 'Payment processing complete', `Processed ${totalProcessed} payment records from ${sheetNames.length} sheets`);
            
            // Clear workbook
            memoryManager.clearVariables(workbook);
            return sheetNames.length;
        }

        // Match invoice and payment data
        async function matchInvoicePayments() {
            updateProgress(85, 'Matching invoices with payments...', 'Cross-referencing data');
            
            let matchedCount = 0;
            const chunkSize = 500;
            const invoiceEntries = Array.from(invoiceData.entries());
            
            for (let i = 0; i < invoiceEntries.length; i += chunkSize) {
                if (processingCancelled) return false;
                
                const chunk = invoiceEntries.slice(i, i + chunkSize);
                
                for (const [receivingNumber, invoice] of chunk) {
                    if (paymentLookup.has(receivingNumber)) {
                        invoice.paymentStatus = 'Paid';
                        invoice.paymentReference = paymentLookup.get(receivingNumber);
                        matchedCount++;
                    }
                }
                
                const progress = 85 + (i / invoiceEntries.length) * 10;
                updateProgress(Math.round(progress), 'Matching invoices with payments...', 
                    `Matched ${matchedCount} payments`);
                
                await new Promise(resolve => setTimeout(resolve, 5));
            }
            
            updateProgress(95, 'Finalizing results...', `Matched ${matchedCount} of ${invoiceData.size} invoices`);
            return true;
        }

        // Generate dashboard
        function generateDashboard() {
            const invoices = Array.from(invoiceData.values());
            
            // Calculate statistics
            const stats = {
                total: invoices.length,
                incomplete: invoices.filter(inv => inv.status === 'Incomplete').length,
                paid: invoices.filter(inv => inv.paymentStatus === 'Paid').length,
                belumDilanjut: invoices.filter(inv => inv.status === 'Incomplete' && !inv.fakturPajak).length,
                toleranceIssues: invoices.filter(inv => 
                    inv.status === 'Incomplete' && 
                    inv.fakturPajak && 
                    (inv.toleranceAmount > 1000 || inv.toleranceAmount < -1000)
                ).length,
                slaRed: invoices.filter(inv => inv.slaCategory === 'Red').length,
                slaYellow: invoices.filter(inv => inv.slaCategory === 'Yellow').length,
                slaGreen: invoices.filter(inv => inv.slaCategory === 'Green').length
            };
            
            // Update summary cards
            document.getElementById('totalInvoices').textContent = stats.total;
            document.getElementById('incompleteInvoices').textContent = stats.incomplete;
            document.getElementById('paidInvoices').textContent = stats.paid;
            document.getElementById('slaRed').textContent = stats.slaRed;
            document.getElementById('belumDilanjut').textContent = stats.belumDilanjut;
            document.getElementById('toleranceIssues').textContent = stats.toleranceIssues;
            document.getElementById('paymentCoverage').textContent = 
                Math.round((stats.paid / stats.total) * 100) + '%';
            document.getElementById('sheetsProcessed').textContent = paymentLookup.size > 0 ? 'Multiple' : '0';
            
            // Create charts
            createStatusChart(invoices);
            createSLAChart(stats);
            
            // Populate data table
            populateDataTable(invoices);
            
            // Show dashboard
            document.getElementById('dashboardSection').style.display = 'block';
        }

        function createStatusChart(invoices) {
            const statusCounts = {};
            invoices.forEach(inv => {
                statusCounts[inv.status] = (statusCounts[inv.status] || 0) + 1;
            });
            
            const ctx = document.getElementById('statusChart').getContext('2d');
            if (currentChart1) currentChart1.destroy();
            
            currentChart1 = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        label: 'Invoice Count',
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createSLAChart(stats) {
            const ctx = document.getElementById('slaChart').getContext('2d');
            if (currentChart2) currentChart2.destroy();
            
            currentChart2 = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Green (<4 days)', 'Yellow (4-7 days)', 'Red (>7 days)'],
                    datasets: [{
                        data: [stats.slaGreen, stats.slaYellow, stats.slaRed],
                        backgroundColor: ['#10B981', '#F59E0B', '#EF4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function populateDataTable(invoices) {
            const tbody = document.getElementById('dataTableBody');
            const statusFilter = document.getElementById('statusFilter');
            
            // Populate filter options
            const statuses = [...new Set(invoices.map(inv => inv.status))];
            statusFilter.innerHTML = '<option value="">All Status</option>';
            statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status;
                statusFilter.appendChild(option);
            });
            
            // Display data (first 100 rows for performance)
            const displayInvoices = invoices.slice(0, 100);
            tbody.innerHTML = '';
            
            displayInvoices.forEach(invoice => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const slaClass = invoice.slaCategory === 'Green' ? 'text-green-600' :
                               invoice.slaCategory === 'Yellow' ? 'text-yellow-600' :
                               invoice.slaCategory === 'Red' ? 'text-red-600' : 'text-gray-600';
                
                const paymentClass = invoice.paymentStatus === 'Paid' ? 'text-green-600' : 'text-red-600';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">${invoice.company}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${invoice.supplier}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${invoice.status}</td>
                    <td class="px-4 py-3 text-sm ${slaClass}">${invoice.slaCategory}</td>
                    <td class="px-4 py-3 text-sm ${paymentClass}">${invoice.paymentStatus}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${invoice.receivingNumber}</td>
                `;
                tbody.appendChild(row);
            });
            
            if (invoices.length > 100) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="px-4 py-3 text-sm text-gray-500 text-center">
                        Showing first 100 of ${invoices.length} records. Use export to get complete data.
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        // Main processing function
        async function startProcessing() {
            processingCancelled = false;
            document.getElementById('processBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('dashboardSection').style.display = 'none';
            
            try {
                const invoiceFile = document.getElementById('invoiceFile').files[0];
                const paymentFile = document.getElementById('paymentFile').files[0];
                
                // Process invoice file
                const invoiceResult = await processInvoiceData(invoiceFile);
                if (!invoiceResult) throw new Error('Invoice processing cancelled');
                
                // Process payment file
                const sheetsCount = await processPaymentData(paymentFile);
                if (!sheetsCount) throw new Error('Payment processing cancelled');
                
                // Match data
                const matchResult = await matchInvoicePayments();
                if (!matchResult) throw new Error('Matching cancelled');
                
                updateProgress(100, 'Analysis complete!', `Processed ${invoiceData.size} invoices and ${sheetsCount} payment sheets`);
                
                // Generate dashboard
                generateDashboard();
                
                // Clean up
                setTimeout(() => {
                    document.getElementById('progressSection').style.display = 'none';
                    document.getElementById('processBtn').style.display = 'inline-block';
                    document.getElementById('cancelBtn').style.display = 'none';
                    memoryManager.forceGarbageCollection();
                }, 2000);
                
            } catch (error) {
                console.error('Processing error:', error);
                alert('Processing failed: ' + error.message);
                resetProcessing();
            }
        }

        function cancelProcessing() {
            processingCancelled = true;
            resetProcessing();
        }

        function resetProcessing() {
            document.getElementById('processBtn').style.display = 'inline-block';
            document.getElementById('cancelBtn').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';
            
            // Clear data
            memoryManager.clearVariables(invoiceData, paymentLookup, processedResults);
            memoryManager.forceGarbageCollection();
        }

        // Export function
        function exportToExcel() {
            const invoices = Array.from(invoiceData.values());
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Convert invoice data to array format
            const wsData = [
                ['Company', 'Store', 'Match No', 'Supplier', 'Status', 'Create Date', 'Confirm Date', 
                 'Invoice Number', 'Faktur Pajak', 'Receiving Number', 'Tolerance Amount', 
                 'Completion Days', 'SLA Category', 'Payment Status', 'Payment Reference']
            ];
            
            invoices.forEach(inv => {
                wsData.push([
                    inv.company, inv.store, inv.matchNo, inv.supplier, inv.status,
                    inv.createDate, inv.confirmDate, inv.invoiceNumber, inv.fakturPajak,
                    inv.receivingNumber, inv.toleranceAmount, inv.completionDays || '',
                    inv.slaCategory, inv.paymentStatus, inv.paymentReference
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Invoice Analysis');
            
            // Generate and download file
            XLSX.writeFile(wb, 'Invoice_Payment_Analysis.xlsx');
        }

        // Initialize memory monitoring
        setInterval(() => {
            memoryManager.updateMemoryIndicator();
        }, 5000);

        // Initial memory indicator
        memoryManager.updateMemoryIndicator();
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"954a8280bee481c6","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.6.2","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDpIWcOjCluBhqHG6mjGuQ4od%2F4Z%2Bl0fgloYrWTKds4KtgvEH%2BRAQT9mUvcpfbIxNK%2B5a8ZqmplM1Mc1YifMJSIVzwk7FBsAQP9ayshILrM5A41sWFwa6VFCTPI%2BUOWqsUYFfVLhRXjUXi3s2BScdZANa%2B7kL3A7wfd%2BfnJ4%2BaRPa2D%2BNSHcyFJsgGg6W7gu3%2BWy%2F0QKv7gkYmNumFwFgdbDeQpDhjY68DKiNKbWCvGn6ctCCiF2WnDQi1ss7NyNE4ZiMA%2B30a8gZbd%2FAUbV2VZO4CHAn4UfXG89oSsE2cF5tIA7u2n0koO4hnRhOVFfUwxhI6D8W77RfswtrCXb0qO36sz9EuQc7md65jNTX3RBK7o0Ih546mrBqCueYLAEwHQMkCestvgDErNcsSCvs8iJvcRzBEj1zdOqbWY2y42buRScJbpJu4vMdUDnuhUpNhALo7VUWLKJXSRGaZht%2BuuIZ8iG1bcylCT4Hg2EtMTJCsGr62wcTurlm90sxOW2OqzOgeSrW2xuE5%2FajYvogga8%3D";
        window.__genspark_locale = "en-US";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDpIWcOjCluBhqHG6mjGuQ4od/4Z+l0fgloYrWTKds4KtgvEH+RAQT9mUvcpfbIxNK+5a8ZqmplM1Mc1YifMJSIVzwk7FBsAQP9ayshILrM5A41sWFwa6VFCTPI+UOWqsUYFfVLhRXjUXi3s2BScdZANa+7kL3A7wfd+fnJ4+aRPa2D+NSHcyFJsgGg6W7gu3+Wy/0QKv7gkYmNumFwFgdbDeQpDhjY68DKiNKbWCvGn6ctCCiF2WnDQi1ss7NyNE4ZiMA+30a8gZbd/AUbV2VZO4CHAn4UfXG89oSsE2cF5tIA7u2n0koO4hnRhOVFfUwxhI6D8W77RfswtrCXb0qO36sz9EuQc7md65jNTX3RBK7o0Ih546mrBqCueYLAEwHQMkCestvgDErNcsSCvs8iJvcRzBEj1zdOqbWY2y42buRScJbpJu4vMdUDnuhUpNhALo7VUWLKJXSRGaZht+uuIZ8iG1bcylCT4Hg2EtMTJCsGr62wcTurlm90sxOW2OqzOgeSrW2xuE5/ajYvogga8=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    