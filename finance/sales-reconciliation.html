<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Reconciliation - Apotek Alpro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .upload-zone {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            background: #f7fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: #4f46e5;
            background: #eef2ff;
        }

        .upload-zone.has-file {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .upload-zone.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .result-table {
            max-height: 500px;
            overflow: auto;
        }

        .result-table table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .result-table th {
            position: sticky;
            top: 0;
            background: #4f46e5;
            color: white;
            z-index: 10;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: #4f46e5;
            border: 2px solid #4f46e5;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #4f46e5;
            color: white;
        }

        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            transition: width 0.3s ease;
        }

        .tab-button {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: #f3f4f6;
            color: #6b7280;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-calculator mr-3 text-indigo-600"></i>
                        Sales Reconciliation System
                    </h1>
                    <p class="text-gray-600 mt-2">BCA Statement reconciliation with transaction summary matching</p>
                </div>
                <button onclick="resetAll()" class="btn-secondary">
                    <i class="fas fa-redo mr-2"></i>Reset All
                </button>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="card">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-upload mr-2 text-indigo-600"></i>
                Step 1: Upload Required Files
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- File 1: Transaction Summary ACMM -->
                <div class="upload-container">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        1. Transaction Summary ACMM
                    </label>
                    <div class="upload-zone" id="upload-zone-1" onclick="document.getElementById('file-1').click()">
                        <input type="file" id="file-1" accept=".xlsx,.xls" class="hidden" onchange="handleFileUpload(1, this.files[0])">
                        <div class="p-4 text-center">
                            <i class="fas fa-file-excel text-4xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600" id="file-name-1">Click to upload Excel file</p>
                            <p class="text-xs text-gray-400 mt-1" id="file-status-1"></p>
                        </div>
                    </div>
                </div>

                <!-- File 2: BCA Statement -->
                <div class="upload-container">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        2. BCA Statement (Master)
                        <span class="text-red-500">*</span>
                    </label>
                    <div class="upload-zone" id="upload-zone-2" onclick="document.getElementById('file-2').click()">
                        <input type="file" id="file-2" accept=".xlsx,.xls" class="hidden" onchange="handleFileUpload(2, this.files[0])">
                        <div class="p-4 text-center">
                            <i class="fas fa-file-excel text-4xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600" id="file-name-2">Click to upload Excel file</p>
                            <p class="text-xs text-gray-400 mt-1" id="file-status-2"></p>
                        </div>
                    </div>
                </div>

                <!-- File 3: Master MID Outlet -->
                <div class="upload-container">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        3. Master MID Outlet
                    </label>
                    <div class="upload-zone" id="upload-zone-3" onclick="document.getElementById('file-3').click()">
                        <input type="file" id="file-3" accept=".xlsx,.xls" class="hidden" onchange="handleFileUpload(3, this.files[0])">
                        <div class="p-4 text-center">
                            <i class="fas fa-file-excel text-4xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600" id="file-name-3">Click to upload Excel file</p>
                            <p class="text-xs text-gray-400 mt-1" id="file-status-3"></p>
                        </div>
                    </div>
                </div>

                <!-- File 4: Master Kartu Debit Outlet -->
                <div class="upload-container">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        4. Master Kartu Debit Outlet
                    </label>
                    <div class="upload-zone" id="upload-zone-4" onclick="document.getElementById('file-4').click()">
                        <input type="file" id="file-4" accept=".xlsx,.xls" class="hidden" onchange="handleFileUpload(4, this.files[0])">
                        <div class="p-4 text-center">
                            <i class="fas fa-file-excel text-4xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600" id="file-name-4">Click to upload Excel file</p>
                            <p class="text-xs text-gray-400 mt-1" id="file-status-4"></p>
                        </div>
                    </div>
                </div>

                <!-- File 5: Master BCA Cabang x Alpro Matching -->
                <div class="upload-container">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        5. Master BCA Cabang x Alpro
                    </label>
                    <div class="upload-zone" id="upload-zone-5" onclick="document.getElementById('file-5').click()">
                        <input type="file" id="file-5" accept=".xlsx,.xls" class="hidden" onchange="handleFileUpload(5, this.files[0])">
                        <div class="p-4 text-center">
                            <i class="fas fa-file-excel text-4xl text-gray-400 mb-2"></i>
                            <p class="text-sm text-gray-600" id="file-name-5">Click to upload Excel file</p>
                            <p class="text-xs text-gray-400 mt-1" id="file-status-5"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="mt-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-semibold text-gray-700">Upload Progress</span>
                    <span class="text-sm text-gray-600" id="upload-progress-text">0/5 files uploaded</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Process Button -->
        <div class="card">
            <button onclick="startReconciliation()" id="process-btn" class="btn-primary w-full" disabled>
                <i class="fas fa-cogs mr-2"></i>
                Start Reconciliation Process
            </button>
            <div class="mt-4 hidden" id="processing-status">
                <div class="flex items-center justify-center">
                    <div class="loading-spinner mr-4"></div>
                    <span class="text-gray-700 font-semibold" id="processing-text">Processing...</span>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="card hidden" id="results-section">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                <i class="fas fa-chart-bar mr-2 text-indigo-600"></i>
                Reconciliation Results
            </h2>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-blue-600 font-semibold">Total Records</p>
                            <p class="text-2xl font-bold text-blue-800" id="total-records">0</p>
                        </div>
                        <i class="fas fa-file-alt text-3xl text-blue-400"></i>
                    </div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-green-600 font-semibold">Matched</p>
                            <p class="text-2xl font-bold text-green-800" id="matched-count">0</p>
                        </div>
                        <i class="fas fa-check-circle text-3xl text-green-400"></i>
                    </div>
                </div>
                <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-red-600 font-semibold">Unmatched</p>
                            <p class="text-2xl font-bold text-red-800" id="unmatched-count">0</p>
                        </div>
                        <i class="fas fa-times-circle text-3xl text-red-400"></i>
                    </div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-yellow-600 font-semibold">Match Rate</p>
                            <p class="text-2xl font-bold text-yellow-800" id="match-rate">0%</p>
                        </div>
                        <i class="fas fa-percentage text-3xl text-yellow-400"></i>
                    </div>
                </div>
            </div>

            <!-- Result Tabs -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button class="tab-button active" onclick="showResultTab('all')">
                    <i class="fas fa-list mr-2"></i>All Results
                </button>
                <button class="tab-button" onclick="showResultTab('cdm')">
                    <i class="fas fa-money-bill-wave mr-2"></i>CDM (Cash)
                </button>
                <button class="tab-button" onclick="showResultTab('creditcard')">
                    <i class="fas fa-credit-card mr-2"></i>Credit Card
                </button>
                <button class="tab-button" onclick="showResultTab('qris')">
                    <i class="fas fa-qrcode mr-2"></i>QRIS
                </button>
                <button class="tab-button" onclick="showResultTab('debit')">
                    <i class="fas fa-credit-card mr-2"></i>Debit Card
                </button>
                <button class="tab-button" onclick="showResultTab('setoran')">
                    <i class="fas fa-hand-holding-usd mr-2"></i>Setoran Tunai
                </button>
            </div>

            <!-- Export Buttons -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button onclick="exportResults('all')" class="btn-secondary">
                    <i class="fas fa-download mr-2"></i>Export All
                </button>
                <button onclick="exportResults('matched')" class="btn-secondary">
                    <i class="fas fa-check mr-2"></i>Export Matched
                </button>
                <button onclick="exportResults('unmatched')" class="btn-secondary">
                    <i class="fas fa-times mr-2"></i>Export Unmatched
                </button>
                <button onclick="exportResults('cdm')" class="btn-secondary">
                    <i class="fas fa-money-bill-wave mr-2"></i>Export CDM
                </button>
                <button onclick="exportResults('creditcard')" class="btn-secondary">
                    <i class="fas fa-credit-card mr-2"></i>Export Credit Card
                </button>
                <button onclick="exportResults('qris')" class="btn-secondary">
                    <i class="fas fa-qrcode mr-2"></i>Export QRIS
                </button>
                <button onclick="exportResults('debit')" class="btn-secondary">
                    <i class="fas fa-credit-card mr-2"></i>Export Debit
                </button>
                <button onclick="exportResults('setoran')" class="btn-secondary">
                    <i class="fas fa-hand-holding-usd mr-2"></i>Export Setoran
                </button>
            </div>

            <!-- Results Table -->
            <div class="result-table">
                <table class="w-full text-sm" id="results-table">
                    <thead>
                        <tr>
                            <th class="px-4 py-3 text-left">#</th>
                            <th class="px-4 py-3 text-left">BCA Date</th>
                            <th class="px-4 py-3 text-left">Transaction Type</th>
                            <th class="px-4 py-3 text-left">Outlet Code</th>
                            <th class="px-4 py-3 text-left">BCA Amount</th>
                            <th class="px-4 py-3 text-left">ACMM Amount</th>
                            <th class="px-4 py-3 text-left">Difference</th>
                            <th class="px-4 py-3 text-left">Status</th>
                            <th class="px-4 py-3 text-left">Details</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                        <tr>
                            <td colspan="9" class="text-center py-8 text-gray-500">
                                No results to display. Please upload files and start reconciliation.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let uploadedFiles = {};
        let reconciliationResults = [];
        let currentTab = 'all';

        // File upload handler
        function handleFileUpload(fileNumber, file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                    uploadedFiles[fileNumber] = {
                        name: file.name,
                        data: jsonData,
                        workbook: workbook
                    };

                    // Update UI
                    const zone = document.getElementById(`upload-zone-${fileNumber}`);
                    const fileName = document.getElementById(`file-name-${fileNumber}`);
                    const fileStatus = document.getElementById(`file-status-${fileNumber}`);

                    zone.classList.add('has-file');
                    fileName.textContent = file.name;
                    fileStatus.innerHTML = `<span class="status-badge status-success"><i class="fas fa-check mr-1"></i>Uploaded (${jsonData.length} rows)</span>`;

                    updateProgress();
                } catch (error) {
                    console.error('Error reading file:', error);
                    const zone = document.getElementById(`upload-zone-${fileNumber}`);
                    const fileStatus = document.getElementById(`file-status-${fileNumber}`);
                    zone.classList.add('error');
                    fileStatus.innerHTML = `<span class="status-badge status-error"><i class="fas fa-exclamation-triangle mr-1"></i>Error reading file</span>`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Update progress bar
        function updateProgress() {
            const uploadedCount = Object.keys(uploadedFiles).length;
            const progressPercent = (uploadedCount / 5) * 100;
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
            document.getElementById('upload-progress-text').textContent = `${uploadedCount}/5 files uploaded`;

            // Enable process button if BCA statement is uploaded
            if (uploadedFiles[2]) {
                document.getElementById('process-btn').disabled = false;
            }
        }

        // Parse date from various formats
        function parseDate(dateValue, referenceYear = null) {
            if (!dateValue) return null;
            
            // If it's already a Date object
            if (dateValue instanceof Date) return dateValue;
            
            // If it's a string
            if (typeof dateValue === 'string') {
                // Try DD/MM format
                const parts = dateValue.trim().split('/');
                if (parts.length === 2) {
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1;
                    
                    // Smart year inference:
                    // 1. Use referenceYear if provided
                    // 2. Otherwise, if transaction month > current month, assume previous year
                    // 3. Otherwise use current year
                    let year;
                    if (referenceYear) {
                        year = referenceYear;
                    } else {
                        const currentDate = new Date();
                        const currentYear = currentDate.getFullYear();
                        const currentMonth = currentDate.getMonth();
                        
                        // TEMPORARY FIX: Hard-code 2026 for current data
                        // TODO: Add year input field in UI
                        year = 2026;
                        
                        // If transaction month is after current month, it's likely from previous year
                        // e.g., in January 2026, a transaction dated 10/10 (October) is from 2025
                        // if (month > currentMonth) {
                        //     year = currentYear - 1;
                        // } else {
                        //     year = currentYear;
                        // }
                    }
                    
                    return new Date(year, month, day);
                }
                
                // Try standard date parsing
                const parsed = new Date(dateValue);
                if (!isNaN(parsed.getTime())) return parsed;
            }
            
            // If it's an Excel serial number
            if (typeof dateValue === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                return new Date(excelEpoch.getTime() + dateValue * 86400000);
            }
            
            return null;
        }

        // Subtract one day from date
        function subtractOneDay(date) {
            const newDate = new Date(date);
            newDate.setDate(newDate.getDate() - 1);
            return newDate;
        }

        // Format date as DD/MM
        function formatDate(date) {
            if (!date) return '';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            return `${day}/${month}`;
        }

        // Parse outlet code from description (JKJSKR1) format
        function parseOutletCode(description) {
            if (!description) return null;
            const match = description.match(/\(([^)]+)\)/);
            return match ? match[1] : null;
        }

        // Extract last N digits from a string
        function extractLastDigits(str, n) {
            if (!str) return '';
            const cleaned = str.toString().replace(/\D/g, '');
            return cleaned.slice(-n);
        }

        // Parse amount from BCA statement (handles CR suffix and decimal)
        function parseBCAAmount(amountStr) {
            if (!amountStr) return 0;
            
            // Convert to string and clean up
            let cleanAmount = amountStr.toString().trim();
            
            // Remove "CR" suffix if present
            cleanAmount = cleanAmount.replace(/\s*CR\s*$/i, '');
            
            // Remove any non-numeric characters except decimal point and minus
            cleanAmount = cleanAmount.replace(/[^0-9.-]/g, '');
            
            // Parse to float
            const amount = parseFloat(cleanAmount) || 0;
            
            return amount;
        }

        // NEW: Parse BCA amount from Column B description (before deduction)
        function parseBCAAmountFromDescription(description, transactionType = null) {
            if (!description) return 0;
            
            // For CDM: Extract from "SETORAN VIA CDM BCA ... Rp xxx.xxx,xx"
            if (transactionType === 'CDM') {
                // Pattern: "Rp 1.234.567,89" or "Rp 1234567.89"
                const rpMatch = description.match(/Rp\s*([\d.,]+)/i);
                if (rpMatch) {
                    // Clean: remove dots (thousand separators), replace comma with decimal point
                    let cleanAmount = rpMatch[1].replace(/\./g, '').replace(/,/g, '.');
                    return parseFloat(cleanAmount) || 0;
                }
            }
            
            // For SETORAN_TUNAI: Extract from "SETORAN TUNAI ... xxx.xxx,xx"
            if (transactionType === 'SETORAN_TUNAI') {
                // Pattern: numbers with dots/commas at end of description
                const amountMatch = description.match(/([\d.,]+)\s*$/i);
                if (amountMatch) {
                    let cleanAmount = amountMatch[1].replace(/\./g, '').replace(/,/g, '.');
                    return parseFloat(cleanAmount) || 0;
                }
            }
            
            // NEW Pattern: BCA statement with asterisk-delimited format
            // Example: "*QRIS*:8735997,*SALES*:12759015,*CASH*:2169118,*DEBIT LAIN*:8898400"
            // We need to extract SALES amount or sum all payment types
            
            // Try to find *SALES* amount (this is usually the total)
            const salesMatch = description.match(/\*SALES\*\s*:\s*([\d,]+\.?\d*)/i);
            if (salesMatch) {
                const cleanAmount = salesMatch[1].replace(/,/g, '');
                return parseFloat(cleanAmount) || 0;
            }
            
            // If no SALES field, sum all payment types
            // Pattern: *TYPE*:amount
            const paymentPattern = /\*[^*]+\*\s*:\s*([\d,]+\.?\d*)/g;
            let totalAmount = 0;
            let match;
            
            while ((match = paymentPattern.exec(description)) !== null) {
                const cleanAmount = match[1].replace(/,/g, '');
                const amount = parseFloat(cleanAmount);
                if (!isNaN(amount)) {
                    totalAmount += amount;
                }
            }
            
            if (totalAmount > 0) {
                return totalAmount;
            }
            
            // Pattern for KR OTOMATIS with TGH: (Debit Card)
            // Example: "KR OTOMATIS MID : 885004119892 ALPRO KALIBATA CIT  TGH:     743450.00"
            const tghMatch = description.match(/TGH\s*:\s*([\d,]+\.?\d*)/i);
            if (tghMatch) {
                const cleanAmount = tghMatch[1].replace(/,/g, '');
                return parseFloat(cleanAmount) || 0;
            }
            
            // Pattern for QR: amount (for QRIS)
            const qrMatch = description.match(/QR\s*:\s*([\d,]+\.?\d*)/i);
            if (qrMatch) {
                const cleanAmount = qrMatch[1].replace(/,/g, '');
                return parseFloat(cleanAmount) || 0;
            }
            
            // Fallback: return 0 if no pattern matched
            return 0;
        }

        // NEW: Get date range - NO week calculation, just use the date itself
        // User controls the date range by uploading specific date ranges
        // ACMM: 2-8 Jan; BCA: 3-9 Jan (H+1 adjustment handled elsewhere)
        function getWeekRange(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            
            // Use the date itself as the "week key"
            // This allows flexible date ranges controlled by uploaded files
            const dateStr = formatDate(d);
            
            return {
                weekStart: d,
                weekEnd: d,
                weekLabel: dateStr,  // Just show the date
                weekKey: dateStr     // Use date as identifier
            };
        }

        // Round down to nearest 50,000 (DEPRECATED - keeping for backward compatibility but not used in weekly matching)
        function roundDownTo50k(amount) {
            return Math.floor(amount / 50000) * 50000;
        }

        // Parse BCA description for CDM
        function parseCDM(description) {
            const cdmMatch = description.match(/SETORAN VIA CDM.*?(\d{12,})/i);
            if (cdmMatch) {
                return extractLastDigits(cdmMatch[1], 12);
            }
            return null;
        }

        // Parse BCA description for Credit Card MID
        function parseCreditCardMID(description) {
            const midMatch = description.match(/KARTU KREDIT.*?MID:(\d+)/i);
            if (midMatch) {
                return extractLastDigits(midMatch[1], 7);
            }
            return null;
        }

        // Parse BCA description for QRIS MID
        function parseQRIS(description) {
            if (description.includes('QR :')) {
                const midMatch = description.match(/MID\s*:\s*(\d+)/i);
                if (midMatch) {
                    return extractLastDigits(midMatch[1], 7);
                }
            }
            return null;
        }

        // Parse BCA description for Debit Card MID
        function parseDebitCard(description) {
            // Pattern 1: KR OTOMATIS with MID: label
            const midMatch = description.match(/KR OTOMATIS.*?MID\s*:\s*(\d+)/i);
            if (midMatch && !description.includes('QR :')) {
                return extractLastDigits(midMatch[1], 7);
            }
            
            // Pattern 2: KR OTOMATIS with FLAZZ (no MID: label)
            // Example: "KR OTOMATIS 02/10/2025 04:00 FLAZZ 885004119892  ALPRO..."
            const flazzMatch = description.match(/FLAZZ\s+(\d+)/i);
            if (flazzMatch && !description.includes('QR :')) {
                return extractLastDigits(flazzMatch[1], 7);
            }
            
            return null;
        }

        // Parse BCA description for Setoran Tunai outlet
        function parseSetoranTunai(description) {
            // Pattern: Extract outlet code from description like "069-JKJSKR1 141 02025"
            // Look for pattern: any word containing letters and numbers (6+ chars)
            const outletMatch = description.match(/([A-Z]{2,}[A-Z0-9]{4,})/i);
            if (outletMatch) {
                return outletMatch[1];
            }
            return null;
        }

        // Determine transaction type from BCA description
        function determineTransactionType(description) {
            if (!description) return 'UNKNOWN';
            
            if (description.includes('SETORAN VIA CDM')) return 'CDM';
            if (description.includes('KARTU KREDIT')) return 'CREDITCARD';
            if (description.includes('QR :')) return 'QRIS';
            // KR OTOMATIS with TGH: is debit card transaction
            if (description.includes('KR OTOMATIS') && description.includes('TGH:')) return 'DEBITCARD';
            if (description.includes('KR OTOMATIS') && !description.includes('QR :')) return 'DEBITCARD';
            if (description.includes('SETORAN TUNAI')) return 'SETORAN_TUNAI';
            
            return 'OTHER';
        }

        // Build lookup maps from master files
        function buildMasterLookups() {
            const lookups = {
                kartuDebit: new Map(),
                mid: new Map(),
                cabang: new Map()
            };

            console.log('=== Building Master Lookups ===');

            // Master Kartu Debit Outlet (File 4)
            if (uploadedFiles[4]) {
                const data = uploadedFiles[4].data;
                console.log(`Processing Kartu Debit file: ${data.length - 1} rows`);
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    const kartuDebit = extractLastDigits(row[5], 12); // Column F (index 5)
                    const outletCode = row[6]; // Column G (index 6)
                    if (kartuDebit && outletCode) {
                        lookups.kartuDebit.set(kartuDebit, outletCode);
                    }
                }
                console.log(`Loaded ${lookups.kartuDebit.size} Kartu Debit mappings`);
            }

            // Master MID Outlet (File 3)
            if (uploadedFiles[3]) {
                const data = uploadedFiles[3].data;
                console.log(`Processing MID file: ${data.length - 1} rows`);
                console.log('Sample header row:', data[0]);
                
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    // Extract last 7 digits from Column D MID (index 3)
                    const midFull = row[3]?.toString() || '';
                    const mid = extractLastDigits(midFull, 7);
                    const outletCode = row[4]; // Column E - Outlet Code (index 4)
                    
                    if (mid && outletCode) {
                        lookups.mid.set(mid, outletCode);
                        // Debug first few entries
                        if (i <= 3) {
                            console.log(`MID mapping [${i}]: Full="${midFull}" -> Last7="${mid}" -> Outlet="${outletCode}"`);
                        }
                    }
                }
                console.log(`Loaded ${lookups.mid.size} MID mappings`);
                // Show some sample MIDs
                const sampleMIDs = Array.from(lookups.mid.keys()).slice(0, 10);
                console.log('Sample MIDs in lookup:', sampleMIDs);
            }

            // Master BCA Cabang (File 6)
            if (uploadedFiles[5]) {
                const data = uploadedFiles[5].data;
                console.log(`Processing Cabang file: ${data.length - 1} rows`);
                console.log('Sample header row:', data[0]);
                
                // Try to detect correct columns - look at first few rows
                for (let i = 1; i < Math.min(5, data.length); i++) {
                    console.log(`Cabang row ${i}:`, data[i].slice(0, 6));
                }
                
                // Parse all rows - try multiple column combinations
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    
                    // Try different column indices (user's file structure may vary)
                    // Option 1: Column A (index 0) = cabang code
                    let cabangCode = row[0]?.toString() || '';
                    let outletCode = row[1]?.toString() || '';
                    
                    // Option 2: If first option doesn't look right, try Column B (index 1) and Column C (index 2)
                    if (!cabangCode || cabangCode === '') {
                        cabangCode = row[1]?.toString() || '';
                        outletCode = row[2]?.toString() || '';
                    }
                    
                    // Option 3: Try Column C (index 2) and Column D (index 3) - original logic
                    if (!cabangCode || cabangCode === '') {
                        cabangCode = row[2]?.toString() || '';
                        outletCode = row[3]?.toString() || '';
                    }
                    
                    // Convert cabang code to string and handle numeric codes
                    cabangCode = cabangCode.toString().trim();
                    outletCode = outletCode?.toString().trim();
                    
                    if (cabangCode && outletCode) {
                        // Store with string key to handle numeric codes like "6355", "75", etc.
                        lookups.cabang.set(cabangCode, outletCode);
                        if (i <= 3) {
                            console.log(`Cabang mapping [${i}]: Cabang="${cabangCode}" -> Outlet="${outletCode}"`);
                        }
                    }
                }
                console.log(`Loaded ${lookups.cabang.size} Cabang mappings`);
                // Show some sample cabang codes
                const sampleCabang = Array.from(lookups.cabang.keys()).slice(0, 20);
                console.log('Sample Cabang codes in lookup:', sampleCabang);
            }

            console.log('=== Lookup Building Complete ===');
            return lookups;
        }

        // Pivot Transaction Summary by date, outlet, and payment method
        function pivotTransactionSummary(lookups) {
            if (!uploadedFiles[1]) return new Map();

            const pivotMap = new Map();
            const data = uploadedFiles[1].data;
            
            console.log('=== Pivoting Transaction Summary ===');
            console.log('Sample header:', data[0]);

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                const date = parseDate(row[0]); // Column A
                const storeName = row[2]; // Column C
                let paymentMethod = row[5]; // Column F
                const cardNum = row[6]; // Column G
                const debitCredit = row[11]?.toString().trim().toUpperCase(); // Column L (index 11) - "DEBIT" or "CREDIT"
                const coaAccount = row[12]?.toString().trim(); // Column M (index 12) - COA Account
                const amount = parseFloat(row[13]) || 0; // Column N (index 13)
                const commission = parseFloat(row[10]) || 0; // Column K (index 10)

                if (!date || !storeName) continue;

                const outletCode = parseOutletCode(storeName);
                if (!outletCode) continue;
                
                // PRE-FILTER: Only process specific COA accounts (Column M)
                // Only include:
                //   - "11201010 - PIUTANG KARTU KREDIT - BCA"
                //   - "11201100 - PIUTANG PENJUALAN CASH"
                const validAccounts = [
                    '11201010 - PIUTANG KARTU KREDIT - BCA',
                    '11201100 - PIUTANG PENJUALAN CASH'
                ];
                
                if (!validAccounts.includes(coaAccount)) {
                    continue; // Skip rows with other COA accounts
                }
                
                // Exclude "SALES" payment method
                if (paymentMethod === 'SALES') {
                    continue;
                }
                
                // Process DEBIT and CREDIT rows
                // DEBIT = payments received (add to total)
                // CREDIT = refunds/returns (subtract from total)
                
                // Create pivot key by OUTLET and PAYMENT METHOD only (no date)
                // This groups all dates together for total matching
                const key = `${outletCode}|${paymentMethod}`;
                
                if (!pivotMap.has(key)) {
                    pivotMap.set(key, {
                        outletCode: outletCode,
                        paymentMethod: paymentMethod,
                        amount: 0,
                        debitAmount: 0,   // Track debits separately
                        creditAmount: 0,  // Track credits separately
                        count: 0,
                        transactions: []
                    });
                }
                
                const pivot = pivotMap.get(key);
                
                // Add to appropriate counter based on DEBIT/CREDIT
                if (debitCredit === 'DEBIT') {
                    pivot.debitAmount += amount;
                } else if (debitCredit === 'CREDIT') {
                    pivot.creditAmount += amount;
                }
                
                // Net amount = DEBIT - CREDIT
                pivot.amount = pivot.debitAmount - pivot.creditAmount;
                pivot.count++;
                pivot.transactions.push({
                    cardNum: cardNum,
                    cardLast6: extractLastDigits(cardNum, 6),
                    amount: amount,
                    debitCredit: debitCredit
                });
            }
            
            console.log(`Created ${pivotMap.size} pivot entries (Debit payment types + Credit SALES)`);

            return pivotMap;
        }

        // Build Setoran Tunai timeline and calculate balances between Setoran dates
        // Each Setoran should match the accumulated CDM balances since the LAST Setoran
        function buildSetoranTunaiMatcher(lookups, pivotMap, bcaData) {
            console.log('=== Building Setoran Tunai Matcher ===');
            
            // Step 1: Extract all Setoran Tunai dates by outlet from BCA
            const setoranTimeline = new Map(); // outlet -> [{date, amount}] sorted by date
            
            for (let i = 1; i < bcaData.length; i++) {
                const row = bcaData[i];
                const tglTransaksi = parseDate(row[0]);
                const description = row[1]?.toString() || '';
                const cabang = row[2]?.toString() || '';
                const columnD = row[3]; // Column D - Jumlah
                
                if (!tglTransaksi || !description) continue;
                
                // Filter out transactions that don't need matching
                if (description.includes('BI-FAST') || 
                    description.includes('TRSF E-BANKING') || 
                    description.includes('BYR')) {
                    continue; // Skip this transaction
                }
                
                const transactionType = determineTransactionType(description);
                
                // For SETORAN_TUNAI: use Column D (Jumlah)
                let amount;
                if (transactionType === 'SETORAN_TUNAI') {
                    amount = parseBCAAmount(columnD);
                } else {
                    amount = parseBCAAmountFromDescription(description, transactionType);
                }
                if (transactionType === 'SETORAN_TUNAI') {
                    const cabangStr = cabang.toString().trim();
                    if (lookups.cabang.has(cabangStr)) {
                        const outletCode = lookups.cabang.get(cabangStr);
                        
                        if (!setoranTimeline.has(outletCode)) {
                            setoranTimeline.set(outletCode, []);
                        }
                        
                        setoranTimeline.get(outletCode).push({
                            date: tglTransaksi,
                            amount: amount,
                            dateStr: formatDate(tglTransaksi)
                        });
                    }
                }
            }
            
            // Sort Setoran dates for each outlet
            for (const [outlet, setorans] of setoranTimeline.entries()) {
                setorans.sort((a, b) => a.date - b.date);
                console.log(`Outlet ${outlet}: ${setorans.length} Setoran Tunai dates: ${setorans.map(s => s.dateStr).join(', ')}`);
            }
            
            // Step 2: Build CDM balance map by outlet and date
            const cdmBalances = new Map(); // outlet -> Map(dateStr -> balance)
            
            for (const [key, pivot] of pivotMap.entries()) {
                const parts = key.split('|');
                const dateStr = parts[0];
                const outletCode = parts[1];
                const paymentMethod = parts[2];
                
                if (paymentMethod === 'CASH') {
                    const grossAmount = pivot.amount;
                    const roundedAmount = roundDownTo50k(grossAmount);
                    const balance = grossAmount - roundedAmount;
                    
                    if (!cdmBalances.has(outletCode)) {
                        cdmBalances.set(outletCode, new Map());
                    }
                    
                    cdmBalances.get(outletCode).set(dateStr, {
                        gross: grossAmount,
                        rounded: roundedAmount,
                        balance: balance,
                        date: pivot.date
                    });
                }
            }
            
            // Step 3: Calculate accumulated balances between Setoran dates
            const setoranMatches = new Map(); // dateStr|outlet -> expected amount
            
            for (const [outlet, setorans] of setoranTimeline.entries()) {
                if (!cdmBalances.has(outlet)) continue;
                
                const outletCDM = cdmBalances.get(outlet);
                
                for (let i = 0; i < setorans.length; i++) {
                    const currentSetoran = setorans[i];
                    const prevSetoran = i > 0 ? setorans[i - 1] : null;
                    
                    // Calculate expected Setoran amount:
                    // 1. CDM balances from (prevSetoran+1) to (currentSetoran-2)
                    // 2. Plus full sales from (currentSetoran-1)
                    
                    let cdmBalanceSum = 0;
                    const contributingCDMDates = [];
                    const cdmBalanceDetails = [];
                    
                    // Calculate the day before current Setoran (for full sales)
                    const dayBeforeSetoran = new Date(currentSetoran.date);
                    dayBeforeSetoran.setDate(dayBeforeSetoran.getDate() - 1);
                    const dayBeforeStr = formatDate(dayBeforeSetoran);
                    
                    // Part 1: Accumulate CDM balances (recehan) from range
                    // Include CDM up to and including day before Setoran
                    // (Day N-1 CDM contains balance from Day N-2 sales)
                    for (const [cdmDateStr, cdmData] of outletCDM.entries()) {
                        const cdmDate = cdmData.date;
                        
                        // Include CDM balance if:
                        // - After previous Setoran (or from start if no previous)
                        // - Before current Setoran (up to day before Setoran, inclusive)
                        const afterPrev = !prevSetoran || cdmDate > prevSetoran.date;
                        const beforeOrOnDayBefore = cdmDate <= dayBeforeSetoran;
                        
                        if (afterPrev && beforeOrOnDayBefore) {
                            cdmBalanceSum += cdmData.balance;
                            contributingCDMDates.push(cdmDateStr);
                            cdmBalanceDetails.push({
                                date: cdmDateStr,
                                gross: cdmData.gross,
                                rounded: cdmData.rounded,
                                balance: cdmData.balance
                            });
                        }
                    }
                    
                    // Part 2: Get CASH sales ONLY from day before Setoran
                    // (Credit cards, debit, QRIS go directly to bank - only CASH needs Setoran)
                    let fullCashSales = 0;
                    const salesDetails = [];
                    
                    // Sum ONLY CASH payment for the outlet on dayBeforeSetoran
                    for (const [key, pivot] of pivotMap.entries()) {
                        const parts = key.split('|');
                        const dateStr = parts[0];
                        const keyOutlet = parts[1];
                        const paymentMethod = parts[2];
                        
                        if (keyOutlet === outlet && dateStr === dayBeforeStr && paymentMethod === 'CASH') {
                            fullCashSales += pivot.amount;
                            salesDetails.push({
                                paymentMethod: paymentMethod,
                                amount: pivot.amount
                            });
                        }
                    }
                    
                    // Total expected: CDM balances + CASH sales only
                    const expectedTotal = cdmBalanceSum + fullCashSales;
                    
                    const key = `${currentSetoran.dateStr}|${outlet}`;
                    setoranMatches.set(key, {
                        expectedBalance: expectedTotal,
                        cdmBalanceSum: cdmBalanceSum,
                        fullCashSales: fullCashSales,
                        dayBeforeSales: dayBeforeStr,
                        bcaAmount: currentSetoran.amount,
                        contributingCDMDates: contributingCDMDates.sort(),
                        cdmBalanceDetails: cdmBalanceDetails,
                        salesDetails: salesDetails,
                        dateRange: prevSetoran ? `CDM:${formatDate(prevSetoran.date)}-${contributingCDMDates.length > 0 ? contributingCDMDates[contributingCDMDates.length-1] : 'none'}` : `CDM:start-${contributingCDMDates.length > 0 ? contributingCDMDates[contributingCDMDates.length-1] : 'none'}`
                    });
                    
                    console.log(`Setoran ${outlet} ${currentSetoran.dateStr}: CDM Balance ${cdmBalanceSum.toFixed(2)} from ${contributingCDMDates.length} days + CASH Sales ${fullCashSales.toFixed(2)} from ${dayBeforeStr} = Total ${expectedTotal.toFixed(2)}`);
                }
            }
            
            console.log(`Built ${setoranMatches.size} Setoran Tunai matches`);
            return setoranMatches;
        }
        
        // ============================================================================
        // WEEKLY AGGREGATION AND MATCHING FUNCTIONS
        // ============================================================================
        
        // Global variables for weekly results
        let weeklySummaryResults = [];
        let weeklyDetailResults = [];
        
        function aggregateACMMByWeek(pivotMap) {
            const weeklyACMM = new Map();
            const weeklySummary = new Map();
            
            console.log('=== Aggregating ACMM Totals (All Dates) ===');
            console.log(' DEBUG: Pivot map has', pivotMap.size, 'entries');
            
            let sampleCount = 0;
            for (const [key, pivot] of pivotMap.entries()) {
                const [outletCode, paymentMethod] = key.split('|');
                
                // DEBUG: Log first 5 ACMM entries
                if (sampleCount < 5) {
                    console.log(` ACMM Entry ${sampleCount + 1}:`);
                    console.log(`   Outlet: ${outletCode} | Method: ${paymentMethod}`);
                    console.log(`   Total Amount: ${pivot.amount.toFixed(2)} (${pivot.count} transactions)`);
                    console.log(`   Debit: ${pivot.debitAmount.toFixed(2)} | Credit: ${pivot.creditAmount.toFixed(2)}`);
                    console.log('');
                    sampleCount++;
                }
                
                // Store by outlet and payment method
                const detailKey = `${outletCode}|${paymentMethod}`;
                weeklyACMM.set(detailKey, {
                    outletCode, 
                    paymentMethod, 
                    totalAmount: pivot.amount,
                    transactionCount: pivot.count,
                    weekKey: 'ALL',
                    weekLabel: 'All Dates',
                    weekStart: null,
                    weekEnd: null
                });
                
                // Summary by outlet only
                const summaryKey = outletCode;
                if (!weeklySummary.has(summaryKey)) {
                    weeklySummary.set(summaryKey, {
                        outletCode,
                        totalAmount: 0,
                        byType: {},
                        weekKey: 'ALL',
                        weekLabel: 'All Dates',
                        weekStart: null,
                        weekEnd: null
                    });
                }
                
                const summary = weeklySummary.get(summaryKey);
                summary.totalAmount += pivot.amount;
                if (!summary.byType[paymentMethod]) summary.byType[paymentMethod] = 0;
                summary.byType[paymentMethod] += pivot.amount;
            }
            
            console.log(`Aggregated ${weeklyACMM.size} ACMM totals by payment type`);
            console.log(`Aggregated ${weeklySummary.size} ACMM totals by outlet`);
            
            // DEBUG: Show sample ACMM weeks
            console.log(' ACMM Summary Keys (first 5):');
            let count = 0;
            for (const [key, data] of weeklySummary.entries()) {
                if (count++ >= 5) break;
                console.log(`  ${key} => Week: ${data.weekLabel}, Amount: ${data.totalAmount.toFixed(2)}`);
            }
            console.log('');
            
            return { weeklyACMM, weeklySummary };
        }
        
        function aggregateBCAByWeek(bcaData, lookups, referenceYear = null) {
            const weeklyBCA = new Map();
            const weeklySummary = new Map();
            
            console.log('=== Aggregating BCA Totals (All Dates) ===');
            console.log(' DEBUG: BCA has', bcaData.length - 1, 'rows (excluding header)');
            console.log(' DEBUG: Using reference year:', referenceYear || 'auto-detect');
            
            for (let i = 1; i < bcaData.length; i++) {
                const row = bcaData[i];
                const tglTransaksi = parseDate(row[0], referenceYear);
                const description = row[1]?.toString() || '';
                const cabang = row[2]?.toString() || '';
                const columnD = row[3]; // Column D - Jumlah (Amount)
                
                if (!tglTransaksi || !description) continue;
                if (description.includes('BI-FAST') || description.includes('TRSF E-BANKING') || description.includes('BYR')) continue;
                
                const transactionType = determineTransactionType(description);
                
                // Amount parsing based on transaction type:
                // - CDM and SETORAN_TUNAI: Use Column D (Jumlah)
                // - QRIS, CREDITCARD, DEBITCARD: Parse from description (Column B)
                let amount;
                if (transactionType === 'CDM' || transactionType === 'SETORAN_TUNAI') {
                    amount = parseBCAAmount(columnD);
                } else {
                    amount = parseBCAAmountFromDescription(description, transactionType);
                }
                let outletCode = null;
                
                if (transactionType === 'CDM') {
                    const kartuDebit = parseCDM(description);
                    if (kartuDebit && lookups.kartuDebit.has(kartuDebit)) outletCode = lookups.kartuDebit.get(kartuDebit);
                } else if (transactionType === 'SETORAN_TUNAI') {
                    const cabangStr = cabang.toString().trim();
                    if (lookups.cabang.has(cabangStr)) outletCode = lookups.cabang.get(cabangStr);
                } else if (transactionType === 'CREDITCARD') {
                    const mid = parseCreditCardMID(description);
                    if (mid && lookups.mid.has(mid)) outletCode = lookups.mid.get(mid);
                } else if (transactionType === 'DEBITCARD') {
                    const mid = parseDebitCard(description);
                    if (mid && lookups.mid.has(mid)) outletCode = lookups.mid.get(mid);
                } else if (transactionType === 'QRIS') {
                    const mid = parseQRIS(description);
                    if (mid && lookups.mid.has(mid)) outletCode = lookups.mid.get(mid);
                }
                
                if (!outletCode) {
                    if (i <= 20 && (transactionType === 'CDM' || transactionType === 'SETORAN_TUNAI' || transactionType === 'DEBITCARD')) {
                        console.log(` SKIPPED Row ${i}: Type=${transactionType}, Amount=${amount.toFixed(2)}, No outlet found`);
                        console.log(`   Desc: ${description.substring(0, 100)}`);
                    }
                    continue;
                }
                
                // DEBUG: Log first 10 rows
                if (i <= 10) {
                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    const acmmDate = subtractOneDay(tglTransaksi);
                    console.log(` BCA Row ${i}:`);
                    console.log(`   BCA Date: ${formatDate(tglTransaksi)} (${days[tglTransaksi.getDay()]})`);
                    console.log(`   ACMM Date (H+1): ${formatDate(acmmDate)} (${days[acmmDate.getDay()]})`);
                    console.log(`   Outlet: ${outletCode} | Type: ${transactionType} | Amount: ${amount.toFixed(2)}`);
                    console.log('');
                }
                
                // Group by outlet and transaction type only (no date)
                const detailKey = `${outletCode}|${transactionType}`;
                if (!weeklyBCA.has(detailKey)) {
                    weeklyBCA.set(detailKey, {
                        outletCode,
                        transactionType,
                        totalAmount: 0,
                        transactionCount: 0,
                        weekKey: 'ALL',
                        weekLabel: 'All Dates',
                        weekStart: null,
                        weekEnd: null
                    });
                }
                
                const bcaDetail = weeklyBCA.get(detailKey);
                bcaDetail.totalAmount += amount;
                bcaDetail.transactionCount++;
                
                // Summary by outlet only
                const summaryKey = outletCode;
                if (!weeklySummary.has(summaryKey)) {
                    weeklySummary.set(summaryKey, {
                        outletCode,
                        totalAmount: 0,
                        byType: {},
                        weekKey: 'ALL',
                        weekLabel: 'All Dates',
                        weekStart: null,
                        weekEnd: null
                    });
                }
                
                const summary = weeklySummary.get(summaryKey);
                summary.totalAmount += amount;
                if (!summary.byType[transactionType]) summary.byType[transactionType] = 0;
                summary.byType[transactionType] += amount;
            }
            
            console.log(`Aggregated ${weeklyBCA.size} BCA totals by payment type`);
            console.log(`Aggregated ${weeklySummary.size} BCA totals by outlet`);
            
            console.log(`Aggregated ${weeklyBCA.size} BCA weekly details`);
            console.log(`Aggregated ${weeklySummary.size} BCA weekly summaries`);
            
            // DEBUG: Show sample BCA weeks
            console.log(' BCA Summary Keys (first 5):');
            let count = 0;
            for (const [key, data] of weeklySummary.entries()) {
                if (count++ >= 5) break;
                console.log(`  ${key} => Week: ${data.weekLabel}, Amount: ${data.totalAmount.toFixed(2)}`);
            }
            console.log('');
            
            return { weeklyBCA, weeklySummary };
        }
        
        function matchWeeklyData(acmmData, bcaData, pivotMap, lookups) {
            const summaryResults = [];
            const detailResults = [];
            
            console.log('=== Performing Total Matching (All Dates) ===');
            
            // Summary matching by outlet
            const allOutlets = new Set([...Array.from(acmmData.weeklySummary.keys()), ...Array.from(bcaData.weeklySummary.keys())]);
            
            for (const outletCode of allOutlets) {
                const acmmSummary = acmmData.weeklySummary.get(outletCode);
                const bcaSummary = bcaData.weeklySummary.get(outletCode);
                
                const acmmTotal = acmmSummary ? acmmSummary.totalAmount : 0;
                const bcaTotal = bcaSummary ? bcaSummary.totalAmount : 0;
                const difference = bcaTotal - acmmTotal;
                
                let status = 'UNMATCHED';
                if (acmmTotal > 0 && bcaTotal > 0) {
                    status = Math.abs(difference) <= 500 ? 'MATCHED' : 'AMOUNT_MISMATCH';
                } else if (acmmTotal === 0) {
                    status = 'NO_ACMM_DATA';
                } else if (bcaTotal === 0) {
                    status = 'NO_BCA_DATA';
                }
                
                summaryResults.push({
                    weekKey: 'ALL',
                    weekLabel: 'All Dates',
                    weekStart: '',
                    weekEnd: '',
                    outletCode,
                    bcaTotal,
                    acmmTotal,
                    difference,
                    status,
                    acmmBreakdown: acmmSummary ? JSON.stringify(acmmSummary.byType) : '{}',
                    bcaBreakdown: bcaSummary ? JSON.stringify(bcaSummary.byType) : '{}'
                });
            }
            
            // Detail matching by outlet and payment type
            const typeMapping = {
                'CREDITCARD': ['VISA', 'MASTER', 'BCA CARD', 'JCB CARD', 'AMEX CARD', 'OTHER CARD'],
                'DEBITCARD': ['DEBIT BANK SAMA', 'DEBIT BANK LAIN'],
                'QRIS': ['QRIS'],
                'CDM': ['CASH'],
                'SETORAN_TUNAI': ['CASH']
            };
            
            const allDetailKeys = new Set();
            for (const key of bcaData.weeklyBCA.keys()) allDetailKeys.add(key);
            for (const [key, data] of acmmData.weeklyACMM.entries()) {
                const [outletCode, paymentMethod] = key.split('|');
                let transactionType = 'UNKNOWN';
                for (const [type, methods] of Object.entries(typeMapping)) {
                    if (methods.includes(paymentMethod)) {
                        transactionType = type;
                        break;
                    }
                }
                allDetailKeys.add(`${outletCode}|${transactionType}`);
            }
            
            for (const key of allDetailKeys) {
                const [outletCode, transactionType] = key.split('|');
                const bcaDetail = bcaData.weeklyBCA.get(key);
                
                let acmmTotal = 0;
                const acmmMethods = [];
                
                if (typeMapping[transactionType]) {
                    for (const paymentMethod of typeMapping[transactionType]) {
                        const acmmKey = `${outletCode}|${paymentMethod}`;
                        if (acmmData.weeklyACMM.has(acmmKey)) {
                            const acmmDetail = acmmData.weeklyACMM.get(acmmKey);
                            acmmTotal += acmmDetail.totalAmount;
                            acmmMethods.push(`${paymentMethod}: ${acmmDetail.totalAmount.toFixed(2)}`);
                        }
                    }
                }
                
                const bcaTotal = bcaDetail ? bcaDetail.totalAmount : 0;
                const difference = bcaTotal - acmmTotal;
                
                let status = 'UNMATCHED';
                if (acmmTotal > 0 && bcaTotal > 0) {
                    status = Math.abs(difference) <= 500 ? 'MATCHED' : 'AMOUNT_MISMATCH';
                } else if (acmmTotal === 0) {
                    status = 'NO_ACMM_DATA';
                } else if (bcaTotal === 0) {
                    status = 'NO_BCA_DATA';
                }
                
                detailResults.push({
                    weekKey: 'ALL',
                    weekLabel: 'All Dates',
                    weekStart: '',
                    weekEnd: '',
                    outletCode,
                    transactionType,
                    bcaTotal,
                    acmmTotal,
                    difference,
                    status,
                    acmmMethods: acmmMethods.join('; ')
                });
            }
            
            console.log(`Created ${summaryResults.length} summary, ${detailResults.length} detail results`);
            
            return { summaryResults: summaryResults, detailResults: detailResults };
        }
        
        function calculateWeeklySetoranMatch(weekKey, outletCode, bcaData, acmmData, pivotMap) {
            let cdmBalance = 0, cashSales = 0;
            
            const cdmKey = `${weekKey}|${outletCode}|CDM`;
            if (bcaData.weeklyBCA.has(cdmKey)) {
                const cdmData = bcaData.weeklyBCA.get(cdmKey);
                for (const txn of cdmData.transactions) {
                    const pivotKey = `${formatDate(txn.acmmDate)}|${outletCode}|CASH`;
                    if (pivotMap.has(pivotKey)) {
                        const pivot = pivotMap.get(pivotKey);
                        const grossAmount = pivot.amount;
                        const roundedAmount = roundDownTo50k(grossAmount);
                        cdmBalance += (grossAmount - roundedAmount);
                    }
                }
            }
            
            const acmmKey = `${weekKey}|${outletCode}|CASH`;
            if (acmmData.weeklyACMM.has(acmmKey)) {
                cashSales = acmmData.weeklyACMM.get(acmmKey).totalAmount;
            }
            
            return { cdmBalance, cashSales, expectedTotal: cdmBalance + cashSales };
        }
        
        // Main reconciliation function - WEEKLY VERSION
        async function startReconciliation() {
            if (!uploadedFiles[2]) {
                alert('Please upload BCA Statement file first!');
                return;
            }

            // Show processing status
            document.getElementById('process-btn').disabled = true;
            document.getElementById('processing-status').classList.remove('hidden');
            document.getElementById('processing-text').textContent = 'Building lookup maps...';

            // Simulate async processing
            await new Promise(resolve => setTimeout(resolve, 100));

            try {
                // Build master lookups
                const lookups = buildMasterLookups();
                
                document.getElementById('processing-text').textContent = 'Pivoting transaction summary...';
                await new Promise(resolve => setTimeout(resolve, 100));

                // Pivot transaction summary
                const pivotMap = pivotTransactionSummary(lookups);
                
                // Get BCA data
                const bcaData = uploadedFiles[2].data;

                document.getElementById('processing-text').textContent = 'Aggregating ACMM data by week...';
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const acmmWeekly = aggregateACMMByWeek(pivotMap);
                
                // Detect year from ACMM data for BCA parsing
                let referenceYear = null;
                for (const [key, data] of acmmWeekly.weeklySummary.entries()) {
                    if (data.weekStart) {
                        referenceYear = data.weekStart.getFullYear();
                        console.log(` Detected reference year from ACMM: ${referenceYear}`);
                        break;
                    }
                }
                
                document.getElementById('processing-text').textContent = 'Aggregating BCA data by week...';
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const bcaWeekly = aggregateBCAByWeek(bcaData, lookups, referenceYear);
                
                document.getElementById('processing-text').textContent = 'Performing weekly matching...';
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const matchResults = matchWeeklyData(acmmWeekly, bcaWeekly, pivotMap, lookups);
                
                weeklySummaryResults = matchResults.summaryResults;
                weeklyDetailResults = matchResults.detailResults;
                
                console.log(`Generated ${weeklySummaryResults.length} summary results`);
                console.log(`Generated ${weeklyDetailResults.length} detail results`);

                // Display results
                displayResults();
                document.getElementById('processing-status').classList.add('hidden');
                document.getElementById('results-section').classList.remove('hidden');

            } catch (error) {
                console.error('Error during reconciliation:', error);
                alert('An error occurred during reconciliation. Please check the console for details.');
                document.getElementById('processing-status').classList.add('hidden');
                document.getElementById('process-btn').disabled = false;
            }
        }

        // Display reconciliation results - WEEKLY VERSION
        function displayResults() {
            const totalRecords = weeklySummaryResults.length;
            const matched = weeklySummaryResults.filter(r => r.status === 'MATCHED').length;
            const unmatched = totalRecords - matched;
            const matchRate = totalRecords > 0 ? ((matched / totalRecords) * 100).toFixed(1) : 0;

            document.getElementById('total-records').textContent = totalRecords;
            document.getElementById('matched-count').textContent = matched;
            document.getElementById('unmatched-count').textContent = unmatched;
            document.getElementById('match-rate').textContent = `${matchRate}%`;

            updateResultsTable();
        }

        // Update results table based on current filter - WEEKLY VERSION
        function updateResultsTable() {
            const tbody = document.getElementById('results-tbody');
            tbody.innerHTML = '';

            // Always show summary results for now
            let filteredResults = weeklySummaryResults;

            if (currentTab === 'matched') {
                filteredResults = weeklySummaryResults.filter(r => r.status === 'MATCHED');
            } else if (currentTab === 'unmatched') {
                filteredResults = weeklySummaryResults.filter(r => r.status !== 'MATCHED');
            } else if (currentTab !== 'all') {
                // For transaction type filters, use detail results
                const typeMap = {
                    'cdm': 'CDM',
                    'creditcard': 'CREDITCARD',
                    'qris': 'QRIS',
                    'debit': 'DEBITCARD',
                    'setoran': 'SETORAN_TUNAI'
                };
                const filterType = typeMap[currentTab];
                filteredResults = weeklyDetailResults.filter(r => r.transactionType === filterType);
            }

            if (filteredResults.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-8 text-gray-500">
                            No results found for this filter.
                        </td>
                    </tr>
                `;
                return;
            }

            filteredResults.forEach((result, index) => {
                const statusClass = result.status === 'MATCHED' ? 'status-success' : 
                                   result.status === 'AMOUNT_MISMATCH' ? 'status-warning' : 'status-error';
                
                const difference = result.difference !== null ? result.difference.toFixed(2) : '-';
                const diffClass = result.difference !== null && Math.abs(result.difference) > 0.01 ? 'text-red-600 font-bold' : 'text-gray-600';

                const row = `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3">${index + 1}</td>
                        <td class="px-4 py-3">${result.weekLabel || result.weekKey}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-semibold">
                                ${result.transactionType || 'ALL TYPES'}
                            </span>
                        </td>
                        <td class="px-4 py-3 font-semibold">${result.outletCode}</td>
                        <td class="px-4 py-3 text-right font-mono">${result.bcaTotal.toFixed(2)}</td>
                        <td class="px-4 py-3 text-right font-mono">${result.acmmTotal.toFixed(2)}</td>
                        <td class="px-4 py-3 text-right font-mono ${diffClass}">${difference}</td>
                        <td class="px-4 py-3">
                            <span class="status-badge ${statusClass}">${result.status}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${result.acmmBreakdown || '-'}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Show specific result tab
        function showResultTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update table
            updateResultsTable();
        }

        // Export results to Excel - DUAL SHEET VERSION
        function exportResults(type = 'all') {
            if (weeklySummaryResults.length === 0 && weeklyDetailResults.length === 0) {
                alert('No data to export. Please run reconciliation first.');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const timestamp = new Date().toISOString().split('T')[0];
            
            // SHEET 1: WEEKLY SUMMARY
            const summaryData = [
                ['Week', 'Week Start', 'Week End', 'Outlet Code', 'BCA Total', 'ACMM Total', 'Difference', 'Status', 'ACMM Breakdown', 'BCA Breakdown']
            ];
            
            let summaryToExport = weeklySummaryResults;
            if (type === 'matched') {
                summaryToExport = weeklySummaryResults.filter(r => r.status === 'MATCHED');
            } else if (type === 'unmatched') {
                summaryToExport = weeklySummaryResults.filter(r => r.status !== 'MATCHED');
            }
            
            summaryToExport.forEach(row => {
                summaryData.push([
                    row.weekLabel,
                    row.weekStart,
                    row.weekEnd,
                    row.outletCode,
                    row.bcaTotal,
                    row.acmmTotal,
                    row.difference,
                    row.status,
                    row.acmmBreakdown,
                    row.bcaBreakdown
                ]);
            });
            
            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            wsSummary['!cols'] = [
                { wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 12 },
                { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 20 },
                { wch: 40 }, { wch: 40 }
            ];
            XLSX.utils.book_append_sheet(wb, wsSummary, 'Weekly Summary');
            
            // SHEET 2: WEEKLY DETAILS
            const detailData = [
                ['Week', 'Outlet Code', 'Transaction Type', 'BCA Total', 'ACMM Total', 'Difference', 'Status', 'ACMM Breakdown', 'BCA Transaction Count']
            ];
            
            let detailToExport = weeklyDetailResults;
            if (type === 'matched') {
                detailToExport = weeklyDetailResults.filter(r => r.status === 'MATCHED');
            } else if (type === 'unmatched') {
                detailToExport = weeklyDetailResults.filter(r => r.status !== 'MATCHED');
            } else if (type !== 'all') {
                const typeMap = {
                    'cdm': 'CDM',
                    'creditcard': 'CREDITCARD',
                    'qris': 'QRIS',
                    'debit': 'DEBITCARD',
                    'setoran': 'SETORAN_TUNAI'
                };
                const filterType = typeMap[type];
                if (filterType) {
                    detailToExport = weeklyDetailResults.filter(r => r.transactionType === filterType);
                }
            }
            
            detailToExport.forEach(row => {
                detailData.push([
                    row.weekLabel,
                    row.outletCode,
                    row.transactionType,
                    row.bcaTotal,
                    row.acmmTotal,
                    row.difference,
                    row.status,
                    row.acmmBreakdown,
                    row.bcaTransactionCount
                ]);
            });
            
            const wsDetail = XLSX.utils.aoa_to_sheet(detailData);
            wsDetail['!cols'] = [
                { wch: 15 }, { wch: 12 }, { wch: 18 }, { wch: 15 },
                { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 60 }, { wch: 20 }
            ];
            XLSX.utils.book_append_sheet(wb, wsDetail, 'Weekly Details');
            
            // Export
            const filename = `weekly_reconciliation_${type}_${timestamp}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            console.log(`Exported ${summaryToExport.length} summary, ${detailToExport.length} detail rows`);
        }

        // Reset all data
        function resetAll() {
            if (!confirm('Are you sure you want to reset all data? This will clear all uploaded files and results.')) {
                return;
            }

            uploadedFiles = {};
            weeklySummaryResults = [];
            weeklyDetailResults = [];
            currentTab = 'all';

            // Reset UI
            for (let i = 1; i <= 5; i++) {
                const zone = document.getElementById(`upload-zone-${i}`);
                const fileName = document.getElementById(`file-name-${i}`);
                const fileStatus = document.getElementById(`file-status-${i}`);
                const fileInput = document.getElementById(`file-${i}`);

                zone.classList.remove('has-file', 'error');
                fileName.textContent = 'Click to upload Excel file';
                fileStatus.innerHTML = '';
                fileInput.value = '';
            }

            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('upload-progress-text').textContent = '0/5 files uploaded';
            document.getElementById('process-btn').disabled = true;
            document.getElementById('results-section').classList.add('hidden');
        }
    </script>
</body>
</html>
